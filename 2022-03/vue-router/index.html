<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.d10f3b41d6d3a61135b8.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-4xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:monospace,Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem}body{transition:background-color .5s ease}body.light{--color-primary:#005b99;--color-text:#2e353f;--color-text-light:#4f5969;--color-heading:#1a202c;--color-heading-black:#000;--color-accent:#d1dce5;--inlineCode-text:#1a1a1a;--inlineCode-bg:rgba(255,229,100,0.2)}body.dark{--color-primary:#005b99;--color-text-light:hsla(0,0%,100%,0.88);--color-heading:#fff;--color-heading-black:#fff;--color-text:hsla(0,0%,100%,0.88);--color-accent:hsla(0,0%,100%,0.2);--inlineCode-text:#e6e6e6;--inlineCode-bg:rgba(115,124,153,0.2);background-color:#282c35}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{color:var(--color-heading);font-weight:var(--fontWeight-bold)}h1{color:var(--color-heading-black);font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text-light);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.header{display:flex;flex-direction:column;margin-bottom:var(--spacing-12)}.header .header__top{align-items:center;display:flex;flex-direction:row;justify-content:space-between;margin:0}.header .header__top .header__title{font-family:var(--font-heading);font-size:var(--fontSize-4);font-weight:var(--fontWeight-medium);text-decoration:none}.header .header__tags{align-items:center;display:flex;flex-flow:row nowrap;justify-content:flex-end;list-style-type:none;margin-bottom:var(--spacing-1)}.header .header__tags li{margin:0 0 0 var(--spacing-6)}.header .header__tags a{text-decoration:none}.footer__content{display:flex;flex-direction:row;justify-content:space-between}.header__line{border-top:2px solid #005b99;height:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio-avatar,.bio p{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media(max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}.header{margin-bottom:var(--spacing-11)}.header .header__top .header__title{font-family:var(--font-heading);font-size:var(--fontSize-3);font-weight:var(--fontWeight-medium);text-decoration:none}.header .header__tags{align-items:center;display:flex;flex-flow:row nowrap;font-size:.7rem;justify-content:flex-end;list-style-type:none;margin-bottom:var(--spacing-1)}.header .header__tags li{margin:0 0 0 var(--spacing-5)}.header .header__tags a{text-decoration:none}.footer__content{align-items:center;flex-direction:column;justify-content:center}}.react-toggle{-webkit-touch-callout:none;-webkit-tap-highlight-color:rgba(0,0,0,0);-webkit-tap-highlight-color:transparent;background-color:transparent;border:0;cursor:pointer;display:inline-block;padding:0;position:relative;touch-action:pan-x;-webkit-user-select:none;-ms-user-select:none;user-select:none}.react-toggle-screenreader-only{clip:rect(0 0 0 0);border:0;height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}.react-toggle-track{background-color:#0f1114;border-radius:30px;height:24px;padding:0;transition:all .2s ease;width:50px}.react-toggle-track-check{bottom:0;height:17px;left:5px;line-height:0;margin-bottom:auto;margin-top:auto;opacity:0;position:absolute;top:0;transition:opacity .25s ease;width:17px}.react-toggle--checked .react-toggle-track-check,.react-toggle-track-x{opacity:1;transition:opacity .25s ease}.react-toggle-track-x{bottom:0;height:17px;line-height:0;margin-bottom:auto;margin-top:auto;position:absolute;right:5px;top:0;width:17px}.react-toggle--checked .react-toggle-track-x{opacity:0}.react-toggle-thumb{background-color:#fafafa;border-radius:50%;box-sizing:border-box;height:22px;left:1px;position:absolute;top:1px;-webkit-transform:translateX(0);transform:translateX(0);transition:all .5s cubic-bezier(.23,1,.32,1) 0ms;width:22px}.react-toggle--checked .react-toggle-thumb{border-color:#19ab27;-webkit-transform:translateX(26px);transform:translateX(26px)}.react-toggle--focus .react-toggle-thumb{box-shadow:0 0 2px 3px #005b99}.react-toggle:active .react-toggle-thumb{box-shadow:0 0 5px 5px #005b99}code[class*=language-],pre[class*=language-]{-webkit-font-feature-settings:normal;font-feature-settings:normal;word-wrap:normal;background:#011627;color:#fff;font-family:Consolas,Menlo,Monaco,source-code-pro,Courier New,monospace;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none;line-height:1.5;margin-bottom:0;-moz-tab-size:4;-o-tab-size:4;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}pre[class*=language-]{overflow:auto;padding:1.3125rem}pre[class*=language-]::selection{background:#27292a}pre[class*=language-]::selection,pre[class*=language-] ::selection{background:rgba(255,255,255,.15);text-shadow:none}:not(pre)>code[class*=language-]{background:var(--inlineCode-bg);border-radius:.3em;color:var(--inlineCode-text);padding:.15em .2em .05em;white-space:normal}.token.attr-name{color:#addb67;font-style:italic}.token.comment{color:#809393}.token.string,.token.url{color:#addb67}.token.variable{color:#d6deeb}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.punctuation{color:#c792ea}.token.doctype,.token.selector{color:#c792ea;font-style:"italic"}.token.class-name{color:#ffcb8b}.token.keyword,.token.operator,.token.tag{color:#ffa7c4}.token.boolean{color:#ff5874}.token.property{color:#80cbc4}.token.namespace{color:#b2ccd6}pre[data-line]{padding:1em 0 1em 3em;position:relative}</style><meta name="generator" content="Gatsby 3.11.0"/><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){if(void 0===e.target.dataset.mainImage)return;if(void 0===e.target.dataset.gatsbyImageSsr)return;const t=e.target;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><link rel="preconnect" href="https://www.google-analytics.com"/><link rel="dns-prefetch" href="https://www.google-analytics.com"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=6bc259bb713487ed38ff7a6db58c9d26" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=6bc259bb713487ed38ff7a6db58c9d26"/><title data-react-helmet="true">vue-router源码浅析 | 好成的blog</title><meta data-react-helmet="true" name="description" content="总述 什么是路由？早期，路由其实是个后端概念，在服务端渲染（SSR）的 app 中，后端处理 HTML，并返回它，像这样： 我们可以通过不同的路径，请求不同的静态资源，这种方式就是路由。 在后来我们有了SPA…"/><meta data-react-helmet="true" property="og:title" content="vue-router源码浅析"/><meta data-react-helmet="true" property="og:description" content="总述 什么是路由？早期，路由其实是个后端概念，在服务端渲染（SSR）的 app 中，后端处理 HTML，并返回它，像这样： 我们可以通过不同的路径，请求不同的静态资源，这种方式就是路由。 在后来我们有了SPA…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content=""/><meta data-react-helmet="true" name="twitter:title" content="vue-router源码浅析"/><meta data-react-helmet="true" name="twitter:description" content="总述 什么是路由？早期，路由其实是个后端概念，在服务端渲染（SSR）的 app 中，后端处理 HTML，并返回它，像这样： 我们可以通过不同的路径，请求不同的静态资源，这种方式就是路由。 在后来我们有了SPA…"/><link as="script" rel="preload" href="/webpack-runtime-c645914f0629fa7d77c6.js"/><link as="script" rel="preload" href="/framework-507a82f8a4d219d3f184.js"/><link as="script" rel="preload" href="/app-238c6157f3f7e8e47f62.js"/><link as="script" rel="preload" href="/commons-d7f496c7033f1b2ecf65.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-a83ea2277426bf4b8caf.js"/><link as="fetch" rel="preload" href="/page-data/2022-03/vue-router/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2841359383.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3415673938.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body class="light"><script>
            (function() {
              window.__onThemeChange = function() {};
              function setTheme(newTheme) {
                window.__theme = newTheme;
                preferredTheme = newTheme;
                document.body.className = newTheme;
                window.__onThemeChange(newTheme);
              }
              var preferredTheme;
              try {
                preferredTheme = localStorage.getItem('theme');
              } catch (err) { }
              window.__setPreferredTheme = function(newTheme) {
                setTheme(newTheme);
                try {
                  localStorage.setItem('theme', newTheme);
                } catch (err) {}
              }
              var darkQuery = window.matchMedia('(prefers-color-scheme: dark)');
              darkQuery.addListener(function(e) {
                window.__setPreferredTheme(e.matches ? 'dark' : 'light')
              });
              setTheme(preferredTheme || (darkQuery.matches ? 'dark' : 'light'));
            })();
            </script><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper"><header class="header"><div class="header__top"><a class="header__title" href="/">Hao Chen&#x27;s  blog.</a><div class="header__toggle"><div class="react-toggle"><div class="react-toggle-track"><div class="react-toggle-track-check"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAABlJJREFUWAm1V3tsFEUcntnXvXu0tBWo1ZZHihBjCEWqkHiNaMLDRKOtQSKaiCFKQtS/SbxiFCHGCIkmkBSMwZhQNTFoQZD0DFiwtCDFAkdDqBBBKFj63rvdnfH7zfVo5aFBj0l2Z/dm5vd98/0es8dYjlpr62azufnDQNZcU1PciMfjWvb9rvZSMk4Ayfb36pLH13189GC8LAtIRLLPt+pzwrCuLq4ISEv/gHmitrAwfPbEkXc/ad4dL6iujrvyX0jcitgd/yZlZqftP6995Mr5TVLa22Tn8XVX2g/XLSRjUu7Q79jonS7I7hS7/0oOb5VyqF52n98oj7esXX07EjlxwXWisRmSnm3b29TTM8iYrjmFBWExubxwY/uhNas4r/WySl1fc5cetDMd7ydl+lMJJRw5WC8ud62Xx5rfepzwxgZmbhUYNS5Stvsj4yo2GXJEFBVHWDBkfdbR9HpYBaaUajDnBLKKpl1xRKYcgGtMCqEzTaSnThk/SQT0uJqTqFNBmXMCsZE48DzRZRMBRjv1GHNdk3HBImF9ZUvTyxM40pMKVc4JZBXQOLOFoDeKSxdp6HIQcO4rjYT9fn0pjbz9GLt7BAAODmjSVReXUMFzNW5x5vfxp2mIxZjIuQKJxAmFa+is2DQJJQ0JyBVExNOYcJnPxx/6/utnijmP555ALEagKAGGnGn64QORBjARcIA/yJk7JMJBLRrNtybTvH88KGjCf2jK86bhzmMcwDKFZEQvbIhxFYhChoMWMzU2iWznlIBEVJOsP+1bdX/ALx9l7jApADeDAEcMkE90JnUmmGl4USKQ0xhoW3JB5XY0YrxYWhLwMZZypUyjDGH35AbNwgUGiFBPpuGbHCpAOV1ZGXf2f/taftAv31DyeymN2d1IhAFAwTOmnzF/kKcdh3me7CYCOVNgycju84u8DeVlwfFq9/ZlTfldYrMUjOlrkjkD+rU+WzCROkcEchIDHR011syZW9JHD7y07N6JvhWMpz3pugaTkB6lWFVCKkhck0zzeMp2utq+uHrmfxOgoCO/Z8CXPlEQ1bdH8wgvhSIkEG0ICcQeExIFGdimjvKka7btJFZuaXOammIGKUCFQ53j9EN1dYKWqHf0t2w407W2tgs6h89ZnImjB55flh81tt9XirjjDuSl+oIPRQ0iWPgNZ5GqTqbBe3vSzEl5n5PhWKwocyR2HlqYN61qV18WjYjE8JLARZPQsUSim8foIRYTlGr02Ly7piASFRtKJ4VfieYhxdS2JcDVMN6xVOKZyrCGm8b108lrLRVzvptLH7IoEFLFANes6KnDi+uxfmvFnF17oALq5u1agu3/YfHkcSFzeSggV5eXRfIB7CHNcO5SUI+Ih5Ir7f4MAV9IqdFzdZgNpZw1Gcs1mNvgGbTbqQ9/cz7ZuuhgyYRQ49ljTyWHhr2DwpNHHFf+5gnWZ3Bharo+0TD5dNMw5vv9RlVpSRDHK4TlnoukhtYApuOHejSZQuo5g/A9BysdKRCyLl6062fN37OXMDlvUJtUrtmxo0avrW3wTrYs3jJ9RvRVChrmSmanPMpX2OXMsmDGh6AiEIwBAlvkOqIdBy+8JyAz8pz7QxiDth4KDy5uAlwzrWTnwC8Vc4KVAMZ3YUZ+IqoIjP3h5KFFX1ZMy3uW+7RhEDHgTi0zC9rS7uhPCDiNrGFyqBeERtKN/B0YlyFCkw0NJ5C0Ojv7zvT1a1WV1TuvZDdL4NTgB7CASYpsen6gqvG5jmTf5qHedADgkBl3D0nkSgNhZACDyi0FUKZRr3IdRjgN4WPPoFMIIegIK3mqd38fS80mcJKelM4szNyzZtQbkchGePuBRS8Eg9pHU8ojRQpSqs+ajAIwTjjUMQ/nvTNM0kicwYxZIYMh/891DYi+fvedB+c1xsm4lDU6ya+Axtz+RiAzEVYbajQOpq17F0R9QevNcEhfcU+xvyQQUalGJBSesqOkgPQ4YNyUZL9fSvUPDjoNAwN8/dwFjaczNkc3ptaMud1EIDtGcmXTcefO2cGSvKIFfp/2JIJxlq7xEl3nVPM4fDeIbPkD16/ptNc0bDu7qxbsu0R2JGywWMIjF2ft3tjfloAyQAGXiOn8hrqwbVvMXzaO+QeHXP6nF0wvX74Hf4NGG5GPjSlYoyM3P/0FbCT6zvM/yYoAAAAASUVORK5CYII=" width="16" height="16" role="presentation" style="pointer-events:none"/></div><div class="react-toggle-track-x"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KTMInWQAABwNJREFUWAmtV1tsFFUY/s6Z2d22zLYlZakUCRVaQcqlWIiCiS1gTEB9UAO+GR9En3iQGI0xJiSiRB98MjEq8cEQTSBeHhQM0V7whtEGDWC90BYitxahtNtu25058/v/ZzvLbilawJNM5+yZ89+//1LgJhYRNLW1uDfBAvpGiIk2O5auvfFxqIH3ZJ8/u06GN6Z9+wVl5SjcD1IbZa/UPkPyYl2uR4dreoD2bnbYxTlBBRytkHXtAREphP5KuH4lddx9h70yxX05t7yYXwGb6W8nx1jibpl2rFlGBxcG9M18okOrn7Bnk/BAO/4bI0UeEE1zjBp3UmvjOxJXJdaKN/ZiIu4tOZrAb4aTdZAZArKmWeiiJZ6jt5tiagdCS9+6cgO1Ne6Mvhe+ixTIfyDVhipnK9p+P0Edqx9RW/YZtQVGmOLChRxNNlyPsTEgPQKMB3dbEHa0h1awYmQ83enTd2vmUtvKd1Glv2RkzBb+kZGRrKtjzG60Wguhd/lJZBingbcfWWe72vjT75bJDrhYtvA0hrurETDr5HyF2Knb1MM4ab//xIoOqueA0edRnkkinTyJdYvqLFDZO4zUPFCvVoDjJq4T7TE61IWh4x5KqxX5KVKkX8WZ/t2ov2cb3MHt4dhIyOxIJxJOOF6xRx/99BksXLoecWcXytILMNBDqKpnGZWPquYfPxY8iXGR9fK+SgFrgcRPXPjVqhehL+3EmZ5RGJQi1QBU8TPThQnOQzm+5UXGIcetUeEAfP13VwzpI+w1jGJWdSliNfvVhiMPiOsllJag4M/UGHiqM6dlBb2OTLKHHV6KkvogrJ4XhBWniWK/Gp1MQyf93FOeUXKmKk/FzJxbQtKLjFXYT4USupy8fQVir2ynVEBiZMG0qtOHMS/AW4Gwrk7BG3C1F0B5nqNKE0CME4MfVRLPnXkBKe+ipvoFhNQywOhdghvLi0F8ReyVXV4BKTBRbbe5f64zR/DHsdZw1hJfeWlHl/GNRJzDxrd5m192z78TMaVnKELZoINZS4BzQ7vtnZljSnha/pPCbkuxzXcupYwI5tIeCpGc0Yp9tWHZQy/rmYhRfNgg4bHJBYLzGkxsRJF4XKlE2jBOHNSv3kY7Tj6vthzPFl61BrYwqFlmEQhtSVXmLiksxLmtRgYXI1ULU61JJ4eVKmG3/5sCVgpbMT6OMJ2E08/29Xf3w6v4FnHdCjfWgXu/O8Z5mLdCkeRs2khHe1DqOtQwbHWTAnM5S2HNmhALYo5KjkPFrMMKjZl6HxhWIAb0BqE+/73GrBRQUsKYiBu4JX8ycI6wtw+i5ef3NZpsrKVSHYCP37jwGDgeE1SA0S/xtl5SU2fs1ApEp0qTLVRjgyycDSsLHMSwmFltZMStR3uLLg6BdLhDa5dC6ryU2pHBe1BVO9tUcwfitJt2CLJZUHoG6T7Op75u0IyK31TCPcwFqgPk/KCaD3dFOuZBCO7xvCT/j048b3I3c7F2+WuOW7qdgkucFYlcQ4qop3yzTX7WaKfOCccye3Ts1Etq0+a/BHCF1yPgF3tAUkR6OrtGmo6gl94qqcXKh3rDyrOkPa58URoWcov2Mo6M+0QjrqKB+b7++oMa9Sz+ZkM0mie6aAtnGUvhmxaI+TogPOSQedgWioGSHFLn3v4kLh4HRspNmOGv41k+55siLFp2z6xYeJjhljFcbmxJlr4ga06TbevSByz/glQq4BJx46/c+237PbBqEYKxX3HpmKZEnQnr65X20hqJYaNcLoFOLiJk2LuBbyg7Q0OEn+hm0P3honxFD6rdxYorKpeIoi4YSSvyQHQIbM5t4+YNxLj/OxhVOOE4585qGpjnq+wSx6Q9CtNxTjd5klB+g6Mv36r0+b9cZFi44WYkHdG2ZWb3TtOUOXyVAlKlpGvJIAJ3eBMyfYS5C0qRZGtC85j+4sOasDe9xznPYezhhO/2Q6eP2fSOvYHOjtuQ1a9Q1VKynVDaMc8E0tptdxUsTFpFIYjcZKcbnoaQTNdiqCwNlL4G7oziSqGnT1ALf34vhk4R5zU3qYV9ONp9K88RtouShE68JwaU8dFw5W617shWa9ykeaBIn2hcsvPgL00k45QdTCZuSVcTRNs+8fnyLvooQfR5iujAnR9bxfY2xOVOxFS8SK3Le0l48VyYu1M8HRe5JD8wKPTjYnifaK3Wfn/GChYQ8ZAi6WRzWgqLV5YrsVLnZaVSoXU1g9gOIDwFySiGi+Zdrnzr7J3r+SMuszlcQCRn8lNGcTuSy2jOI7o9mxjZo+vR3ej3tN+ifRSOyUTS0+VMOid93cCubeiy/6TImS0QxRSCq2vxKr45zV+FQnjWH6D2xg+E9EatLcLAdHTgtGGD80D6jM0+aOl4wJgO/f96R2aJKCQ3yvgftRhdFMOpd6oAAAAASUVORK5CYII=" width="16" height="16" role="presentation" style="pointer-events:none"/></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between Dark and Light mode"/></div></div></div><ul class="header__tags"><li><a href="/coding365">Coding365</a></li><li><a href="/tags">分类</a></li><li><a href="/resource">珍藏资料</a></li><li><a href="https://github.com/monster898">Github</a></li><li><a href="/about">About</a></li><li><a href="./rss.xml">RSS</a></li></ul><div class="header__line"></div></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">vue-router源码浅析</h1><p>March 20, 2022 • 42 min read</p></header><section itemProp="articleBody"><h2>总述</h2>
<p>什么是路由？早期，路由其实是个<strong>后端概念</strong>，在服务端渲染（<strong>SSR</strong>）的 app 中，后端处理 HTML，并返回它，像这样：</p>
<div class="gatsby-highlight" data-language="http"><pre class="language-http"><code class="language-http"><span class="token header-name keyword">https:</span>//www.google.com/something.html</code></pre></div>
<p>我们可以通过不同的路径，请求不同的静态资源，这种方式就是路由。</p>
<p>在后来我们有了<strong>SPA</strong>，被称为单页应用，单页应用不仅仅是在页面交互是无刷新的，连<strong>页面跳转</strong>都是<strong>无刷新</strong>的，为了实现单页应用，所以就有了前端路由。</p>
<p>其实说白了就是我们让<code class="language-text">url</code>的地址发生变化，但是不会去真正的去发送请求到后端，而在前端监听<code class="language-text">url</code>变化来执行相应的<code class="language-text">js</code>代码来实现页面的“跳转”。</p>
<p><strong>SPA</strong>有好处也有坏处，它的好处正如我们所说的，页面的交互是无刷新的，对用户更友好(感觉页面的反应更快了)。</p>
<p>坏处也很明显，<code class="language-text">SEO</code>(Search Engine Optimization)很差，因为实际上我们只有一个页面嘛，而搜索引擎大多是使用爬虫去爬取<code class="language-text">HTML</code>的关键字来决定搜索排名。</p>
<h3>前置知识</h3>
<h4>hashRouter</h4>
<h5>hash 值的变化不会让浏览器发起请求</h5>
<p>假设我们有个 HTML：</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    hello world
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div>
<p>使用本地服务器托管，访问页面：</p>
<p>可以看到页面正常显示了。</p>
<p>这时我们往地址栏的 url 后加入一些内容：</p>
<p>回车，我们发现浏览器并没有刷新。即就是说 hash 值的变化，并不会导致浏览器向服务器发出请求，浏览器不发出请求，也就不会刷新页面。</p>
<p>基于浏览器的这个特性，我们可以用<strong>hash 模式</strong>实现一个路由，首先我们来了解一下有关 hash 路由的 API。</p>
<h5>hashChange 事件</h5>
<p>HTML5 增加了 hashchange 事件，用于在 URL 散列值（ URL 最后#后面的部分）发生变化时通知开发者。这是因为开发者经常在 Ajax 应用程序中使用 URL 散列值存储状态信息或路由导航信息。</p>
<p>尝试在浏览器控制台运行以下代码：</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"hashchange"</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Old URL: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>oldURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, New URL: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>newURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>然后修改当前 url 的散列值，你会发现回调函数被触发了。</p>
<h5>预期的流程</h5>
<p>知道了上面的 API，我们可以构建出如下的流程：</p>
<ul>
<li>
<p>旧地址为<code class="language-text">http://localhost:63342/frontendRouter/#/page1</code></p>
</li>
<li>
<p>修改 hash 值，准备跳转到新地址<code class="language-text">http://localhost:63342/frontendRouter/#/page2</code>，但是要注意跳转的类型：</p>
<ul>
<li><strong>刷新页面</strong>，是不会触发<code class="language-text">hashchange</code>的，我们可以使用<code class="language-text">load</code>事件。</li>
<li>输入链接回车跳转，会触发<code class="language-text">hashchange</code>。</li>
<li>浏览器的后退,前进按钮，会触发<code class="language-text">hashchange</code></li>
</ul>
</li>
<li>
<p>根据我们的 hash 来匹配相应的页面。（这里的”页面“我们可以简单地看成一个 HTML 片段），如果匹配不到，我们执行重定向。</p>
</li>
<li>
<p>替换相应的 DOM。</p>
</li>
</ul>
<h5>DEMO</h5>
<p>下面是一个简单的<strong>hashRouterDEMO</strong>:</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">const</span> myHashTable <span class="token operator">=</span> <span class="token punctuation">{</span>
        page1<span class="token operator">:</span> <span class="token string">"&lt;div>我是第一页&lt;/div>"</span><span class="token punctuation">,</span>
        page2<span class="token operator">:</span> <span class="token string">"&lt;div>我是第二页&lt;/div>"</span><span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token string">"hello world"</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newHash <span class="token operator">=</span> location<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"#/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> myHashTable<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>newHash<span class="token punctuation">)</span>
          <span class="token operator">?</span> myHashTable<span class="token punctuation">[</span>newHash<span class="token punctuation">]</span>
          <span class="token operator">:</span> myHashTable<span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"hashchange"</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url Hash值被改变！Old URL: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>oldURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, New URL: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>newURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token keyword">const</span> newHash <span class="token operator">=</span> event<span class="token punctuation">.</span>newURL<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"/#/"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> myHashTable<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>newHash<span class="token punctuation">)</span>
          <span class="token operator">?</span> myHashTable<span class="token punctuation">[</span>newHash<span class="token punctuation">]</span>
          <span class="token operator">:</span> myHashTable<span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    hello world
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre></div>
<h4>HTML5 History API</h4>
<p><strong>history</strong> 对象表示当前窗口首次使用以来用户的导航历史记录。因为 history 是 window 的属性，所以每个 window 都有自己的 history 对象。出于安全考虑，这个对象不会暴露用户访问过的 URL，但可以通过它在不知道实际 URL 的情况下前进和后退。</p>
<h5>go()</h5>
<p><code class="language-text">go()</code>方法可以在用户历史记录中沿任何方向导航，可以前进也可以后退。这个方法只接收一个参数，
这个参数可以是一个整数，表示前进或后退多少步。负值表示在历史记录中后退（类似点击浏览器的“后
退”按钮），而正值表示在历史记录中前进（类似点击浏览器的“前进”按钮）。<code class="language-text">go(0)</code>或者没有参数将刷新当前页面。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 后退一页</span>
history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 前进一页</span>
history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 前进两页</span>
history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></code></pre></div>
<h5>back() / forward()</h5>
<p>它们是<code class="language-text">go()</code>的语法糖。</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token comment">// 后退一页</span>
history<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 前进一页</span>
history<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></div>
<h5>pushState()</h5>
<p><code class="language-text">pushState()</code>方法执行后，状态信息就会被推到历史记录中，浏览器地址栏也会改变以反映新的相对 URL（可以想象成一个“假的”URL）。</p>
<p>因为 <code class="language-text">pushState()</code>会创建新的历史记录，所以也会相应地启用“后退”按钮。此时单击“后退”按钮，就会触发 window 对象上的 popstate 事件。</p>
<h5>刷新白屏问题</h5>
<p>如果你使用一些前端框架和它的路由管理插件，那么有时会出现刷新白屏现象。</p>
<p>这一现象的本质在于：我们使用<code class="language-text">pushState()</code>创建的每一个<strong>假的 URL(可以看成一个“状态”)<strong>并没有在服务器上对应一个</strong>真实物理 URL</strong>。所谓的白屏其实就是 404 错误。</p>
<p>如果服务端使用了<strong>nginx</strong>，那么我们可以这样配置来处理这个问题（方案就是将当前的 url 重定向到 index.html 下）：</p>
<div class="gatsby-highlight" data-language="nginx"><pre class="language-nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">80</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  xxxx.yuzzl.top</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">root</span>  xxxxxx</span><span class="token punctuation">;</span>

    // 下面是重点！
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
        <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/  /index.html</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>从基本的路由开始</h3>
<p>了解了前置知识,那么各种路由库无非是利用这两种模式来作进一步的封装，使其适应自身的框架罢了，来看下图（来自官方文档）：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9f28aba7f6e01df3fbbbd7616b05c969/7a4b2/Snipaste_2022-03-19_21-34-04.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 99.36708860759494%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAABJNAAASTQHzl8SnAAAC00lEQVQ4y4WT+U4TURTGeQZjAtEU6AadlS7TTlsBCYliNMaIxEhc/vAFiNSWTgdoAX0CiTG+gXFJfBkDLQUqdJm902WWzlIzLcVaQb98c+69Z+aXO2fOnSGzbYnj2PxxgaLZEkWdliosx9Msd1Is67revlxDZoeucPVcgSnTfIniT8pMqcJ1JmxDUiVZk+SWFRVNkjVZ0frgzlAS9GyxQbFikRZLtFhiakVKZIQmIzRoy3Wat0xxdb4m/4a7g6JIstRUWy1FVWRrISuqKslyd2JlJLkpSZIstzRtEG40papYbzSauqYblkzr6sjoyewmDeMCmK+Kgigafff+qzOYYdiD/NHRceEgf5jN5XP5w/3swY+97N5+7rjws1gsdX16WqQZtm324O5W6czbSQCLzt6OzNwKRudvzC1M31zAo/MYPheIzvnDs97AtD8064GDy89eap2yTdM8g9eITacLCoSmMW8A92MwGnSDfjfg6/ckFLDZgQeLy4NwamMLQRA8MoMFwlgg7AtEYF8E9ob7jfqjLo9v6cmLQTgWJ68Mj9snUJsDsjmgUQc05hy03Y0MX3fevb/UD1vlf/n6/VWMSG1sE2Tm3MmeCXIrSWZS69uxBLn7/mN3PwvufjdN11u61eNO1M+ipuu6oWqaqmmtXlL/u89irUYxrPU/MCzFsAzL80KV4wVeqPJCleV5jhc4XqjV6oqqDsKCWCtTTIViRLH+74NhmuYgbJqmbhha58WsZbtt9D106QnrVv/p87eVlcR6eodM76yl0puZN8T61hqRTpDpOLkZS5Cr8VQ8ubEaJ97tfjB0489WvU6NXHOBaBACUAhEnZNT4y54zAGNOqFRJ2izAzY7MOaEro7Y79xbHOwzQWYQBMbDMyF/EMdw2It74CCAWAaRIIiGQDQEe8OOCfTR4+eDcDKVttkBaAp3Q9gEhHngCwyioXEX/HDp6Tn8C3rYcRdtmoOqAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 19 21 34 04"
        title="Snipaste 2022 03 19 21 34 04"
        src="/static/9f28aba7f6e01df3fbbbd7616b05c969/f058b/Snipaste_2022-03-19_21-34-04.png"
        srcset="/static/9f28aba7f6e01df3fbbbd7616b05c969/c26ae/Snipaste_2022-03-19_21-34-04.png 158w,
/static/9f28aba7f6e01df3fbbbd7616b05c969/6bdcf/Snipaste_2022-03-19_21-34-04.png 315w,
/static/9f28aba7f6e01df3fbbbd7616b05c969/f058b/Snipaste_2022-03-19_21-34-04.png 630w,
/static/9f28aba7f6e01df3fbbbd7616b05c969/40601/Snipaste_2022-03-19_21-34-04.png 945w,
/static/9f28aba7f6e01df3fbbbd7616b05c969/7a4b2/Snipaste_2022-03-19_21-34-04.png 1240w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>可以发现，两种模式对应我们前面说到两种路由方案 — <strong>Hash</strong>和<strong>HTML5</strong>，分别对应<code class="language-text">createWebHistory</code>(<code class="language-text">src/history/hash.ts</code>下)和<code class="language-text">createWebHistory</code>(<code class="language-text">src/history/html5.ts</code>下)。</p>
<p>接下来，我们就从这两个模式的具体实现讲起。</p>
<h2>createWebHistory</h2>
<h3>整体描述</h3>
<p><code class="language-text">createWebHistory</code>最终返回一个<code class="language-text">routerHistory</code>，它的主要流程如下：</p>
<ul>
<li>利用<code class="language-text">useHistoryStateNavigation</code>初始化一个导航对象<code class="language-text">historyNavigation</code>。</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> historyNavigation <span class="token operator">=</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span></code></pre></div>
<ul>
<li>利用<code class="language-text">useHistoryListeners</code>初始化一个路由监听器<code class="language-text">historyListeners</code>。</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
  base<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">.</span>replace
<span class="token punctuation">)</span></code></pre></div>
<ul>
<li>封装我们熟悉的<code class="language-text">history.go()</code>：</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> triggerListeners <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triggerListeners<span class="token punctuation">)</span> historyListeners<span class="token punctuation">.</span><span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>初始化我们要返回的对象(将几个对象合并)：</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> routerHistory<span class="token operator">:</span> RouterHistory <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// it's overridden right after</span>
    location<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    base<span class="token punctuation">,</span>
    go<span class="token punctuation">,</span>
    createHref<span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  historyNavigation<span class="token punctuation">,</span>
  historyListeners
<span class="token punctuation">)</span></code></pre></div>
<ul>
<li>利用<code class="language-text">Object.defineProperty</code>, 为<code class="language-text">routerHistory</code>绑定属性<code class="language-text">location</code>和<code class="language-text">state</code>。
这个操作无非是为调用者提供方便，我们访问<code class="language-text">location</code>属性等价于<code class="language-text">historyNavigation.location.value</code>,<code class="language-text">state</code>属性等价于<code class="language-text">historyNavigation.location.value</code>。</li>
</ul>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">"location"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">"state"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>我们对源码稍作处理, 将<code class="language-text">routerHistory</code>挂载到<code class="language-text">window</code>上，方便操作：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// @ts-ignore</span>
window<span class="token punctuation">.</span><span class="token constant">MY_HISTORY</span> <span class="token operator">=</span> routerHistory
<span class="token keyword">return</span> routerHistory</code></pre></div>
<p>起一个空白的 H5 页面，只执行上面的方法，可以看出，这些路由操作全部如期望的一样执行，上升到框架层面，无非也是对这个<code class="language-text">routerHistory</code>进行各种操作，所以封装一套<strong>通用的路由操作 API</strong>至关重要。
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/56a5011f8790b94bba23939e99dd4630/86389/20201107213838.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 64.55696202531645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA9ElEQVQoz53RS26EMBBFUfa/x0gZ0SFgG2PqX2UiyLwDOfPrZ6kGRJymaVmWnHMpZa2VtyqlmHv8ZRCRZZ5TSq01uCBA7Lsj9t6PtwYiGl+v73le17W1tm1bay1UwzQi+lvncluWVgogEhEzE/Nxzxmnr9eaUi1rvhhzt5OImFlEqKqZqYZ7qIqZR/Tj6IO7z7khkF6bzBxEDiAigCgiqorXp4CcWBCB+Xyh9xj60Y0cEgqxA4TIcdtvbOtnbfMOdesRz2IFzR8lj7VsD2avuHcTk6aMnHPa9/1BzEzjOE7TVEpJKdW6mfrtU6nL5XhuuC72Tz8Yfvy5tL2/sgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="20201107213838"
        title="20201107213838"
        src="/static/56a5011f8790b94bba23939e99dd4630/86389/20201107213838.png"
        srcset="/static/56a5011f8790b94bba23939e99dd4630/c26ae/20201107213838.png 158w,
/static/56a5011f8790b94bba23939e99dd4630/6bdcf/20201107213838.png 315w,
/static/56a5011f8790b94bba23939e99dd4630/86389/20201107213838.png 574w"
        sizes="(max-width: 574px) 100vw, 574px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>接下来，我们来看看<code class="language-text">routerHistory</code>的一些详细的实现。</p>
<h3>useHistoryStateNavigation — 路由导航操作集</h3>
<p>上面说到<code class="language-text">createWebHistory</code>利用<code class="language-text">useHistoryStateNavigation</code>初始化一个导航对象<code class="language-text">historyNavigation</code>，我们走进<code class="language-text">useHistoryStateNavigation</code>一探究竟。</p>
<p>首先是一个对象解构，获得 window 下的<code class="language-text">history</code>和<code class="language-text">location</code>，他们是路由操作的核心部分。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> history<span class="token punctuation">,</span> location <span class="token punctuation">}</span> <span class="token operator">=</span> window</code></pre></div>
<p>接下来利用<code class="language-text">createCurrentLocation</code>获取当前位置：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">let</span> currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">createCurrentLocation</code>内容如下：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token comment">/**
 * Creates a normalized history location from a window.location object
 * 从 window.location 获取标准化的位置
 * @param base
 * @param location -
 */</span>
<span class="token keyword">function</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>
  base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  location<span class="token operator">:</span> Location
<span class="token punctuation">)</span><span class="token operator">:</span> HistoryLocation <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span> <span class="token operator">=</span> location
  <span class="token comment">// allows hash based url</span>
  <span class="token keyword">const</span> hashPos <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hashPos <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// prepend the starting slash to hash so the url starts with /#</span>
    <span class="token keyword">let</span> pathFromHash <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathFromHash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"/"</span><span class="token punctuation">)</span> pathFromHash <span class="token operator">=</span> <span class="token string">"/"</span> <span class="token operator">+</span> pathFromHash
    <span class="token keyword">return</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathFromHash<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> base<span class="token punctuation">)</span>
  <span class="token keyword">return</span> path <span class="token operator">+</span> search <span class="token operator">+</span> hash
<span class="token punctuation">}</span></code></pre></div>
<p>这个函数的功能很简单，传入一个<code class="language-text">base</code>(基础路径，这个功能主要是给<code class="language-text">HashRouter</code>作准备的)和全局<code class="language-text">location</code>，进行一系列字符串操作，返回一个由<strong>路径</strong> + <strong>search</strong>(就是 URL 中的查询参数，即?a=1 之类的) + <strong>hash</strong>(url 中#后面的值)拼接而成的字符串。
最终这个字符串会被暴露给用户，其实就是上面提到的<code class="language-text">historyNavigation.location</code>。</p>
<p>我们继续讨论主函数，在获取当前状态之后，又对<code class="language-text">history.state</code>进行了一些处理：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">let</span> historyState<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>StateEntry<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> history<span class="token punctuation">.</span>state <span class="token punctuation">}</span>
<span class="token comment">// build current history entry as this is a fresh navigation</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historyState<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>
    currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      back<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      current<span class="token operator">:</span> currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      forward<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token comment">// the length is off by one, we need to decrease it</span>
      position<span class="token operator">:</span> history<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
      replaced<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token comment">// don't add a scroll as the user may have an anchor and we want</span>
      <span class="token comment">// scrollBehavior to be triggered without a saved position</span>
      scroll<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token boolean">true</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>来看看下面的<code class="language-text">changeLocation()</code>, 这个函数很重要:</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span>
  state<span class="token operator">:</span> StateEntry<span class="token punctuation">,</span>
  replace<span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// when the base has a `#`, only use that for the URL</span>
  <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span>
    hashIndex <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token operator">?</span> base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span> <span class="token operator">+</span> to
      <span class="token operator">:</span> <span class="token function">createBaseLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> base <span class="token operator">+</span> to
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这里对Safari浏览器的个性异常做了捕获</span>
    <span class="token comment">// BROWSER QUIRK</span>
    <span class="token comment">// NOTE: Safari throws a SecurityError when calling this function 100 times in 30 seconds</span>
    history<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">"replaceState"</span> <span class="token operator">:</span> <span class="token string">"pushState"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span>
    historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Error with push/replace State"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Force the navigation, this also resets the call count</span>
    location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">"replace"</span> <span class="token operator">:</span> <span class="token string">"assign"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>可以看出<code class="language-text">changeLocation</code>就是对<code class="language-text">history.replaceState</code>/<code class="language-text">history.pushState</code>的封装。它根据传入的<code class="language-text">to</code>（目标），通过字符串拼接来获取目标路径，然后执行相应的 historyAPI。同时修改了外部的<code class="language-text">historyState</code>，我们可以通过查看<code class="language-text">StateEntry</code>接口获取来看看它提供的更加详细的路由状态信息：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name">StateEntry</span> <span class="token keyword">extends</span> <span class="token class-name">HistoryState</span> <span class="token punctuation">{</span>
  back<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span>
  current<span class="token operator">:</span> HistoryLocation
  forward<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span>
  position<span class="token operator">:</span> <span class="token builtin">number</span>
  replaced<span class="token operator">:</span> <span class="token builtin">boolean</span>
  scroll<span class="token operator">:</span> _ScrollPositionNormalized <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span></code></pre></div>
<p>可见，<code class="language-text">useHistoryStateNavigation</code>首次调用<code class="language-text">changeLocation</code>的目的就是初始化状态，因为默认的原生路由不会提供上面的状态信息。</p>
<p>回到我们的<code class="language-text">useHistoryStateNavigation</code>，继续往下走，就是我们非常熟悉的 API：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span></code></pre></div>
<p>他们本质上是对<code class="language-text">changeLocation</code>又做了一次封装, 并最终暴露给调用者，这里简单地讲一下具体的实现：</p>
<p><strong>push()</strong></p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> HistoryLocation<span class="token punctuation">,</span> data<span class="token operator">?</span><span class="token operator">:</span> HistoryState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentState <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    historyState<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    history<span class="token punctuation">.</span>state <span class="token keyword">as</span> Partial<span class="token operator">&lt;</span>StateEntry<span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      forward<span class="token operator">:</span> to<span class="token punctuation">,</span>
      scroll<span class="token operator">:</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>history<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一些错误提示文本，略去</span>
  <span class="token punctuation">}</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>currentState<span class="token punctuation">.</span>current<span class="token punctuation">,</span> currentState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> state<span class="token operator">:</span> StateEntry <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">buildState</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> position<span class="token operator">:</span> currentState<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data
  <span class="token punctuation">)</span>
  <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
<span class="token punctuation">}</span></code></pre></div>
<ul>
<li>第一步：利用<code class="language-text">assign()</code>合并相关内容，获取当前状态<code class="language-text">currentState</code>。</li>
<li>第二步：利用<code class="language-text">changeLocation</code>改变当前状态。</li>
<li>第三步：利用<code class="language-text">assign()</code>合并相关内容，获取当前状态<code class="language-text">state</code>（这是最终状态）。</li>
<li>第四步：将现在的路径赋值给<code class="language-text">currentLocation</code>,整个过程结束。</li>
</ul>
<p>我们可以看到，一次<code class="language-text">push</code>状态改变了两次，我们可以在控制台上打印这两个状态一探究竟：
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c66b952854d4869b24bee95c9df86ee3/ea64c/Snipaste_2022-03-20_09-53-04.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAABJNAAASTQHzl8SnAAABCUlEQVQoz4WO3W7DIAyF+/6v15tt7VqSJoT8QYFAggF7SrSLdIu2o2P5yNKn4xMRISIRcTmz8sF5PYyj1tpqPTm3t3NOWX9mshGcN40Q4kQbTUQglWSFqitV145zV1WzEEkIL4Rv+7nt3BpGkCp3HcaYEb/hlZ7scuf2fE1lSV1HhJQz5Yx7p4xEqDXFSESvMJfPazu1Q3zq7XQstPYFJqLc9+7t4i839fHuLp/xfoeCxaIAxgIrAisDY1A84FHh7fazGY12g5kGsxiTIWCMAJDitiCucZ2U8FfzWm1NUIusrfVAf+ro7afyTefFaNs+GYPTdGSH3uMw7OBNCWLyHsNCEGhZ/vHW9wUI3QhFNn0KqAAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 20 09 53 04"
        title="Snipaste 2022 03 20 09 53 04"
        src="/static/c66b952854d4869b24bee95c9df86ee3/f058b/Snipaste_2022-03-20_09-53-04.png"
        srcset="/static/c66b952854d4869b24bee95c9df86ee3/c26ae/Snipaste_2022-03-20_09-53-04.png 158w,
/static/c66b952854d4869b24bee95c9df86ee3/6bdcf/Snipaste_2022-03-20_09-53-04.png 315w,
/static/c66b952854d4869b24bee95c9df86ee3/f058b/Snipaste_2022-03-20_09-53-04.png 630w,
/static/c66b952854d4869b24bee95c9df86ee3/40601/Snipaste_2022-03-20_09-53-04.png 945w,
/static/c66b952854d4869b24bee95c9df86ee3/ea64c/Snipaste_2022-03-20_09-53-04.png 1116w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span>
可以看出，第一个状态可以看成一个”中间状态”，体现在<code class="language-text">forward</code>字段上，第二个状态才是我们的最终状态，可以看到<code class="language-text">current</code>已经变成了<code class="language-text">hello</code>。</p>
<p>replace 的过程也差不多，在此就不赘述了。</p>
<p>最后，<code class="language-text">useHistoryStateNavigation</code>返回一个对象, 向外提供了四个 API，外界通过调用它们即可实现对路由的一系列导航跳转操作。</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">return</span> <span class="token punctuation">{</span>
  location<span class="token operator">:</span> currentLocation<span class="token punctuation">,</span>
  state<span class="token operator">:</span> historyState<span class="token punctuation">,</span>
  push<span class="token punctuation">,</span>
  replace<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>useHistoryListeners — 路由监听</h3>
<p><code class="language-text">vue-router</code>利用监听<code class="language-text">popstate</code>事件来实现路由监听，我们首先了解一下<code class="language-text">popstate</code>事件何时触发？</p>
<p>我们查阅<code class="language-text">MDN</code>文档:</p>
<blockquote>
<p>The popstate event of the Window interface is fired when the active history entry changes while the user navigates the session history.</p>
</blockquote>
<blockquote>
<p>The popstate event will be triggered by doing a browser action such as a click on the back or forward button (or calling history.back() or history.forward() in JavaScript).</p>
</blockquote>
<p>简而言之，当页面已经存在于<code class="language-text">history</code>栈并再此访问<code class="language-text">history</code>栈的页面时才会触发<code class="language-text">popstate</code>，例如用户点击浏览器回退按钮或者使用<code class="language-text">history.back()</code>或者<code class="language-text">history.forward()</code>。</p>
<p>我们来看<code class="language-text">useHistoryListeners</code>函数</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
  base<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  historyState<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>StateEntry<span class="token operator">></span><span class="token punctuation">,</span>
  currentLocation<span class="token operator">:</span> ValueContainer<span class="token operator">&lt;</span>HistoryLocation<span class="token operator">></span><span class="token punctuation">,</span>
  replace<span class="token operator">:</span> RouterHistory<span class="token punctuation">[</span><span class="token string">'replace'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> listeners<span class="token operator">:</span> NavigationCallback<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> teardowns<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">let</span> pauseState<span class="token operator">:</span> HistoryLocation <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span></code></pre></div>
<p>首先定义了监听器栈，移除栈(用于移除监听函数，后面会讲)，和<code class="language-text">pauseState</code>标识。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span>callback<span class="token operator">:</span> NavigationCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// setup the listener and prepare teardown callbacks</span>
  listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token function-variable function">teardown</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  teardowns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>teardown<span class="token punctuation">)</span>
  <span class="token keyword">return</span> teardown
<span class="token punctuation">}</span></code></pre></div>
<p>通过<code class="language-text">listen</code>函数将回调压进监听器栈中，同时将移除回调的移除函数压进移除栈中。</p>
<p>我们往下走，发现了<code class="language-text">popstate</code>事件的注册。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"popstate"</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">)</span></code></pre></div>
<p>进入<code class="language-text">popStateHandle</code>函数</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> popStateHandler<span class="token operator">:</span> <span class="token function-variable function">PopStateListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  state<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> StateEntry <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span>
  <span class="token keyword">const</span> from<span class="token operator">:</span> HistoryLocation <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value
  <span class="token keyword">const</span> fromState<span class="token operator">:</span> StateEntry <span class="token operator">=</span> historyState<span class="token punctuation">.</span>value
  <span class="token keyword">let</span> delta <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to
    historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state

    <span class="token comment">// ignore the popstate and reset the pauseState</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pauseState <span class="token operator">&amp;&amp;</span> pauseState <span class="token operator">===</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pauseState <span class="token operator">=</span> <span class="token keyword">null</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    delta <span class="token operator">=</span> fromState <span class="token operator">?</span> state<span class="token punctuation">.</span>position <span class="token operator">-</span> fromState<span class="token punctuation">.</span>position <span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// call all listeners</span>
  listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>listener <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      delta<span class="token punctuation">,</span>
      type<span class="token operator">:</span> NavigationType<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
      direction<span class="token operator">:</span> delta
        <span class="token operator">?</span> delta <span class="token operator">></span> <span class="token number">0</span>
          <span class="token operator">?</span> NavigationDirection<span class="token punctuation">.</span>forward
          <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>back
        <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span><span class="token builtin">unknown</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>首先获取了当前的路径，上一跳的路径(from)和<code class="language-text">state</code>(fromState)并初始化了<code class="language-text">delta</code>(本页面与上一跳在<code class="language-text">history</code>栈的距离)。</p>
<p>然后更新了<code class="language-text">currentLocation.value</code>和<code class="language-text">historyState.value</code>来保证下一跳时<code class="language-text">from</code>和<code class="language-text">formState</code>是正确的。</p>
<p>接着就是调用监听器栈中所有的监听器并传入相应的信息来供监听器使用。</p>
<p>还记得刚开始的<code class="language-text">pauseState</code>吗，它是用来暂停监听器的一个标识，我们来看它是如果起作用的。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pauseState <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">useHistoryListeners</code>将<code class="language-text">pauseListeners</code>导出，当调用此函数时<code class="language-text">pauseState</code>被设置为<code class="language-text">currentLocation.value</code></p>
<p>当下一次<code class="language-text">popstate</code>被触发时，<code class="language-text">popStateHandler</code>被调用。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> from<span class="token operator">:</span> HistoryLocation <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value

<span class="token keyword">if</span> <span class="token punctuation">(</span>pauseState <span class="token operator">&amp;&amp;</span> pauseState <span class="token operator">===</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  pauseState <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">return</span>
<span class="token punctuation">}</span></code></pre></div>
<p>它会去验证<code class="language-text">pauseState</code>是否与<code class="language-text">currentLocation.value</code>相等，从而中止
<code class="language-text">popStateHandler</code>的执行，也就暂停了监听器的执行。</p>
<p>将<code class="language-text">pauseState</code>重新赋值为<code class="language-text">null</code>意味着监听器函数只会被暂停一次，我们可以来验证一下。
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 627px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/af10c4e8914f4898f71b032af43abc25/e9c9b/Snipaste_2022-03-18_15-01-37.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 82.91139240506328%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAIAAABSJhvpAAAACXBIWXMAABJNAAASTQHzl8SnAAABwElEQVQ4y72T227bMBBE/f9/FxcIWiQuHKSWJdG8LPdGSiJZyGpiGwgK9KWDAZ94lruD5S5EZFEVMcYEAOe9tTYCEJI6n2IspbYPzfM8XT0vS2ttt8HMPIyj8wGJIqIIq+rEMomUUj/V6q3QDVbVi7UBIEaEGJlIRSfiTFQfgS9hcc75sL6MiCklVU15WsqiqkysKbG10nXcn/lySdN0g4XZOstXAQATA0RmIcQYY4CwThRCHAayl4llnuc/sGhqrW3tTXkyZhyGISISEQDIKg4hsAgQkchD2xu88bXWnHPf99Y6a12E6IMPEJLq3fD1YeacMzPHiERpWepnoTXq8hD2fXwbzEzY92djxpRSreVau7ZW7s7a2rK51tWtLbuAIvie4BuYZzB7uOzDuPfjU7TPEx/H0351tx9OT5fh2Znv4F68+YHh0OZu5yOmRNEdj4en97e9HV+XbARPSl3mXvCUZUjUJe5aCa2EMjtwb4LnVsK1bU0R8P1Xd+p667CU9hfVWhFZNd+vJ/VDPxojmu4jutfH5LfMV1jT5L1/Pfw8vh29D621Ur7m19Dm+dydt2srTKLL9Zf8qx6W5L/CvwGFwdnjW+BKGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 15 01 37"
        title="Snipaste 2022 03 18 15 01 37"
        src="/static/af10c4e8914f4898f71b032af43abc25/e9c9b/Snipaste_2022-03-18_15-01-37.png"
        srcset="/static/af10c4e8914f4898f71b032af43abc25/c26ae/Snipaste_2022-03-18_15-01-37.png 158w,
/static/af10c4e8914f4898f71b032af43abc25/6bdcf/Snipaste_2022-03-18_15-01-37.png 315w,
/static/af10c4e8914f4898f71b032af43abc25/e9c9b/Snipaste_2022-03-18_15-01-37.png 627w"
        sizes="(max-width: 627px) 100vw, 627px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e39bf0a8fee2b233309feec5446043f9/8bd7c/Snipaste_2022-03-18_15-00-43.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 61.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAABJNAAASTQHzl8SnAAABSElEQVQoz3WR247bMAxE9/9/r0Cz6EMWQbuO49iWRFKkqAtVxF4EReMdzBMxB0OQb31TUvWAAckjRaI83+XPp1yHOAz6OZTb2O5T975H7pqbSGU25rf/YcDIEhBu8wJExEIimpKWkkrJOWfEh1Oy3g9gihyJECBGggCRSET2SfA+jDecJhX5BmbZh7WUZVnu8xwAAwREIIqac651DxyvnXNmls1MiIKUmFW1tbbnzax/08zOu+s4Oud9CIgYAwjzF7SpP2A7bgaAeVkRo6THsSSlpPqF/KNDmDmi9y6J9L7HbXPrvZpVs2KtmNUXGCPRndzPdfwBywmWE7lfDOd1Oq3Tu5ve0Z9j+EB3bjq8Nj8+5d00Xi9+nbPGrFCUslLJVEvspptzNz1aW9KyuMvlNyI+D/tc3XovuQBgre34z8/8q/Zha83M/gKy77Zasu8wKwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 15 00 43"
        title="Snipaste 2022 03 18 15 00 43"
        src="/static/e39bf0a8fee2b233309feec5446043f9/f058b/Snipaste_2022-03-18_15-00-43.png"
        srcset="/static/e39bf0a8fee2b233309feec5446043f9/c26ae/Snipaste_2022-03-18_15-00-43.png 158w,
/static/e39bf0a8fee2b233309feec5446043f9/6bdcf/Snipaste_2022-03-18_15-00-43.png 315w,
/static/e39bf0a8fee2b233309feec5446043f9/f058b/Snipaste_2022-03-18_15-00-43.png 630w,
/static/e39bf0a8fee2b233309feec5446043f9/8bd7c/Snipaste_2022-03-18_15-00-43.png 845w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>可见监听器函数只被暂停了一次，<code class="language-text">popstate</code>再次触发的时候监听器正常工作。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> teardown <span class="token keyword">of</span> teardowns<span class="token punctuation">)</span> <span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  teardowns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"popstate"</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span>
  window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">"beforeunload"</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token punctuation">{</span>
  pauseListeners<span class="token punctuation">,</span>
  listen<span class="token punctuation">,</span>
  destroy<span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></div>
<p><code class="language-text">destroy</code>则为监听器的卸载，<code class="language-text">useHistoryListeners</code>返回一个对象，向外界提供了三个 API。</p>
<h2>createWebHashHistory</h2>
<p>这是<code class="language-text">VueRouter</code>提供的第二种路由解决方案，在了解了上面的<code class="language-text">createWebHistory</code>的基本流程之后，我们可以轻松写出<code class="language-text">createWebHashHistory</code>,它只不过是在基础的 URL 之后加上了一个<code class="language-text">#</code>，来看它的实现：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createWebHashHistory</span><span class="token punctuation">(</span>base<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> RouterHistory <span class="token punctuation">{</span>
  base <span class="token operator">=</span> location<span class="token punctuation">.</span>host <span class="token operator">?</span> base <span class="token operator">||</span> location<span class="token punctuation">.</span>pathname <span class="token operator">:</span> <span class="token string">""</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> base <span class="token operator">+=</span> <span class="token string">"#"</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"#/"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A hash base must end with a "#":\n"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" should be "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#.*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token string">"#"</span>
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">".</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>总结</h2>
<p>至此，<code class="language-text">VueRouter</code>的路由核心部分已经全部分析完成，这一部分的源码中没有提到任何<code class="language-text">Vue</code>的知识，只是对<strong>原生的 API 进行封装</strong>。保证了其<strong>高可用性</strong>。此时，我们也可以手撕一个完美的路由库了。</p>
<h3>两种路由模式有什么不同</h3>
<h4>hash</h4>
<p>hash 路由利用了浏览器的特性 — hash 值的变化，并不会导致浏览器向服务器发出请求，浏览器不发出请求，也就不会刷新页面：</p>
<div class="gatsby-highlight" data-language="http"><pre class="language-http"><code class="language-http"><span class="token header-name keyword">https:</span>//xxx.com/xxx/hello#helloworld
// 不变刷新页面
<span class="token header-name keyword">https:</span>//xxx.com/xxx/hello#helloworld2</code></pre></div>
<p>通过监听<code class="language-text">hashchange</code>事件来实现我们的目标。</p>
<p>hash 路由对于没有主机的 Web 应用程序很有用。</p>
<h4>history</h4>
<p>history 路由利用 HTML5 的<code class="language-text">HistoryAPI</code>来控制状态。</p>
<p>history 路由适合有主机的 Web 应用程序，由于每一个<strong>虚拟的 URL</strong>需要对应服务端的一个地址，所以我们需要在服务端（例如 nginx）进行重定向，例如在<code class="language-text">nginx</code>下可以如此处理：</p>
<div class="gatsby-highlight" data-language="nginx"><pre class="language-nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">{</span>
  <span class="token directive"><span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token variable">$uri</span>/ /index.html</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>更多的处理方案请自行阅读官方文档。</p>
<h3>VueRouter 对底层路由管理实现的巧妙之处</h3>
<p><code class="language-text">VueRouter</code>的<code class="language-text">hashRouter</code>是基于<code class="language-text">WebHistory</code>的，只是在基础 url 之后加了一个<code class="language-text">#</code>，这一操作不仅实现了<code class="language-text">hashRouter</code>的特性，同时完美利用了之前封装好的<code class="language-text">HistoryAPI</code>，真可谓路由封装的最佳实践。</p>
<h2>路由 vuetify</h2>
<p>在这里之前封装好的路由将被赋予<code class="language-text">vue</code>的特性, 这也是<code class="language-text">VueRouter</code>源码的核心部分。主要的代码位于<code class="language-text">src/router.ts</code>下，下面展示一个<code class="language-text">Demo</code>代码(来自官网)，来回顾一下<code class="language-text">vueRouter</code>是如何使用的。</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// 第一步: 定义路由组件</span>
<span class="token keyword">const</span> Home <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token operator">:</span> <span class="token string">"&lt;div>Home&lt;/div>"</span> <span class="token punctuation">}</span>
<span class="token keyword">const</span> About <span class="token operator">=</span> <span class="token punctuation">{</span> template<span class="token operator">:</span> <span class="token string">"&lt;div>About&lt;/div>"</span> <span class="token punctuation">}</span>

<span class="token comment">// 第二步: 定义路径和组件的映射关系</span>
<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Home <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"/about"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> About <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token comment">// 第三步: 创建路由实例</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> VueRouter<span class="token punctuation">.</span><span class="token function">createRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 第四步： 设置路由的模式</span>
  history<span class="token operator">:</span> VueRouter<span class="token punctuation">.</span><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  routes<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 第五步: 初始化vue</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> Vue<span class="token punctuation">.</span><span class="token function">createApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"#app"</span><span class="token punctuation">)</span></code></pre></div>
<p>我们介绍的重点在第三步，我们从 <code class="language-text">createRouter()</code> 起手来分析其原理。</p>
<h3>路由初始化</h3>
<p><code class="language-text">createRouter()</code> 用来创建供<code class="language-text">Vue</code>应用程序使用的<code class="language-text">Router</code>实例。它返回一个 <code class="language-text">router</code> 对象，里面就是我们熟悉的一系列 <code class="language-text">vue-router</code> API：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 587px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c6fc5eee4aa9de1932e39135f0241ab1/d72eb/Snipaste_2022-03-18_16-30-27.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 111.39240506329114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAABJNAAASTQHzl8SnAAADYElEQVQ4y11T3W7bNhT2w2yNLYu/hzyUZFmWRFKiJCdpk6JBCzQDdr9i7bAGu90T7B3aZOmecqDkpMMAXvCCH8/3d1a3/V+/XH357d3D3ftvH66/fnr78Ondw93t4+fbx4839x9vvt799Hh3+/jxzf0fP3/7/P7vX9/cf3j95fe3/9x0f65epPmGFQBub465Dow3CS8h9wItx1Yay1QdL5lLZbVhpTA2lRWBw5ruVltaM7AZTqW5KM3lzpwz6XQ2ZLtjtpswHzl4wCCUT2idkJpDZ4rJ5BPA+SqhFRGNVsGogYgm4QcGTmjPwK7T/Trdb0i1IdXzZUOqs225SSuE61VCKiIjONeT0SOqgQvHtcNiENpL7DhYJi0Ht3yx5bUyvTIB1dVpcoZjaS6q7GWBxxyPAiLe7CazGzEfuHJc+Zn5YZ3uqWhMMWb69QksoNMQMj3mOCEMQnnATmWBgY1zsl6oqIUrR6VlygrVPYFlAzMYYUAdQHVUtGA6gT6hFRUtlS3hTcpqKm3Km1TUKW+Nuj5NRj3U+avKXErpiWgAO1OMQvstPST0kPJmQ/Zn2/JsWxLeENFQYZ/AsjE4ZnrKswn1QOVCNSgTVD5I7MD0DCwRbcqbWbwTykfaG7JPRa1V4Nxy7Ti0ND6qOVgRtTmhHAcLphc6wjbp/izZrbd7LV+tXiTFhpQg3E5NuRw4bVJWAXqpLJctoOfQbmlFef1jkv9wZtbbHVeWyRbE5SlngL7AI6pBgAPTg+l1pN0z5Yho/tuQGH6k4M2T2y1AV+B5gUcmWjqThCzqXGgv9ZgFx8Cl9rG/z1FpFbJ5MuWNUB7zAfMw4x1Xjkm7XurFasgCFkFib/T3qMYSLwo9MWmjz1kAjEgqWzABi5GIloGTGP+NK0BrDVenyUqFQh+5sFw5MJ3E2BOuXBrfxagpWKk7obzOgjQd6H7OmSzgPtdHgA5xAN1xcAxs3Arl0tiKdl6S6BMDy8ByWAwjVSoi+JC9LM1FricJEYPFgMUQ+Wf9shspb4T2VLZbeiC8PYFjVKrf4VFDIKJhyqksxFEmUjgZlu4X8ioLUntlwnfaQnqjRxPdbpm0Mcl5mSV2yy+Ralysbk7LyUXzhkS3OTgpvZAOZAfSM2GxiK1+7sb/TkJqhKt/AVFoMD8Ms2PlAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 16 30 27"
        title="Snipaste 2022 03 18 16 30 27"
        src="/static/c6fc5eee4aa9de1932e39135f0241ab1/d72eb/Snipaste_2022-03-18_16-30-27.png"
        srcset="/static/c6fc5eee4aa9de1932e39135f0241ab1/c26ae/Snipaste_2022-03-18_16-30-27.png 158w,
/static/c6fc5eee4aa9de1932e39135f0241ab1/6bdcf/Snipaste_2022-03-18_16-30-27.png 315w,
/static/c6fc5eee4aa9de1932e39135f0241ab1/d72eb/Snipaste_2022-03-18_16-30-27.png 587w"
        sizes="(max-width: 587px) 100vw, 587px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h4>整体过程</h4>
<p>我们省略函数定义(后面会讲)和一些细节处理，突出主干部分。</p>
<p>我以代码和注释的形式来解释。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRouter</span><span class="token punctuation">(</span>options<span class="token operator">:</span> RouterOptions<span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token comment">// 1.初始化matcher，可以看成路由管理器</span>
  <span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
  <span class="token comment">// 2.获取路由API(hashAPI 或者 HistoryAPI)</span>
  <span class="token keyword">const</span> routerHistory <span class="token operator">=</span> options<span class="token punctuation">.</span>history

  <span class="token comment">// 3.利用useCallbacks()处理化前置守卫、解析守卫、后置守卫</span>
  <span class="token keyword">const</span> beforeGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> beforeResolveGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationGuardWithThis<span class="token operator">&lt;</span><span class="token keyword">undefined</span><span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> afterGuards <span class="token operator">=</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationHookAfter<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 4.当前路由注意这里与vue3结合，使用了vue3的shallowRef，做到了响应式路由</span>
  <span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token generic-function"><span class="token function">shallowRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token constant">START_LOCATION_NORMALIZED</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">const</span> router<span class="token operator">:</span> Router <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 5. 准备挂载到全局vueApp上，这是vue提供的插件功能，之后这个函数会被vue调用</span>
    <span class="token function">install</span><span class="token punctuation">(</span>app<span class="token operator">:</span> App<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 省略，后面会讲到</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 6. 省略其他暴露的API，可见上图</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> router
<span class="token punctuation">}</span></code></pre></div>
<h4>createRouterMatcher —初始化路由 matcher</h4>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>routes<span class="token punctuation">,</span> options<span class="token punctuation">)</span></code></pre></div>
<p>首先利用 <code class="language-text">createRouterMatcher()</code> 初始化了 <code class="language-text">matcher</code> 变量，这个函数返回值如下, 可以看出是路由处理的一套<code class="language-text">API</code>，其中有部分再次向外暴露给用户（可以对比一下本节的第一张图片），如<code class="language-text">addRoute</code>，很明显，我们可以利用这些 API 使用<strong>动态路由</strong>功能：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span></code></pre></div>
<h3>addRoute()</h3>
<p><code class="language-text">createRouterMatcher</code>传入路由表<code class="language-text">routes</code>，以及全局配置<code class="language-text">globalOptions</code>, 它利用<code class="language-text">addRoute()</code>递归地遍历路由表, 来看<code class="language-text">addRoute()</code>，其中参数<code class="language-text">record</code>表示单个路由记录:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>
  record<span class="token operator">:</span> RouteRecordRaw<span class="token punctuation">,</span>
  parent<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher<span class="token punctuation">,</span>
  originalRecord<span class="token operator">?</span><span class="token operator">:</span> RouteRecordMatcher
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 判断是否为根路由</span>
  <span class="token keyword">const</span> isRootAdd <span class="token operator">=</span> <span class="token operator">!</span>originalRecord
  <span class="token comment">// 对路由记录作正常化处理，返回的是处理后的路由记录</span>
  <span class="token keyword">const</span> mainNormalizedRecord <span class="token operator">=</span> <span class="token function">normalizeRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span>
  <span class="token comment">// 处理路由记录别名功能</span>
  mainNormalizedRecord<span class="token punctuation">.</span>aliasOf <span class="token operator">=</span> originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>record
  <span class="token keyword">const</span> options<span class="token operator">:</span> PathParserOptions <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>globalOptions<span class="token punctuation">,</span> record<span class="token punctuation">)</span>
  <span class="token comment">// generate an array of records to correctly handle aliases</span>
  <span class="token keyword">const</span> normalizedRecords<span class="token operator">:</span> <span class="token keyword">typeof</span> mainNormalizedRecord<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    mainNormalizedRecord<span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"alias"</span> <span class="token keyword">in</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> aliases <span class="token operator">=</span>
      <span class="token keyword">typeof</span> record<span class="token punctuation">.</span>alias <span class="token operator">===</span> <span class="token string">"string"</span> <span class="token operator">?</span> <span class="token punctuation">[</span>record<span class="token punctuation">.</span>alias<span class="token punctuation">]</span> <span class="token operator">:</span> record<span class="token punctuation">.</span>alias<span class="token operator">!</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> alias <span class="token keyword">of</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      normalizedRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> mainNormalizedRecord<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          <span class="token comment">// this allows us to hold a copy of the `components` option</span>
          <span class="token comment">// so that async components cache is hold on the original record</span>
          components<span class="token operator">:</span> originalRecord
            <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record<span class="token punctuation">.</span>components
            <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">.</span>components<span class="token punctuation">,</span>
          path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
          <span class="token comment">// we might be the child of an alias</span>
          aliasOf<span class="token operator">:</span> originalRecord
            <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record
            <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">,</span>
          <span class="token comment">// the aliases are always of the same kind as the original since they</span>
          <span class="token comment">// are defined on the same record</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">typeof</span> mainNormalizedRecord
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> matcher<span class="token operator">:</span> RouteRecordMatcher
  <span class="token keyword">let</span> originalMatcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span>
  <span class="token comment">// 遍历所有路由记录</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> normalizedRecord <span class="token keyword">of</span> normalizedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 格式化路径</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> normalizedRecord

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"/"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> parentPath <span class="token operator">=</span> parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path
      <span class="token keyword">const</span> connectingSlash <span class="token operator">=</span>
        parentPath<span class="token punctuation">[</span>parentPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"/"</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">"/"</span>
      normalizedRecord<span class="token punctuation">.</span>path <span class="token operator">=</span>
        parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> connectingSlash <span class="token operator">+</span> path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 初始化父路由信息(为子路由准备的)</span>
    matcher <span class="token operator">=</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>normalizedRecord<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> options<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"/"</span><span class="token punctuation">)</span>
      <span class="token function">checkMissingParamsInAbsolutePath</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> parent<span class="token punctuation">)</span>

    <span class="token comment">// if we are an alias we must tell the original record that we exist</span>
    <span class="token comment">// so we can be removed</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>originalRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      originalRecord<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkSameParams</span><span class="token punctuation">(</span>originalRecord<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// otherwise, the first record is the original and others are aliases</span>
      originalMatcher <span class="token operator">=</span> originalMatcher <span class="token operator">||</span> matcher
      <span class="token keyword">if</span> <span class="token punctuation">(</span>originalMatcher <span class="token operator">!==</span> matcher<span class="token punctuation">)</span> originalMatcher<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>

      <span class="token comment">// remove the route if named and only for the top record (avoid in nested calls)</span>
      <span class="token comment">// this works because the original record is the first one</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isRootAdd <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAliasRecord</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">removeRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断是否有孩子，如果有，递归执行addRouter(),以matcher（代表父路由）、originalRecord（代表未经处理过的路由原始记录）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"children"</span> <span class="token keyword">in</span> mainNormalizedRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> mainNormalizedRecord<span class="token punctuation">.</span>children
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addRoute</span><span class="token punctuation">(</span>
          children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
          matcher<span class="token punctuation">,</span>
          originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if there was no original record, then the first one was not an alias and all</span>
    <span class="token comment">// other alias (if any) need to reference this record when adding children</span>
    originalRecord <span class="token operator">=</span> originalRecord <span class="token operator">||</span> matcher

    <span class="token comment">// TODO: add normalized records for more flexibility</span>
    <span class="token comment">// if (parent &amp;&amp; isAliasRecord(originalRecord)) {</span>
    <span class="token comment">//   parent.children.push(originalRecord)</span>
    <span class="token comment">// }</span>
    <span class="token comment">// 插入到Matchers数组中</span>
    <span class="token function">insertMatcher</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> originalMatcher
    <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token comment">// since other matchers are aliases, they should be removed by the original matcher</span>
        <span class="token function">removeRoute</span><span class="token punctuation">(</span>originalMatcher<span class="token operator">!</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token operator">:</span> noop
<span class="token punctuation">}</span></code></pre></div>
<p>这里其实就是把我们传入的路径和组件的映射(<code class="language-text">record</code>)作一系列的处理，例如标准化参数,处理别名等等，接着给每一个<code class="language-text">record</code>创建一个<code class="language-text">matcher</code>对象，并推进<code class="language-text">Matchers</code>数组中。</p>
<p>我们进入到<code class="language-text">createRouteRecordMatcher</code>中，可以看到<code class="language-text">matcher</code>的形式。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> matcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  record<span class="token punctuation">,</span>
  parent<span class="token punctuation">,</span>
  <span class="token comment">// these needs to be populated by the parent</span>
  children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  alias<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p>我们讲<code class="language-text">router</code>挂载到<code class="language-text">window</code>下，调用<code class="language-text">getRoutes</code>方法可以看到<code class="language-text">matchers</code>数组
<span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/290b446e4c42e34a9d6b0a6eb084d028/681f1/Snipaste_2022-03-18_19-22-28.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 80.37974683544303%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAABJNAAASTQHzl8SnAAABlUlEQVQoz51T2W7jMAz0/3/eAi0WaIM0SGPLtm6JFHW6kJN099HtYCANCQgckdJgPShtVs6FlFIqJaTRxjrvAUqpuZRcyl08URHRGGuMGcBzLU7s9ndlb2I56fndygu6kYARsAgsYl9LEsEv4GZws7eTt8yZafDgnOVCMK1WazgaDk7ljLWEnV2UjK3SLp4slDP2ymAump+tvDh9RX1Bew1+jDCRHwmmLmDKkfeyvWYnWObtNHhEIQRjbFmXZV64NNZTKWXbttY6d9G+wwd7ehuQCAGdcoREIQBGSttBDBho2zZxXtfT4pwHxFbL4cNErbXx9XP8c5WzBICU0t3nocO11tvLdXwdtTCBiCjmXI7abq3JT+mNCc7mEGouWzt+59bEB9dMWCk0NymmHzSstTafGXufJJecc+rWY3viv1G1fU7/MASKMUQ2zVarMM+KMa20lKpTKSGkfDz6nhFCCiGtddQ7VYZAlGLit9VqG5x1zsUYU0rxvuW873GP93zqqLV22xCo1pY7+gfKx+b0sH1/JL/DF1zXokDR6FFIAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 19 22 28"
        title="Snipaste 2022 03 18 19 22 28"
        src="/static/290b446e4c42e34a9d6b0a6eb084d028/f058b/Snipaste_2022-03-18_19-22-28.png"
        srcset="/static/290b446e4c42e34a9d6b0a6eb084d028/c26ae/Snipaste_2022-03-18_19-22-28.png 158w,
/static/290b446e4c42e34a9d6b0a6eb084d028/6bdcf/Snipaste_2022-03-18_19-22-28.png 315w,
/static/290b446e4c42e34a9d6b0a6eb084d028/f058b/Snipaste_2022-03-18_19-22-28.png 630w,
/static/290b446e4c42e34a9d6b0a6eb084d028/681f1/Snipaste_2022-03-18_19-22-28.png 899w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/95dcac2affea823b478f08e62f7bb2ba/3534c/Snipaste_2022-03-18_19-23-17.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 95.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAABJNAAASTQHzl8SnAAABuUlEQVQ4y41T65KbIBjNwzRRQW4CahAEQTGbTdI2m9mdvv+LdNS0v1rNzDfMx48znAtnB6kt5dWqTybfufklzBfhkYkhzU2G2vXZZcjmtGMyprkB2AHiAG43YU8wwDZDLRGD8Xdejaz0VPZpbl56GWALkEUstP7Dhof2H7w61eZm+wckbhPsALZURsQ8Yj6nHSQupw4xv5Da0AyJK8oxgXpm2ybQJPB12tgSPtTmymQkslMhqhAx9yk0LxiGLS6C7R+6uyv7vW7ftL813Q8qhm3aADsmIxUDK0cqIiQOF2FxYT22p2ZWxgNoFtkJmAcuZ7tC/uk24YNUZ8x7zDtpgmg8rdzR9HXtRTPgwv/TvwmcoRbz3g2furvX5qrcWYeLcldeh0J0RP43s12GWkgsk5FXJ6nO4nhG1BM+XQG2U2YrtGewY+X4LT3uM3UAzSHT+2mafarX0/6TsxiEOhPeo8KVOvAm0NI1YaQypPlWMXARuvil3U9lb0d30uHSuEttByL8elTt7HZfVKdSvc+aAxUjr95SOGneKAYqAuH9nLBOoM7Q9LGnZavYO0g6XIQE6kX8ouLvsg7+Dfh16NjYWVTeAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 19 23 17"
        title="Snipaste 2022 03 18 19 23 17"
        src="/static/95dcac2affea823b478f08e62f7bb2ba/f058b/Snipaste_2022-03-18_19-23-17.png"
        srcset="/static/95dcac2affea823b478f08e62f7bb2ba/c26ae/Snipaste_2022-03-18_19-23-17.png 158w,
/static/95dcac2affea823b478f08e62f7bb2ba/6bdcf/Snipaste_2022-03-18_19-23-17.png 315w,
/static/95dcac2affea823b478f08e62f7bb2ba/f058b/Snipaste_2022-03-18_19-23-17.png 630w,
/static/95dcac2affea823b478f08e62f7bb2ba/3534c/Snipaste_2022-03-18_19-23-17.png 808w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>可以看到对应了我们创建的四个映射关系。</p>
<h3>初始化路由守卫</h3>
<p>三种路由守卫都通过<code class="language-text">useCallbacks&lt;T>()</code>来初始化，可以看出它利用了闭包，<code class="language-text">handlers: T[]</code> 是存储用户注册的守卫函数的地方:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">/**
 * Create a list of callbacks that can be reset. Used to create before and after navigation guards list
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">useCallbacks</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> handlers<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    handlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> i <span class="token operator">=</span> handlers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> handlers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    add<span class="token punctuation">,</span>
    <span class="token function-variable function">list</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> handlers<span class="token punctuation">,</span>
    reset<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>这个函数被调用之后返回一个对象，并且，<code class="language-text">add</code> 会在 <code class="language-text">createRouter()</code> 主函数中作为我们熟悉的 <code class="language-text">beforeEach</code> 等 API 暴露给调用者：</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/7d11b1b027e9e8757ddc9105b0a438e9/c425d/Snipaste_2022-03-18_19-32-14.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 78.48101265822784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAABJNAAASTQHzl8SnAAABcklEQVQoz5WT227iMBRF+ZgZ1Y7t41sSExNfE0hImqJSoZn//5JRENK8QAvSel3a2/vIG1BdQYKUe1YOVO2x7rHMBPxv3PxC5ns2VCTCoqoG3cyVXajuEcQCPKLujbTfsykgFjxUdq7sREVE1GHqMPOYhR9ZZSKSS+fQX8pmKiBczadYZSpzm8++v/CyR7fY52WRbDhZfyI8Pm+uMrm+WZtR1oeXOt+SCx5KO4HqXup8k5nqXP7SZiQQ8YuDBSI60XzyelT1KMxSmoGK+EY9Yv95IPMELBiz1GbRKppybMxUyQjMA3VAWiA7Tl1xV8YQFI/GTk37Xm6Puh7Mbm7cUrWLtjOIRHXPIVDq0N3kUkSfPrvhb+tP1n+EfM6HP7t8MXYuzSjtuxSJ3ZUxRA5eyyRFlCJWuq90r1Un9R5oy8iOrbVb8vBUIvn+4vIXrw56e9TbozAjbGfM47oWhEebrTJmnkCgIuPrT0LMIeoQaX881T/vX8LGj0JU6QAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 18 19 32 14"
        title="Snipaste 2022 03 18 19 32 14"
        src="/static/7d11b1b027e9e8757ddc9105b0a438e9/f058b/Snipaste_2022-03-18_19-32-14.png"
        srcset="/static/7d11b1b027e9e8757ddc9105b0a438e9/c26ae/Snipaste_2022-03-18_19-32-14.png 158w,
/static/7d11b1b027e9e8757ddc9105b0a438e9/6bdcf/Snipaste_2022-03-18_19-32-14.png 315w,
/static/7d11b1b027e9e8757ddc9105b0a438e9/f058b/Snipaste_2022-03-18_19-32-14.png 630w,
/static/7d11b1b027e9e8757ddc9105b0a438e9/40601/Snipaste_2022-03-18_19-32-14.png 945w,
/static/7d11b1b027e9e8757ddc9105b0a438e9/78612/Snipaste_2022-03-18_19-32-14.png 1260w,
/static/7d11b1b027e9e8757ddc9105b0a438e9/c425d/Snipaste_2022-03-18_19-32-14.png 1279w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p><code class="language-text">add</code> 用来注册守卫，<code class="language-text">reset</code> 清空守卫，<code class="language-text">list</code> 是一个函数，返回 <code class="language-text">handlers</code> 数组，在相应的时机 <code class="language-text">vue-router</code> 会遍历调用之。</p>
<h3>当前路由 — currentRoute</h3>
<p>这是响应式路由的核心，其中常量 <code class="language-text">START_LOCATION_NORMALIZED</code> 为默认路由（<code class="language-text">/</code>）：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token operator">:</span> RouteLocationNormalizedLoaded <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  query<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  hash<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  fullPath<span class="token operator">:</span> <span class="token string">"/"</span><span class="token punctuation">,</span>
  matched<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> currentRoute <span class="token operator">=</span> <span class="token generic-function"><span class="token function">shallowRef</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationNormalizedLoaded<span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token constant">START_LOCATION_NORMALIZED</span>
<span class="token punctuation">)</span></code></pre></div>
<p>使用<code class="language-text">vue</code>的<strong>响应式 API</strong><code class="language-text">shallowRef</code>处理<code class="language-text">currentRoute</code>使其成为响应式的元素，一旦它改变就会触发视图的更新。</p>
<p>可参考官方文档：<a href="https://vuejs.org/api/reactivity-advanced.html#shallowref">shallowRef</a></p>
<h3>install — 向 vue 添加全局功能</h3>
<p>这是<code class="language-text">vue</code><strong>插件机制</strong>的体现，其文档如此介绍道：</p>
<p>插件是自包含的代码，通常向 Vue 添加全局级功能。它可以是公开 <code class="language-text">install()</code> 方法的 <code class="language-text">object</code>，也可以是 <code class="language-text">function</code>。</p>
<p>插件的功能范围没有严格的限制——一般有下面几种：</p>
<ol>
<li>添加全局方法或者 property。如：<a href="https://github.com/karol-f/vue-custom-element">vue-custom-element</a></li>
<li>添加全局资源：指令/过滤器/过渡等。如：<a href="https://github.com/vuejs/vue-touch">vue-touch</a></li>
<li>通过全局混入来添加一些组件选项。如<a href="https://github.com/vuejs/vue-router">vue-router</a></li>
<li>添加全局实例方法，通过把它们添加到 <code class="language-text">config.globalProperties</code> 上实现。</li>
<li>一个库，提供自己的 API，同时提供上面提到的一个或多个功能。如 <a href="https://github.com/vuejs/vue-router">vue-router</a></li>
</ol>
<h4>代码分析</h4>
<p>来看<code class="language-text">install</code>部分的代码：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">    <span class="token function">install</span><span class="token punctuation">(</span>app<span class="token operator">:</span> App<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 获取路由对象</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span>
      <span class="token comment">// 全局注册 RouterLink、RouterView组件</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterLink'</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">'RouterView'</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span>
      <span class="token comment">// 添加全局实例属性：router，使用者可以通过 $router 来获取 vueRouter 对象</span>
      app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router
      <span class="token comment">// 劫持$route属性</span>
      <span class="token comment">// 通过unref之后的currentRoute是普通的对象而不是响应式对象</span>
      <span class="token comment">// 便于调用者二次处理</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">'$route'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token comment">// 创建初始导航，上面说过，默认的当前路由为 “/”，但是如果用户输入了 “/hello”，便不是 “/"了，所以我们要初始化一次</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        isBrowser <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// used for the initial navigation client side to avoid pushing</span>
        <span class="token comment">// multiple times when the router is used in multiple apps</span>
        <span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span>
        currentRoute<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// see above</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token comment">// 调用push方法，实现路由跳转，ps:由于他是初始路由，其实最终是调用了replace</span>
        <span class="token function">push</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>err <span class="token operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Unexpected error when starting the router:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token keyword">keyof</span> RouteLocationNormalizedLoaded<span class="token punctuation">]</span><span class="token operator">:</span> ComputedRef<span class="token operator">&lt;</span>
          RouteLocationNormalizedLoaded<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
        <span class="token operator">></span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-expect-error: the key matches</span>
        reactiveRoute<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// provide 可向根组件中注入一个 property，</span>
    <span class="token comment">// 值得注意的是这里的 routerKey、routerViewLocationKey</span>
    <span class="token comment">// 都是 es6 的 Symbol 类型，有效防止了成员变量的命名冲突</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">reactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> currentRoute<span class="token punctuation">)</span>
    <span class="token comment">// 这里应该是处理有多个vue实例的情况，扩展了unmount方法。</span>
      <span class="token keyword">const</span> unmountApp <span class="token operator">=</span> app<span class="token punctuation">.</span>unmount
      installedApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
      app<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一旦某个app实例注销，那么会从app集合中移除</span>
        installedApps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
        <span class="token comment">// 如果app集合为空，说明全部实例都已注销，</span>
        <span class="token comment">// 于是我们需要及时移除路由的监听，同时重置当前路由</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installedApps<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// invalidate the current navigation</span>
          pendingLocation <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
          removeHistoryListener <span class="token operator">&amp;&amp;</span> <span class="token function">removeHistoryListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          removeHistoryListener <span class="token operator">=</span> <span class="token keyword">null</span>
          currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
          started <span class="token operator">=</span> <span class="token boolean">false</span>
          ready <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 执行vue实例的注销方法</span>
        <span class="token function">unmountApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// devtools 相关，省略</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__DEV__ <span class="token operator">||</span> __FEATURE_PROD_DEVTOOLS__<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addDevtools</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span></code></pre></div>
<p>注入的<code class="language-text">router</code>和<code class="language-text">route</code>被包装成 API 暴漏给用户使用。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Router <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Returns the current route location. Equivalent to using `$route` inside
 * templates.
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> RouteLocationNormalizedLoaded <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>路由跳转</h3>
<p>上面提到了 <code class="language-text">createRouter()</code> 暴露了很多 API，关于路由跳转接口有这些：</p>
<ul>
<li>push</li>
<li>replace</li>
<li>pop</li>
<li>back</li>
<li>forward</li>
<li>go</li>
</ul>
<p>其中 <code class="language-text">back</code>，<code class="language-text">forward</code> 其实就是 <code class="language-text">go(+1 / -1)</code>。 对于 <code class="language-text">push</code> 和 <code class="language-text">replace</code> 请看下面代码：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocationNormalized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>可以看出他们本质上都是调用了<code class="language-text">pushWithRedirect</code>，只不过后者多了 <code class="language-text">{replace: true}</code> 下面我们来看看 <code class="language-text">pushWithRedirect</code>。</p>
<h4>pushWithRedirect — 路由跳转的核心</h4>
<p>下面结合代码注释描述一下 <code class="language-text">pushWithRedirect</code> 的过程，具体细节的方法会单独提及。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
    to<span class="token operator">:</span> RouteLocationRaw <span class="token operator">|</span> RouteLocation<span class="token punctuation">,</span>
    redirectedFrom<span class="token operator">?</span><span class="token operator">:</span> RouteLocation
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span> <span class="token punctuation">{</span>
     <span class="token comment">// 使用 resolve 解析目标路由，同时更新 pendingLocation（可以视为等待路由或者过渡路由）</span>
    <span class="token keyword">const</span> targetLocation<span class="token operator">:</span> RouteLocation <span class="token operator">=</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 记录当前路由</span>
    <span class="token keyword">const</span> from <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>value
    <span class="token comment">// 携带的数据</span>
    <span class="token keyword">const</span> data<span class="token operator">:</span> HistoryState <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>state
    <span class="token comment">// 是否强制跳转</span>
    <span class="token keyword">const</span> force<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>force
    <span class="token comment">// 是否为replace跳转，如果是通过replace调用的，那么传入的to路由会加入 { replace: true }</span>
    <span class="token keyword">const</span> replace <span class="token operator">=</span> <span class="token punctuation">(</span>to <span class="token keyword">as</span> RouteLocationOptions<span class="token punctuation">)</span><span class="token punctuation">.</span>replace <span class="token operator">===</span> <span class="token boolean">true</span>
    <span class="token comment">// 是否需要重定向</span>
    <span class="token keyword">const</span> shouldRedirect <span class="token operator">=</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span>targetLocation<span class="token punctuation">)</span>

    <span class="token comment">// 如果需要重定向，递归调用 pushWithRedirect 直至无重定向为止</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          state<span class="token operator">:</span> data<span class="token punctuation">,</span>
          force<span class="token punctuation">,</span>
          replace<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// keep original redirectedFrom if it exists</span>
        redirectedFrom <span class="token operator">||</span> targetLocation
      <span class="token punctuation">)</span>

    <span class="token comment">// 如果是来自重定向的，执行如果到了这里就是最终的路由，未来不会再重定向</span>
    <span class="token keyword">const</span> toLocation <span class="token operator">=</span> targetLocation <span class="token keyword">as</span> RouteLocationNormalized
    <span class="token comment">// 记录重定向来源</span>
    toLocation<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> redirectedFrom
    <span class="token comment">// 错误对象，下面的可能发生的错误都会赋值给他，最后它会被统一处理</span>
    <span class="token keyword">let</span> failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token comment">// 如果不是强制跳转，但是是相同的路由</span>
    <span class="token comment">// 我们就会产生一个错误并交给 failure 变量，到后面统一处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>stringifyQuery<span class="token punctuation">,</span> from<span class="token punctuation">,</span> targetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      failure <span class="token operator">=</span> <span class="token generic-function"><span class="token function">createRouterError</span><span class="token generic class-name"><span class="token operator">&lt;</span>NavigationFailure<span class="token operator">></span></span></span><span class="token punctuation">(</span>
        ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_DUPLICATED</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> to<span class="token operator">:</span> toLocation<span class="token punctuation">,</span> from <span class="token punctuation">}</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最终我们返回一个Promise</span>
    <span class="token comment">// 1. 首先判断之前的操作是否失败</span>
    <span class="token comment">// 1.1 如果失败，我们resolve了一个promise对象，执行下面的then方法</span>
    <span class="token comment">// 1.2 如果一切正常，我们调用 navigate() 方法，传入相应的路由参数执行跳转</span>
    <span class="token comment">// 1.3 因为navigate()方法返回的也是一个promise，所以如果执行跳转失败，我们则走下面的catch，成功则走下面的then方法</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>failure <span class="token operator">?</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token operator">?</span> <span class="token comment">// navigation redirects still mark the router as ready</span>
            <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> ErrorTypes<span class="token punctuation">.</span><span class="token constant">NAVIGATION_GUARD_REDIRECT</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> error
            <span class="token operator">:</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token comment">// also returns the error</span>
          <span class="token operator">:</span> <span class="token comment">// reject any unknown error</span>
            <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token comment">// 上面的navigate执行跳转成功，以及failure有值都会走到这个回调，</span>
    <span class="token comment">// 我们只要根据failure的值进行对应的处理即可</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>failure<span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> NavigationRedirectError <span class="token operator">|</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 最后我们调用 pushWithRedirect 执行跳转失败的重定向，重定向的配置和错误的类型有关</span>
            <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
              <span class="token comment">// kee optionsp</span>
              <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                state<span class="token operator">:</span> data<span class="token punctuation">,</span>
                force<span class="token punctuation">,</span>
                replace<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">// preserve the original redirectedFrom if any</span>
              redirectedFrom <span class="token operator">||</span> toLocation
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 完成导航，在这里我们实现了路由的真正跳转，执行完之后，浏览器的URL会发生相应的变化</span>
          failure <span class="token operator">=</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
            toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
            from<span class="token punctuation">,</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span>
            replace<span class="token punctuation">,</span>
            data
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 路由跳转结束的操作，在这里 afterEach 守卫将被遍历并执行，具体的代码略去，请自行查看</span>
        <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
          toLocation <span class="token keyword">as</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
          from<span class="token punctuation">,</span>
          failure
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> failure
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre></div>
<h4>navigate — 执行路由导航</h4>
<p>如果 <code class="language-text">pushWithRedirect</code> 的主要过程没有出现错误，也就是说 <code class="language-text">failure</code> 为 <code class="language-text">undefined</code> ，那么就会执行 <code class="language-text">navigate</code>。</p>
<p>navigate 函数需要我们传入目标路由 <code class="language-text">to</code> 和 起始路由 <code class="language-text">from</code>：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment">// ，，，，</span>
<span class="token punctuation">}</span></code></pre></div>
<p>首先，传入 <code class="language-text">to</code> 和 <code class="language-text">from</code>， 通过执行 <code class="language-text">extractChangingRecords</code> 提取本次路由跳转的信息：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span> <span class="token operator">=</span>
  <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">extractChangingRecords()</code> 的主要功能是遍历 <code class="language-text">to</code> 、<code class="language-text">form</code> 匹配（<code class="language-text">match</code>）的所有<code class="language-text">matcher</code>对象，然后加入到相应的数组中：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> leavingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> updatingRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> enteringRecords<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">,</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// from 匹配的match对象</span>
    <span class="token keyword">const</span> recordFrom <span class="token operator">=</span> from<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果这个对象在to中没有出现，那么将 recordFrom 放入 leavingRecords，否如果再次出现了，则放到 updatingRecords</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> leavingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
      <span class="token keyword">else</span> updatingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果 to 的match对象不再 from 里面出现，那么是新出现的，我们放到 enteringRecords 里面</span>
    <span class="token keyword">const</span> recordTo <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>recordTo <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        enteringRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></div>
<p>接着执行 <code class="language-text">extractComponentsGuards</code> ，通过传入上面的 <code class="language-text">record</code> 和守卫 type，以提取相应的路由守卫赋值给 <code class="language-text">guards</code>，另外，路由<strong>异步组件</strong>也会在这里被处理：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript">guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"beforeRouteLeave"</span><span class="token punctuation">,</span>
  to<span class="token punctuation">,</span>
  from
<span class="token punctuation">)</span></code></pre></div>
<p>这里被处理的是 <code class="language-text">beforeRouteLeave</code> 守卫。</p>
<p>来看 <code class="language-text">extractComponentsGuards</code>，略去了一些错误处理：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
  matched<span class="token operator">:</span> RouteRecordNormalized<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  guardType<span class="token operator">:</span> GuardType<span class="token punctuation">,</span>
  to<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> guards<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">>></span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment">// 遍历传入的 matched，也就是匹配的路由</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接着遍历 所有components</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> record<span class="token punctuation">.</span>components<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到 rawComponent</span>
      <span class="token keyword">let</span> rawComponent <span class="token operator">=</span> record<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span>
      <span class="token comment">// 如果它是一个合法的 vue 组件，</span>
      <span class="token comment">// isRouteComponent 合法的条件是 component 为 object 类型，且拥有 displayName、props、__vccOpts 属性</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteComponent</span><span class="token punctuation">(</span>rawComponent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过传入的 guardType 拿到 guard，并加入 guard 数组中</span>
        <span class="token keyword">const</span> guard <span class="token operator">=</span> options<span class="token punctuation">[</span>guardType<span class="token punctuation">]</span>
        guard <span class="token operator">&amp;&amp;</span> guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果他不是一个合法的组件，例如一个函数 () => import(.....)，</span>
        <span class="token comment">// 没错，你想到了懒加载模式（异步路由），</span>
        <span class="token comment">// 这个 import 在底层的实现就是一个 promise ，执行它</span>
        <span class="token keyword">let</span> componentPromise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>
          RouteComponent <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">|</span> <span class="token keyword">void</span>
        <span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span>rawComponent <span class="token keyword">as</span> Lazy<span class="token operator">&lt;</span>RouteComponent<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 将这个 promise 的 then 回调 加入到 guards 中</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
          componentPromise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolved <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> resolvedComponent <span class="token operator">=</span> <span class="token function">isESModule</span><span class="token punctuation">(</span>resolved<span class="token punctuation">)</span>
              <span class="token operator">?</span> resolved<span class="token punctuation">.</span>default
              <span class="token operator">:</span> resolved
            <span class="token comment">// 如果解析成功，我们将旧的 component （上面说了，是个异步函数）替换成我们解析的组件</span>
            record<span class="token punctuation">.</span>components<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> resolvedComponent
            <span class="token comment">// 然后拿到相应的 guard</span>
            <span class="token keyword">const</span> guard<span class="token operator">:</span> NavigationGuard <span class="token operator">=</span> resolvedComponent<span class="token punctuation">[</span>guardType<span class="token punctuation">]</span>
            <span class="token keyword">return</span> guard <span class="token operator">&amp;&amp;</span> <span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> record<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> guards
<span class="token punctuation">}</span></code></pre></div>
<p>然后，我们处理 <code class="language-text">leavingRecords</code> 的 <code class="language-text">leaveGuards</code> 守卫：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> leavingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  record<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=></span> <span class="token punctuation">{</span>
    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最终返回一个 <code class="language-text">promise</code> 链，结合注释来看源码：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">return</span> <span class="token punctuation">(</span>
  <span class="token comment">// 1.执行 from 匹配路由的 beforeRouteLeave 守卫</span>
  <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 2.将全局 beforeEach 路由用 promise 封装，加入守卫队列中</span>
      guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>
      <span class="token comment">// 3. 调用全局的 beforeEach 守卫。</span>
      <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 4. 获取 updatingRecords 的 beforeRouteUpdate 守卫</span>
      guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
        updatingRecords<span class="token punctuation">,</span>
        <span class="token string">"beforeRouteUpdate"</span><span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
        from
      <span class="token punctuation">)</span>
      <span class="token comment">// 5. 获取 updatingRecords 的 updateGuards 守卫</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> updatingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        record<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>guard <span class="token operator">=></span> <span class="token punctuation">{</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>
      <span class="token comment">// 6. 执行守卫</span>
      <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter <span class="token operator">&amp;&amp;</span> from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>record <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> beforeEnter <span class="token keyword">of</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span>
              guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>
      <span class="token comment">// 执行 beforeEnter 相关的守卫</span>
      <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
        enteringRecords<span class="token punctuation">,</span>
        <span class="token string">"beforeRouteEnter"</span><span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
        from
      <span class="token punctuation">)</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>
      <span class="token comment">// 执行 beforeEnter 相关的守卫</span>
      <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeResolveGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span>
      <span class="token comment">// 调用全局的 beforeResolve 守卫</span>
      <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 导航异常 catch 处理 ，略去</span>
<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">navigate()</code> 的一系列过程总结如下：</p>
<ul>
<li>初始化并调用 from 组件匹配到的 beforeRouteLeave 守卫、leaveGuards 守卫</li>
<li>初始化并调用全局的 beforeEach 守卫</li>
<li>初始化并调用 updatingRecords 的 beforeRouteUpdate、updateGuards 守卫</li>
<li>初始化并调用 enteringRecords 的 beforeRouteEnter 守卫</li>
<li>初始化并调用全局的 beforeResolve 守卫</li>
</ul>
<p>如何保证守卫都按顺序执行？来看 <code class="language-text">runGuardQueue</code>，它通过 <code class="language-text">Array.prototype.reduce</code> 保证了 <code class="language-text">guards</code> 链式执行：</p>
<p>原理是把后一个 <code class="language-text">guard</code> 放到前一个 <code class="language-text">guard</code> 的 <code class="language-text">then</code> 回调中：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token operator">:</span> Lazy<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> guards<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>promise<span class="token punctuation">,</span> guard<span class="token punctuation">)</span> <span class="token operator">=></span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">guard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>finalizeNavigation — 完成导航</h4>
<p>在<code class="language-text">navigate</code>方法中，我们执行了所有跳转前的守卫函数，接着我们就要执行真正跳转到这一步。</p>
<p>这个方法主要做三件事情：</p>
<ul>
<li>调用之前封装好的<strong>historyAPI</strong>执行跳转（<strong>url 层面的跳转</strong>）</li>
<li>修改当前路由 <code class="language-text">currentRoute</code>，前面说过，它是<strong>响应式</strong>的，视图层的更新将在之后自动被触发</li>
<li>调用 <code class="language-text">markAsReady()</code> 来进行一些初始化工作（这个工作只会执行<strong>一次</strong>）</li>
</ul>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
  toLocation<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  isPush<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  replace<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  data<span class="token operator">?</span><span class="token operator">:</span> HistoryState
<span class="token punctuation">)</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检测导航是否被取消(更近的导航被执行)</span>
  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> error

  <span class="token comment">// 判断是否是第一次导航</span>
  <span class="token keyword">const</span> isFirstNavigation <span class="token operator">=</span> from <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token operator">!</span>isBrowser <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> history<span class="token punctuation">.</span>state

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用routerHistoryAPI，执行 url 层面上的跳转</span>
    <span class="token comment">// 如果replace为true或者是第一次导航我们调用replace，否则调用push</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>replace <span class="token operator">||</span> isFirstNavigation<span class="token punctuation">)</span>
      routerHistory<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
        <span class="token function">assign</span><span class="token punctuation">(</span>
          <span class="token punctuation">{</span>
            scroll<span class="token operator">:</span> isFirstNavigation <span class="token operator">&amp;&amp;</span> state <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>scroll<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          data
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token keyword">else</span> routerHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 修改当前响应式路由 currentRoute，视图层的更新将会被触发</span>
  currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> toLocation
  <span class="token comment">// 判断全局router是否初始化完成，下面会说</span>
  <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<p>来看看<code class="language-text">markAsReady()</code>:</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token generic-function"><span class="token function">markAsReady</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">E</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>err<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">E</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">E</span> <span class="token operator">|</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// still not ready if an error happened</span>
    ready <span class="token operator">=</span> <span class="token operator">!</span>err
    <span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    readyHandlers
      <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    readyHandlers<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> err
<span class="token punctuation">}</span></code></pre></div>
<p>全局的 <code class="language-text">router</code> 内部有一个 <code class="language-text">ready</code> 变量，在路由首次初始化时会执行 <code class="language-text">if (!ready)</code> 之后的内容，主要做了如下事情：</p>
<ul>
<li><code class="language-text">setupListeners()</code> 初始化监听器，我们开篇说过，用户在浏览器上点击后退按钮时，会触发 <code class="language-text">popstate</code> 事件。触发时执行的套路和 <code class="language-text">pushWithRedirect</code> 十分相似 --- 调用 <code class="language-text">navigate</code>同时在 <code class="language-text">navigate</code> 成功完成时通过修改响应式变量让视图层更新。其实是覆盖了默认的<code class="language-text">history</code>跳转，让所有的跳转都再次走<code class="language-text">pushWithRedirect</code>来执行相应的守卫和触发视图层更新。</li>
<li>初始化 <code class="language-text">readyHandlers</code>，它其实也是通过 <code class="language-text">useCallbacks()</code> 初始化的类似路由守卫的东西。</li>
</ul>
<h4>triggerAfterEach — 处理后置守卫</h4>
<p>触发后置守卫，它的代码很简单，调用每一个注册的后置守卫。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>
  to<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  from<span class="token operator">:</span> RouteLocationNormalizedLoaded<span class="token punctuation">,</span>
  failure<span class="token operator">?</span><span class="token operator">:</span> NavigationFailure <span class="token operator">|</span> <span class="token keyword">void</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取所有注册的后置守卫，依次执行它们</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> afterGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h3>router-view 和 router-link</h3>
<p><code class="language-text">vue-router</code>封装了两个组件来供我们使用，下面我们一起来探究一下。</p>
<h4>router-view</h4>
<p><code class="language-text">router-view</code> 显示与<code class="language-text">url</code>对应的组件。也就是说，不同的路由将被渲染在这里。</p>
<div class="gatsby-highlight" data-language="html"><pre class="language-html"><code class="language-html"><span class="token comment">&lt;!-- 当前路由对应的组件将被渲染在这里 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>app<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>来看看它的源码，主要关注 <code class="language-text">setup</code> 部分：</p>
<p>首先，通过 <code class="language-text">inject</code> API 拿到当前路由 <code class="language-text">injectedRoute</code>，这个是由全局 <code class="language-text">app</code> 通过执行 <code class="language-text">provide</code> 得到的（上面已经提及）：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 拿到当前路由</span>
<span class="token keyword">const</span> injectedRoute <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">)</span><span class="token operator">!</span></code></pre></div>
<p>之后，routerToDisplay 决定了要渲染的路由，如果 <code class="language-text">props.route</code> 有值，则渲染它，否则渲染我们上面提到的 <code class="language-text">injectedRoute</code>：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> routeToDisplay <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> props<span class="token punctuation">.</span>route <span class="token operator">||</span> injectedRoute<span class="token punctuation">.</span>value<span class="token punctuation">)</span></code></pre></div>
<p>注意这里的 <code class="language-text">routeToDisplay = computed()</code> 可以获得一个不可变的响应式对象，也就是说，一旦 <code class="language-text">injectedRoute.value</code> 或者 <code class="language-text">props.route</code> 更新，<code class="language-text">routeToDisplay</code>
的 <code class="language-text">value</code> 也会变化。</p>
<p>接下来，我们从 <code class="language-text">routeToDisplay</code> 拿到匹配到的路由：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> matchedRouteRef <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span>RouteLocationMatched <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> routeToDisplay<span class="token punctuation">.</span>value<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>depth<span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">depth</code>是用来辅助处理嵌套路由的，下面来解释一下这个<code class="language-text">depth</code>，当我们跳转路由时，<code class="language-text">vue-router</code>会根据跳转的路径去匹配相应的<code class="language-text">matcher</code>对象(上面提过)。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> matchedRoute <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span> path<span class="token operator">:</span> locationNormalized<span class="token punctuation">.</span>path <span class="token punctuation">}</span><span class="token punctuation">,</span>
  currentLocation
<span class="token punctuation">)</span></code></pre></div>
<p>我们看 matcher 的<code class="language-text">resolve</code>方法(只列出匹配部分)</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">matcher <span class="token operator">=</span> matchers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>m <span class="token operator">=></span> m<span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> matched<span class="token operator">:</span> MatcherLocation<span class="token punctuation">[</span><span class="token string">"matched"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">let</span> parentMatcher<span class="token operator">:</span> RouteRecordMatcher <span class="token operator">|</span> <span class="token keyword">undefined</span> <span class="token operator">=</span> matcher
<span class="token keyword">while</span> <span class="token punctuation">(</span>parentMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// reversed order so parents are at the beginning</span>
  <span class="token comment">// 关键在这里，会将父级的matcher对象也推进到matched数组中。</span>
  matched<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>parentMatcher<span class="token punctuation">.</span>record<span class="token punctuation">)</span>
  parentMatcher <span class="token operator">=</span> parentMatcher<span class="token punctuation">.</span>parent
<span class="token punctuation">}</span></code></pre></div>
<p>然后我们结合着官方文档就很好理解了。
<a href="https://router.vuejs.org/zh/guide/essentials/nested-routes.html">嵌套路由</a></p>
<p>我以<code class="language-text">playground</code>中的例子来示范：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts">routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">"/children"</span><span class="token punctuation">,</span> <span class="token comment">// 组件1</span>
    name<span class="token operator">:</span> <span class="token string">"WithChildren"</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Nested<span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> alias<span class="token operator">:</span> <span class="token string">"alias"</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"default-child"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Nested <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"a"</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">"a-child"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Nested <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token comment">// 组件2</span>
        name<span class="token operator">:</span> <span class="token string">"b-child"</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> Nested<span class="token punctuation">,</span>
        children<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Nested <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 组件3</span>
          <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"a2"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Nested <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">"b2"</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Nested <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span></code></pre></div>
<p>当我们进入<code class="language-text">/children/b</code>时，会匹配到组件 1，组件 2 和组件 3 三个所对应 matcher 对象，也就是说，顶层 <code class="language-text">router-view</code> 渲染 <code class="language-text">/children</code> 下的内容，第二层渲染 <code class="language-text">/children/b</code> 下的内容，第三层渲染 <code class="language-text">/children/b</code> 下的内容（注意和第二层的区别，这个是第二层孩子的默认值，在路由 url 层面下体现为 <code class="language-text">/children/b</code> 加上空字符串）。</p>
<p>调试看看匹配的<code class="language-text">matcher</code>对象:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/156a54b5eb7788439fdd42ead8bcc547/58fee/Snipaste_2022-03-19_21-01-42.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 28.48101265822785%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAABJNAAASTQHzl8SnAAAArklEQVQY05XMwW7DMAgGYL//C+4yqYd0jZYlNmADBjvOtLRVDzv1Ewd+kP4Qt239WVMC730320Wau7m31sy82rm7F+19HHfjKZRU4ndCgJrAVZSLqjKLqhpRhaTCqop/ZzOr5j7GoyZ468tl0nnWrxvHiEQ5Z0AiygLA20pEpRQEQCRAVK3HUxC27eNTpqv2bvX1GGf/fc54/BdghnhdhHBv7XhTkMwFiSFxzuNNv+lKXjgj1nWrAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="Snipaste 2022 03 19 21 01 42"
        title="Snipaste 2022 03 19 21 01 42"
        src="/static/156a54b5eb7788439fdd42ead8bcc547/f058b/Snipaste_2022-03-19_21-01-42.png"
        srcset="/static/156a54b5eb7788439fdd42ead8bcc547/c26ae/Snipaste_2022-03-19_21-01-42.png 158w,
/static/156a54b5eb7788439fdd42ead8bcc547/6bdcf/Snipaste_2022-03-19_21-01-42.png 315w,
/static/156a54b5eb7788439fdd42ead8bcc547/f058b/Snipaste_2022-03-19_21-01-42.png 630w,
/static/156a54b5eb7788439fdd42ead8bcc547/40601/Snipaste_2022-03-19_21-01-42.png 945w,
/static/156a54b5eb7788439fdd42ead8bcc547/58fee/Snipaste_2022-03-19_21-01-42.png 1051w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>这样通过判断当前深度就可以正确匹配路由了，这也顺便解释了上面 <code class="language-text">depth</code> 的意义。</p>
<p>回到主线，在获取匹配到的路由之后，我们将一些必要的信息通过 <code class="language-text">provide</code> 交给未来的孩子组件：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token comment">// 孩子得到的深度就是当前的深度加一，结合上面的内容不难理解</span>
<span class="token function">provide</span><span class="token punctuation">(</span>viewDepthKey<span class="token punctuation">,</span> depth <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// 匹配到的路由</span>
<span class="token function">provide</span><span class="token punctuation">(</span>matchedRouteKey<span class="token punctuation">,</span> matchedRouteRef<span class="token punctuation">)</span>
<span class="token comment">// 当前路径</span>
<span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> routeToDisplay<span class="token punctuation">)</span></code></pre></div>
<p>最后返回一个渲染函数，结合注释来感受下过程，省略一些边界条件的代码，只保留主干部分：</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// 当前路由对象</span>
  <span class="token keyword">const</span> route <span class="token operator">=</span> routeToDisplay<span class="token punctuation">.</span>value
  <span class="token comment">// 匹配到的路由matcher</span>
  <span class="token keyword">const</span> matchedRoute <span class="token operator">=</span> matchedRouteRef<span class="token punctuation">.</span>value
  <span class="token comment">// 匹配到的组件，将被渲染</span>
  <span class="token keyword">const</span> ViewComponent <span class="token operator">=</span> matchedRoute <span class="token operator">&amp;&amp;</span> matchedRoute<span class="token punctuation">.</span>components<span class="token punctuation">[</span>props<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
  <span class="token comment">// 当前组件名称</span>
  <span class="token keyword">const</span> currentName <span class="token operator">=</span> props<span class="token punctuation">.</span>name
  <span class="token comment">// 这里就是实现路由组件传参功能，可查阅文档</span>
  <span class="token keyword">const</span> routePropsOption <span class="token operator">=</span> matchedRoute<span class="token operator">!</span><span class="token punctuation">.</span>props<span class="token punctuation">[</span>props<span class="token punctuation">.</span>name<span class="token punctuation">]</span>
  <span class="token keyword">const</span> routeProps <span class="token operator">=</span> routePropsOption
    <span class="token operator">?</span> routePropsOption <span class="token operator">===</span> <span class="token boolean">true</span>
      <span class="token operator">?</span> route<span class="token punctuation">.</span>params
      <span class="token operator">:</span> <span class="token keyword">typeof</span> routePropsOption <span class="token operator">===</span> <span class="token string">"function"</span>
      <span class="token operator">?</span> <span class="token function">routePropsOption</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span>
      <span class="token operator">:</span> routePropsOption
    <span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token comment">// 调用 vue 的 h API，这个 API 的功能是生成 v-node，第一个参数为 vue组件，第二个参数为 props</span>
  <span class="token keyword">const</span> component <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span>
    ViewComponent<span class="token punctuation">,</span>
    <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> routeProps<span class="token punctuation">,</span> attrs<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      onVnodeUnmounted<span class="token punctuation">,</span>
      ref<span class="token operator">:</span> viewRef<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 返回 被渲染的组件的 v-node</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">// ....</span>
    component
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h4>router-link</h4>
<p>我们使用自定义组件 <code class="language-text">router-link</code> 而不是使用常规标签 <code class="language-text">&lt;a></code> 来创建链接。</p>
<p>这样我们可以更改 URL 而无需重新加载页面。</p>
<div class="gatsby-highlight" data-language="ts"><pre class="language-ts"><code class="language-ts"><span class="token keyword">export</span> <span class="token keyword">const</span> RouterLinkImpl <span class="token operator">=</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 省略 props</span>
  <span class="token function">setup</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> <span class="token punctuation">{</span> slots<span class="token punctuation">,</span> attrs <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> link <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token function">useLink</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token operator">!</span>
    <span class="token comment">// 处理元素的类名</span>
    <span class="token keyword">const</span> elClass <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token function">getLinkClass</span><span class="token punctuation">(</span>
        props<span class="token punctuation">.</span>activeClass<span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>linkActiveClass<span class="token punctuation">,</span>
        <span class="token string">"router-link-active"</span>
      <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isActive<span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token function">getLinkClass</span><span class="token punctuation">(</span>
        props<span class="token punctuation">.</span>exactActiveClass<span class="token punctuation">,</span>
        options<span class="token punctuation">.</span>linkExactActiveClass<span class="token punctuation">,</span>
        <span class="token string">"router-link-exact-active"</span>
      <span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isExactActive<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 返回生成 v-dom 的函数</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 拿到 slot 中的内容</span>
      <span class="token keyword">const</span> children <span class="token operator">=</span> slots<span class="token punctuation">.</span>default <span class="token operator">&amp;&amp;</span> slots<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span>
      <span class="token comment">// 在 非 custom 模式下，我们会在其外围包裹一个 a 标签，这些也通过 h API 来实现</span>
      <span class="token keyword">return</span> props<span class="token punctuation">.</span>custom
        <span class="token operator">?</span> children
        <span class="token operator">:</span> <span class="token function">h</span><span class="token punctuation">(</span>
            <span class="token string">"a"</span><span class="token punctuation">,</span>
            <span class="token function">assign</span><span class="token punctuation">(</span>
              <span class="token punctuation">{</span>
                <span class="token string">"aria-current"</span><span class="token operator">:</span> link<span class="token punctuation">.</span>isExactActive
                  <span class="token operator">?</span> props<span class="token punctuation">.</span>ariaCurrentValue
                  <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                onClick<span class="token operator">:</span> link<span class="token punctuation">.</span>navigate<span class="token punctuation">,</span>
                href<span class="token operator">:</span> link<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
              attrs<span class="token punctuation">,</span>
              <span class="token punctuation">{</span>
                <span class="token keyword">class</span><span class="token operator">:</span> elClass<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
            children
          <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">router-link</code> 通过一个<strong>作用域插槽</strong>暴露底层的定制能力：</p>
<div class="gatsby-highlight" data-language="vue"><pre class="language-vue"><code class="language-vue">&lt;!-- 案例来自 vue-router 官网--&gt;
&lt;router-link
  to=&quot;/about&quot;
  v-slot=&quot;{ href, route, navigate, isActive, isExactActive }&quot;
&gt;
&lt;NavLink :active=&quot;isActive&quot; :href=&quot;href&quot; @click=&quot;navigate&quot;&gt;{{ route.fullPath }}
&lt;/NavLink&gt;
&lt;/router-link&gt;</code></pre></div>
<p>这五个 API 通过 <code class="language-text">useLink()</code> 来实现，来看源码：</p>
<p>route 是目标路由，也就是我们点击 <code class="language-text">router-link</code> 导向的位置，它通过拿到用户传入的 <code class="language-text">to</code> 属性，解析成 <code class="language-text">url</code>：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> route <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> router<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></div>
<p>href 是解析后的 url，相当于 a 元素的 href 属性，从源码中看出它来自 <code class="language-text">route.value.href</code>：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript">href<span class="token operator">:</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>href<span class="token punctuation">)</span></code></pre></div>
<p><code class="language-text">isActive</code> 表示当前 <code class="language-text">router-link</code> 是否处于 “激活状态”，来看下面的代码：</p>
<p><code class="language-text">activeRecordIndex</code> 记录了匹配当前路由、且处于活跃状态组件的下标。 有了活跃项目下标还不够，我们还要通过 <code class="language-text">includesParams()</code> 来处理动态路由，可以看出是通过<strong>逐一比较 <code class="language-text">params</code> 来实现</strong>的：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> isActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">includesParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">includesParams</span><span class="token punctuation">(</span>
  outer<span class="token operator">:</span> RouteLocation<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  inner<span class="token operator">:</span> RouteLocation<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token comment">// 遍历 keys</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> inner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> innerValue <span class="token operator">=</span> inner<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">let</span> outerValue <span class="token operator">=</span> outer<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> innerValue <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>innerValue <span class="token operator">!==</span> outerValue<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 对数组处理利用了 `Array.prototype.some()`</span>
      <span class="token comment">// some() 方法测试数组中是不是至少有 1 个元素通过了被提供的函数测试。</span>
      <span class="token comment">// 它返回的是一个 Boolean 类型的值。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span><span class="token builtin">Array</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>outerValue<span class="token punctuation">)</span> <span class="token operator">||</span>
        outerValue<span class="token punctuation">.</span>length <span class="token operator">!==</span> innerValue<span class="token punctuation">.</span>length <span class="token operator">||</span>
        innerValue<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> value <span class="token operator">!==</span> outerValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<p>可以看出这里的激活状态是一个<strong>浅层</strong>的活跃状态，例如，子组件对应的 <code class="language-text">router-link</code> 如果是激活状态，那么其父路径对应的 <code class="language-text">router-link</code> 也处于激活状态。</p>
<p><code class="language-text">isExactActive</code> 则是一个严格比较，他要求当前路由和这个组件<strong>完全匹配</strong>，也就是说，当前路由必须和匹配路由的<strong>最后一个</strong>相同，即所有的父级路由全被排除在外：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> isExactActive <span class="token operator">=</span> <span class="token generic-function"><span class="token function">computed</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    activeRecordIndex<span class="token punctuation">.</span>value <span class="token operator">===</span> currentRoute<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">.</span>params<span class="token punctuation">,</span> route<span class="token punctuation">.</span>value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">)</span></code></pre></div>
<p>另外，上面对 <code class="language-text">params</code> 的对比是一个 <strong>浅层的对比</strong>，而在这里则是一个深层的比较（使用递归的方式）：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>
  a<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> RouteLocationNormalized<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameRouteLocationParamsValue</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span></code></pre></div>
<p>最后一个 <code class="language-text">navigate</code>，是一个执行路由跳转的方法，本质上是调用了上面说到的 <code class="language-text">router.replace</code> 或者 <code class="language-text">router.push</code>：</p>
<div class="gatsby-highlight" data-language="typescript"><pre class="language-typescript"><code class="language-typescript"><span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span>
  e<span class="token operator">:</span> MouseEvent <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token keyword">as</span> MouseEvent
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span> <span class="token operator">|</span> NavigationFailure<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">guardEvent</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> router<span class="token punctuation">[</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>replace<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"replace"</span> <span class="token operator">:</span> <span class="token string">"push"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token function">unref</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></div>
<h2>参考资料</h2>
<table>
<thead>
<tr>
<th>标题</th>
<th>来源</th>
</tr>
</thead>
<tbody>
<tr>
<td>vue-router-next 仓库</td>
<td><a href="https://github.com/vuejs/vue-router-next">https://github.com/vuejs/vue-router-next</a></td>
</tr>
<tr>
<td>vue-router-next 文档</td>
<td><a href="https://router.vuejs.org">https://router.vuejs.org</a></td>
</tr>
<tr>
<td>vue-next 文档</td>
<td><a href="https://v3.vuejs.org/">https://v3.vuejs.org/</a></td>
</tr>
<tr>
<td>MDN</td>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/some">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/some</a></td>
</tr>
<tr>
<td>MDN</td>
<td><a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event">https://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event</a></td>
</tr>
</tbody>
</table></section></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/2022-03/axios源码学习/">← <!-- -->Axios源码解析</a></li><li></li></ul></nav></main><footer><div class="header__line"></div><div class="footer__content" style="color:#005b99"><span>© <!-- -->2022<!-- --> Hao Chen, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></span><a href="mailto:hey@haochen.me">email:<!-- -->hey@haochen.me</a></div></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-219535421-1', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/2022-03/vue-router/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-191f3dbf297fa5585e37.js"],"app":["/app-238c6157f3f7e8e47f62.js"],"component---src-pages-404-js":["/component---src-pages-404-js-b2fce7c37e9d27f40b01.js"],"component---src-pages-about-js":["/component---src-pages-about-js-6be42dad5916dff017d0.js"],"component---src-pages-coding-365-js":["/component---src-pages-coding-365-js-a617b2ce6b9c7a71555e.js"],"component---src-pages-index-js":["/component---src-pages-index-js-16bf282d32cd576016ae.js"],"component---src-pages-resource-js":["/component---src-pages-resource-js-afdf57295a9a7336a0b8.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-fbaf4be8d7a8837294bb.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-220d8521917836d187f1.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-a83ea2277426bf4b8caf.js"],"component---src-templates-tag-js":["/component---src-templates-tag-js-f5a2b323892302bc08d9.js"]};/*]]>*/</script><script src="/polyfill-191f3dbf297fa5585e37.js" nomodule=""></script><script src="/component---src-templates-blog-post-js-a83ea2277426bf4b8caf.js" async=""></script><script src="/commons-d7f496c7033f1b2ecf65.js" async=""></script><script src="/app-238c6157f3f7e8e47f62.js" async=""></script><script src="/framework-507a82f8a4d219d3f184.js" async=""></script><script src="/webpack-runtime-c645914f0629fa7d77c6.js" async=""></script></body></html>