{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-03/axios源码学习/","result":{"data":{"site":{"siteMetadata":{"title":"好成的blog"}},"markdownRemark":{"id":"bef513ae-52dc-5d89-93d3-1948076dec32","excerpt":"简介  是一个的网络请求库，基于  封装了 HTTP 请求，用于浏览器和node.js，GitHub 91000+\r\nStar（截至 2022 年 3 月 1 日），是前端必备的一个第三方库。 Axios 的代码不算复杂，反而清晰易懂、十分优雅（个人觉得特别是请求/响应拦截器的处理和 cancelToken…","html":"<h2>简介</h2>\n<p><code class=\"language-text\">Axios</code> 是一个的<strong>网络请求库</strong>，基于 <code class=\"language-text\">Promise</code> 封装了 HTTP 请求，用于<strong>浏览器</strong>和<strong>node.js</strong>，GitHub <strong>91000+</strong>\r\nStar（截至 2022 年 3 月 1 日），是前端必备的一个第三方库。</p>\n<p>Axios 的代码<strong>不算复杂</strong>，反而<strong>清晰易懂</strong>、十分优雅（个人觉得特别是请求/响应拦截器的处理和 cancelToken 的处理），另外它涉及了很多 JavaScript 的基础知识，非常适合用来巩固基础。</p>\n<p>本文在讲核心源码的同时也会穿插一些涉及前端的知识。</p>\n<p>本文使用的 axios 版本: <strong>v0.26.0</strong>。</p>\n<h2>项目结构</h2>\n<p>axios 的项目结构如下，省略了和本文无关的目录或文件和细节目录。它的源代码在 <code class=\"language-text\">lib</code> 下：</p>\n<div class=\"gatsby-highlight\" data-language=\"plain\"><pre class=\"language-plain\"><code class=\"language-plain\">axios\r\n├─ lib                                                             // 项目源码目录\r\n│  ├─ adapters                                                     // 请求适配器\r\n│  │  ├─ http.js                                                   // http适配器\r\n│  │  └─ xhr.js                                                    // xhr适配器\r\n│  ├─ axios.js                                                     // axios的实例\r\n│  ├─ cancel                                                       // 请求取消模块\r\n│  ├─ core                                                         // 核心模块\r\n│  │  ├─ Axios.js                                                  // Axios对象\r\n│  │  ├─ buildFullPath.js                                          // url构建\r\n│  │  ├─ createError.js                                            // 自定义异常相关\r\n│  │  ├─ dispatchRequest.js                                        // 请求封装\r\n│  │  ├─ enhanceError.js                                           // 自定义异常相关\r\n│  │  ├─ InterceptorManager.js                                     // 拦截器类\r\n│  │  ├─ mergeConfig.js                                            // 配置合并工具\r\n│  │  ├─ settle.js                                                 // promise处理工具\r\n│  │  └─ transformData.js                                          // 数据转换工具\r\n│  ├─ defaults.js                                                  // 默认配置\r\n│  ├─ helpers                                                      // 各种工具函数\r\n│  └─ utils.js</code></pre></div>\n<h2>基本流程</h2>\n<p>Axios 的<strong>一次基本流程</strong>如下：</p>\n<ul>\n<li>初始化 axios 实例（包括配置处理、拦截器等）</li>\n<li>执行请求拦截器</li>\n<li>根据当前环境选择合适的网络适配器(adapter)（xhr — 浏览器， http request — node.js），并执行之（发送请求）</li>\n<li>处理响应数据</li>\n<li>执行响应拦截器</li>\n<li>请求完成，调用者可获取响应数据</li>\n</ul>\n<h2>实例 (instance) 的导入</h2>\n<p>执行下面的代码，我们创建了一个 <strong>axios 实例</strong>，我们接下来按照代码顺序来阐述整个执行过程。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"../../lib/axios\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>模块的代码如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 创建一个Axios实例</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">defaultConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> context <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">(</span>defaultConfig<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 将axios.prototype复制到实例（继承）</span>\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 将上下文复制到实例（继承）</span>\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> instance\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// 创建要导出的默认实例</span>\r\n<span class=\"token keyword\">var</span> axios <span class=\"token operator\">=</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>defaults<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// 公开Axios类以允许类继承</span>\r\naxios<span class=\"token punctuation\">.</span>Axios <span class=\"token operator\">=</span> Axios\r\n\r\n<span class=\"token comment\">// 用于创建新实例的工厂</span>\r\naxios<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">create</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instanceConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token function\">mergeConfig</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">,</span> instanceConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// Expose Cancel &amp; CancelToken</span>\r\naxios<span class=\"token punctuation\">.</span>Cancel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./cancel/Cancel\"</span><span class=\"token punctuation\">)</span>\r\naxios<span class=\"token punctuation\">.</span>CancelToken <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./cancel/CancelToken\"</span><span class=\"token punctuation\">)</span>\r\naxios<span class=\"token punctuation\">.</span>isCancel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./cancel/isCancel\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// Expose all/spread</span>\r\naxios<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">all</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promises</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>promises<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\naxios<span class=\"token punctuation\">.</span>spread <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./helpers/spread\"</span><span class=\"token punctuation\">)</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> axios\r\n\r\n<span class=\"token comment\">// Allow use of default import syntax in TypeScript</span>\r\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span>default <span class=\"token operator\">=</span> axios</code></pre></div>\n<h3>createInstance() - 创建实例</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">defaultConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> context <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">(</span>defaultConfig<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">var</span> instance <span class=\"token operator\">=</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 将axios.prototype复制到实例（继承）</span>\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 将上下文复制到实例（继承）</span>\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">extend</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> context<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> instance\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>见名知义，<code class=\"language-text\">createInstance</code> 便是创建实例的核心函数了，它返回了 <code class=\"language-text\">instance</code> 这个变量，内部通过 <code class=\"language-text\">extend</code>、<code class=\"language-text\">bind</code> 这两个工具来进行加工。</p>\n<h3>instance 的扩展</h3>\n<p>第二行：<code class=\"language-text\">var instance = bind(Axios.prototype.request, context);</code>, 这里的<code class=\"language-text\">bind</code>函数如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">\"use strict\"</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> thisArg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> args<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      args<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>thisArg<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">bind()</code>最终返回一个<code class=\"language-text\">function</code>，这个<code class=\"language-text\">function</code>的作用：以<code class=\"language-text\">thisArg</code>为函数调用上下文(this)，调用<code class=\"language-text\">fn</code>。</p>\n<p>最终，<code class=\"language-text\">instance</code>变成了一个函数，即<code class=\"language-text\">Axios.prototype.request</code>，函数调用上下文(this)为<code class=\"language-text\">context</code>, 也就是<code class=\"language-text\">new Axios(defaultConfig)</code>,\r\n它来自在前一行新建的一个 axios 对象。</p>\n<div class=\"gatsby-highlight\" data-language=\"plain\"><pre class=\"language-plain\"><code class=\"language-plain\">关于 apply()\r\n\r\n给函数传参，并拥有控制函数调用上下文即函数体内 this 值的能力 ，在上面的例子中，函数的 this 为 thisArg，参数为 args（一个数组），它通过一个简单的循环遍历得到。\r\n\r\n类似的，ECMAScript 中的函数还有一个方法：**call()**，只不过`call()`的参数需要一个一个列出来。</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"plain\"><pre class=\"language-plain\"><code class=\"language-plain\">关于 arguments\r\n\r\n函数内部存在的一个特殊对象，它是一个**类数组对象**，包含调用函数时传入的所有参数。这个对象只有以 function 关键字定义函数（相对于使用箭头语法创建函数）时才会有。\r\n\r\n在上面代码出现的`arguments`是`wrap()`函数的参数。</code></pre></div>\n<p>值得注意的是，虽然在 ECMAScript5 中已经内置了这个方法：<code class=\"language-text\">Function.prototype.bind()</code>, 但由于兼容性问题（<strong>iE9+</strong>），不直接使用。</p>\n<h4>utils.extend() - 实例的复制</h4>\n<p><code class=\"language-text\">utils.extend()</code> 也是一个工具函数，内容如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\r\n * 通过可变地添加对象b的属性来扩展对象a。\r\n *\r\n * @param {Object} a 要扩展的对象\r\n * @param {Object} b 要复制属性的对象\r\n * @param {Object} thisArg 要绑定功能的对象\r\n * @return {Object} 对象a的结果值\r\n */</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">extend</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> thisArg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">assignValue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thisArg <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> val <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      a<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">,</span> thisArg<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      a<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> val\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> a\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>里面又出现了一个 <code class=\"language-text\">foreach()</code>，内容如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj<span class=\"token punctuation\">,</span> fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// Don't bother if no value provided</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> obj <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// Force an array if not already something iterable</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> obj <span class=\"token operator\">!==</span> <span class=\"token string\">\"object\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">/*eslint no-param-reassign:0*/</span>\r\n    obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>obj<span class=\"token punctuation\">]</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// Iterate over array values</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// Iterate over object keys</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> key <span class=\"token keyword\">in</span> obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们自上而下解读:</p>\n<ul>\n<li>特殊情况的判断，<code class=\"language-text\">obj</code> 为空，或者 <code class=\"language-text\">obj</code> 为 <code class=\"language-text\">undefined</code>，我们不处理，直接 <code class=\"language-text\">return</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>obj <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> obj <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>对于<strong>不可迭代的对象</strong>，我们<strong>强制转换</strong>成一个<code class=\"language-text\">array</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> obj <span class=\"token operator\">!==</span> <span class=\"token string\">\"object\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>obj<span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>对于可迭代的<strong>数组</strong>，我们执行 <code class=\"language-text\">fn</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"plain\"><pre class=\"language-plain\"><code class=\"language-plain\">for (var i = 0, l = obj.length; i &lt; l; i++) {\r\n   fn.call(null, obj[i], i, obj);\r\n}</code></pre></div>\n<ul>\n<li>对于可迭代的<strong>对象</strong>，也是差不多的思路。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> key <span class=\"token keyword\">in</span> obj<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function\">hasOwnProperty</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>综上所述，<code class=\"language-text\">foreach</code> 遍历一个（可迭代的）数组或一个对象，为每个项<strong>执行传入的函数</strong>。</p>\n<p>回到我们的 <code class=\"language-text\">extend()</code>，看看我们传入的函数 <code class=\"language-text\">assignValue</code>，这个函数的作用便是在<strong>迭代 b 的过程</strong>中<strong>为 a 赋值</strong>。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">extend</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> thisArg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">assignValue</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 对于函数，利用了上面说到的bind()</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>thisArg <span class=\"token operator\">&amp;&amp;</span> <span class=\"token keyword\">typeof</span> val <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      a<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">,</span> thisArg<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      a<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> val\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> a\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>所以最终我们的 <code class=\"language-text\">instance</code> 被如何扩展？很明显：</p>\n<ul>\n<li>第一个 <code class=\"language-text\">extend</code> 扩展了 <code class=\"language-text\">Axios.prototype</code>, 即 Axios 对象的原型。</li>\n<li>第二个 <code class=\"language-text\">extend</code> 扩展了 <code class=\"language-text\">context</code>, 即 <strong>Axios 对象</strong>，这个对象含有用户传入的一系列配置信息（这个对象的详细内容会在下面详细说明）。</li>\n</ul>\n<p>这里有一个小问题，为什么我们在生成实例的时候不直接生成 <code class=\"language-text\">Axios</code> 对象，而是先以<code class=\"language-text\">Axios.prototype.request</code>为基础，然后基于上面说到的两部分进行扩展呢？个人认为是<strong>方便调用者调用，不用额外再手动新建对象</strong>。</p>\n<h3>其他扩展</h3>\n<p>在 axios 实例被 <code class=\"language-text\">export</code> 前，它被添加了几个静态方法。</p>\n<h4>axios.create — 创建新实例的工厂</h4>\n<p><code class=\"language-text\">axios.create</code> 给用户提供了自定义配置的接口，通过调用 <code class=\"language-text\">mergeConfig()</code> 来合并用户配置和默认配置。从而我们可以得到一个自定义的 <code class=\"language-text\">instance</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">axios<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">create</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instanceConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token function\">mergeConfig</span><span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">,</span> instanceConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>axios.all — 同时执行多个请求</h4>\n<p>如果你了解过 <code class=\"language-text\">Promise.all()</code>, 那么你一定可以猜出 <code class=\"language-text\">axios.all</code> 是个啥了。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">axios<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">all</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">promises</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>promises<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>axios.spread — 用于调用函数并扩展参数数组的语法糖</h4>\n<p><code class=\"language-text\">axios.spread</code> 常和 <code class=\"language-text\">axios.all</code> 配合使用，例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getUserAccount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user/12345\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">getUserPermissions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/user/12345/permissions\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\naxios<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">getUserAccount</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getUserPermissions</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\r\n  axios<span class=\"token punctuation\">.</span><span class=\"token function\">spread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">acct<span class=\"token punctuation\">,</span> perms</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 两个请求现在都执行完成</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>我们来看看 <code class=\"language-text\">axios.spread()</code> 的实现:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">\"use strict\"</span>\r\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">spread</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">wrap</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arr</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> arr<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">axios.spread()</code> 要求我们传入一个函数，最终 <code class=\"language-text\">promise.all()</code> 的结果会作为它的参数，并通过 <code class=\"language-text\">callback.apply()</code> 执行。</p>\n<h4>axios.Cancel — 支持主动取消请求</h4>\n<p>这个功能非常有意思，用户可以调用这个接口来随时<strong>取消请求</strong>，像这样：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> CancelToken <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span>CancelToken\r\n<span class=\"token keyword\">const</span> source <span class=\"token operator\">=</span> CancelToken<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n\r\naxios\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxxxxxxxx\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n    cancelToken<span class=\"token operator\">:</span> source<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">thrown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span><span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span>thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request canceled\"</span><span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 处理错误</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\nsource<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"请求被用户取消!\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">CancelToken.source()</code> 是一个工厂方法，它生产了一个对象，包含 <code class=\"language-text\">CancelToken()</code> 和一个默认的 <code class=\"language-text\">cancel()</code>，于是调用者就可以用下面的方法注册<code class=\"language-text\">CancelToken()</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 方法1 - 默认的工厂方法</span>\r\n<span class=\"token keyword\">const</span> CancelToken <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span>CancelToken\r\n<span class=\"token keyword\">const</span> source <span class=\"token operator\">=</span> CancelToken<span class=\"token punctuation\">.</span><span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\naxios\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxxxxxxxxxxx\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n    cancelToken<span class=\"token operator\">:</span> source<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">thrown</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>axios<span class=\"token punctuation\">.</span><span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span>thrown<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request canceled\"</span><span class=\"token punctuation\">,</span> thrown<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 处理错误</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// 方法2 - 自定义cancel</span>\r\n<span class=\"token keyword\">let</span> cancel\r\naxios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"xxxxxxxxxxxx\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n  cancelToken<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CancelToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// executor 函数接收一个 cancel 函数作为参数</span>\r\n    cancel <span class=\"token operator\">=</span> c\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// 取消请求</span>\r\nsource<span class=\"token punctuation\">.</span><span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Operation canceled by the user.\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token comment\">// 或者</span>\r\n<span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>调用者通过执行 <code class=\"language-text\">source.cancel()</code>,来<strong>取消请求</strong>，（用户可传入一个字符串，表示取消的 <code class=\"language-text\">message</code>）</li>\n</ul>\n<p>下面我们看看它的内部实现。</p>\n<h5>Cancel 对象 — 在取消操作时抛出</h5>\n<p>Cancel 对象的构造很简单，它要求用户传入一个可选 message。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Cancel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">=</span> message\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token class-name\">Cancel</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">toString</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token string\">\"Cancel\"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">?</span> <span class=\"token string\">\": \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token class-name\">Cancel</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>__CANCEL__ <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> Cancel</code></pre></div>\n<ul>\n<li>\n<p>当 Cancel<strong>被执行</strong>时，表明我们的 Cancel 被初始化，我们将 <code class=\"language-text\">Cancel.prototype.__CANCEL__</code> 置为 true，表示<strong>已经被 Cancel</strong></p>\n</li>\n<li>\n<p>在请求失败时（假设用户<strong>主动 Cancel</strong>），那么我们最终通过获取的请求对象来判断是否为用户主动取消(也就是错误对象是不是 Cancel 对象)，axios 为我们提供了下面这个方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//判断请求失败时的错误对象是不是Cancel对象</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">&amp;&amp;</span> value<span class=\"token punctuation\">.</span>__CANCEL__<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>利用之前的 <code class=\"language-text\">Cancel.prototype.__CANCEL__</code>，我们可以判断是不是用户主动取消。</p>\n</li>\n</ul>\n<h5>CancelToken — 请求取消操作的对象</h5>\n<p><code class=\"language-text\">CancelToken</code> 是一个可用于请求取消操作的对象，它传入一个 <code class=\"language-text\">executor</code>,下面是它的代码, 一些解释我以代码注释的方式给出。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token string\">\"use strict\"</span>\r\n\r\n<span class=\"token keyword\">var</span> Cancel <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./Cancel\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// CancelToken构造函数，CancelToken是一个请求取消操作的对象</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">CancelToken</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">executor</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">//如果executor不是function，抛出错误</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> executor <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"executor must be a function.\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// 初始化外部的resolvePromise</span>\r\n  <span class=\"token keyword\">var</span> resolvePromise\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>promise <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">promiseExecutor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 让外部的 resolvePromise 指向 resolve</span>\r\n    <span class=\"token comment\">// 这样的话，我们执行 resolvePromise() 就相当于将Promise resolve</span>\r\n    resolvePromise <span class=\"token operator\">=</span> resolve\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// 获取上下文 这里的token即 CancelToken对象</span>\r\n  <span class=\"token keyword\">var</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\r\n\r\n  <span class=\"token comment\">// 当我们的executor()被执行时，我们的resolvePromise的状态也从pending变成了resolved</span>\r\n  <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">cancel</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>reason<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 如果CancelToken对象上已经存在reason，说明已经取消，多余的取消函数将失去作用</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 为cancelToken设置reason（一个Cancel对象）</span>\r\n    token<span class=\"token punctuation\">.</span>reason <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cancel</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 在我们resolve时，触发了adapter的resolve事件。adapter</span>\r\n    <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">.</span>reason<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// 判断请求是否已经被取消，就抛出this.reason, 也就是上面的 Cancel 对象</span>\r\n<span class=\"token class-name\">CancelToken</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">throwIfRequested</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">throwIfRequested</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reason<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>reason\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token comment\">// CancelToken的工厂方法</span>\r\nCancelToken<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">source</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">source</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> cancel\r\n  <span class=\"token keyword\">var</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">CancelToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">executor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    cancel <span class=\"token operator\">=</span> c\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n    token<span class=\"token operator\">:</span> token<span class=\"token punctuation\">,</span>\r\n    cancel<span class=\"token operator\">:</span> cancel<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> CancelToken</code></pre></div>\n<h5>CancelToken 的 Promise</h5>\n<p><code class=\"language-text\">CancelToken</code> 的 <code class=\"language-text\">Promise</code> 在适配器中被<strong>添加处理程序</strong>(即执行 <code class=\"language-text\">Promise.prototype.then()</code> )</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 处理请求取消</span>\r\n  config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">.</span>promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">onCanceled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cancel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>aborted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\r\n    req<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意：</p>\n<p>从<code class=\"language-text\">v0.22.0</code>版本开始，使用<code class=\"language-text\">CancelToken</code>来取消请求的方式已经被<strong>弃用</strong>，而推荐使用一样<code class=\"language-text\">fetch</code>一样的取消方式<code class=\"language-text\">AbortController</code>。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c43faa70ea2ce6bcb8d71386c7edd032/798d4/Snipaste_2022-03-05_15-22-37.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 127.84810126582278%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAABJNAAASTQHzl8SnAAACbElEQVQ4y5WUTW7kOAyFc/9b5AjZGnAtsqgOUHOK7kpV/CeJIkVSP7YbsqszmUF3Jf2ghQ34M4nHRz2cz+emaQ6Hw+l0atv28fGxaZqnp6fj8ei9X9d1WZb1D3oA8C8vL03TnE7/PD8/t217OBzatj0evxHRJ7CIWGtFxIHzCHc+/S2s4zBZ68AgGEIk7z0SehfBZg9ZJIUQiOoJgYkCIpVSKlzKHFNMKeVUcioppViVVCumkmLMqlE3xRi355hz3uGCVjwQgCNkZ9CBcw4AQFXijdpJ/ahlWSrsDIw9oEEayMPW3Ca9qwrP82yNu3yf+gv01+lyvToHKSX9TLfKm0EsrCFwCCwi+gXd4GmahqHvr2AmyxxU9St4hZdlyTmn6nK1PZeUcrxZflcVZua3qu719YwgMCQYY4D8pZCklGkbPxKpJqbEoY63lJJzvh+4h5wLsyASYo0OAHiP4D2At9apxlLmNK+xrGle3x9u8LquOWcAv5E1mjWhQOjrv6x1DrDDcoHSYel8GcIC+i+87J0T0U7WjGzN75Gu8yOS7QW9n0v+2HZm5n3CzEIUuKaflDNjEcwaZt4iwKy0Lcb6y4iaMJUttSKxJj+qynY0xvTfU/enrtCmW0jGiwyd6cehH8au77uLuZ4n8BD/twq/TZhz3ow+2BCmgAaZRfhrCauLYd31h5newPTQd71H/17zTvEdLgg89nZ4xfHMYzeZ0WrQ3cXqH8u9yoTh7XWcRsCR2TBbESeI6BwYY4nCvcr1fsKAhIFJo8YUdfc9xk/artcQouzTYdWgf7HP8zzXfb64cGF+YwH59AJ6h38CurzY/0EvHpEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Snipaste 2022 03 05 15 22 37\"\n        title=\"Snipaste 2022 03 05 15 22 37\"\n        src=\"/static/c43faa70ea2ce6bcb8d71386c7edd032/f058b/Snipaste_2022-03-05_15-22-37.png\"\n        srcset=\"/static/c43faa70ea2ce6bcb8d71386c7edd032/c26ae/Snipaste_2022-03-05_15-22-37.png 158w,\n/static/c43faa70ea2ce6bcb8d71386c7edd032/6bdcf/Snipaste_2022-03-05_15-22-37.png 315w,\n/static/c43faa70ea2ce6bcb8d71386c7edd032/f058b/Snipaste_2022-03-05_15-22-37.png 630w,\n/static/c43faa70ea2ce6bcb8d71386c7edd032/40601/Snipaste_2022-03-05_15-22-37.png 945w,\n/static/c43faa70ea2ce6bcb8d71386c7edd032/798d4/Snipaste_2022-03-05_15-22-37.png 976w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>因为 IE 浏览器并不支持<code class=\"language-text\">AbortController API</code>,<code class=\"language-text\">axios</code>使用了<a href=\"https://github.com/mo/abortcontroller-polyfill\">abortcontroller-polyfill</a>这个库来提供支持。</p>\n<p><code class=\"language-text\">abortcontroller-polyfill</code>的核心源码在<code class=\"language-text\">src/abortcontroller.js</code></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"listeners\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      value<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n      configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// 添加事件监听</span>\r\n  <span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">,</span> options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>type <span class=\"token keyword\">in</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> callback<span class=\"token punctuation\">,</span> options <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// 移除事件监听</span>\r\n  <span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>type <span class=\"token keyword\">in</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">const</span> stack <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> stack<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>stack<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>callback <span class=\"token operator\">===</span> callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        stack<span class=\"token punctuation\">.</span><span class=\"token function\">splice</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">return</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// 派发事件</span>\r\n  <span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>type <span class=\"token keyword\">in</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">const</span> stack <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">[</span>event<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">const</span> stackToCall <span class=\"token operator\">=</span> stack<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> l <span class=\"token operator\">=</span> stackToCall<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> l<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> listener <span class=\"token operator\">=</span> stackToCall<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n        listener<span class=\"token punctuation\">.</span><span class=\"token function\">callback</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">throw</span> e\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">.</span>options <span class=\"token operator\">&amp;&amp;</span> listener<span class=\"token punctuation\">.</span>options<span class=\"token punctuation\">.</span>once<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">.</span>callback<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span>event<span class=\"token punctuation\">.</span>defaultPrevented\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbortSignal</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token comment\">// Some versions of babel does not transpile super() correctly for IE &lt;= 10, if the parent</span>\r\n    <span class=\"token comment\">// constructor has failed to run, then \"this.listeners\" will still be undefined and then we call</span>\r\n    <span class=\"token comment\">// the parent constructor directly instead as a workaround. For general details, see babel bug:</span>\r\n    <span class=\"token comment\">// https://github.com/babel/babel/issues/3041</span>\r\n    <span class=\"token comment\">// This hack was added as a fix for the issue described here:</span>\r\n    <span class=\"token comment\">// https://github.com/Financial-Times/polyfill-library/pull/59#issuecomment-477558042</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>listeners<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">Emitter</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// Compared to assignment, Object.defineProperty makes properties non-enumerable by default and</span>\r\n    <span class=\"token comment\">// we want Object.keys(new AbortController().signal) to be [] for compat with the native impl</span>\r\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"aborted\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      value<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n      writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n      configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"onabort\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      value<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n      writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n      configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"[object AbortSignal]\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">\"abort\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>aborted <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onabort <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">onabort</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AbortController</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// Compared to assignment, Object.defineProperty makes properties non-enumerable by default and</span>\r\n    <span class=\"token comment\">// we want Object.keys(new AbortController()) to be [] for compat with the native impl</span>\r\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"signal\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      value<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">AbortSignal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n      configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> event\r\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n      event <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Event</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abort\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> document <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>document<span class=\"token punctuation\">.</span>createEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">// For Internet Explorer 8:</span>\r\n          event <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createEventObject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n          event<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> <span class=\"token string\">\"abort\"</span>\r\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">// For Internet Explorer 11:</span>\r\n          event <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createEvent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Event\"</span><span class=\"token punctuation\">)</span>\r\n          event<span class=\"token punctuation\">.</span><span class=\"token function\">initEvent</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abort\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// Fallback where document isn't available:</span>\r\n        event <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n          type<span class=\"token operator\">:</span> <span class=\"token string\">\"abort\"</span><span class=\"token punctuation\">,</span>\r\n          bubbles<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n          cancelable<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">.</span><span class=\"token function\">dispatchEvent</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"[object AbortController]\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> AbortController\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> Symbol <span class=\"token operator\">!==</span> <span class=\"token string\">\"undefined\"</span> <span class=\"token operator\">&amp;&amp;</span> Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// These are necessary to make sure that we get correct output for:</span>\r\n  <span class=\"token comment\">// Object.prototype.toString.call(new AbortController())</span>\r\n  <span class=\"token class-name\">AbortController</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"AbortController\"</span>\r\n  <span class=\"token class-name\">AbortSignal</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"AbortSignal\"</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">AbortController</code>实例有一个<code class=\"language-text\">signal</code>属性，它是一个<code class=\"language-text\">AbortSignal</code>类的实例。</p>\n<p>结合<code class=\"language-text\">AbortController</code>的使用流程我们可以知道，当调用<code class=\"language-text\">controller.abort()</code>时，实际上调用了<code class=\"language-text\">AbortSignal</code>的<code class=\"language-text\">dispatchEvent</code>方法并传参为<code class=\"language-text\">abort</code>类型的 Event 对象，而这个方法会判断传入的 Event 对象的类型，如果是<code class=\"language-text\">abort</code>类型，则会执行<code class=\"language-text\">signal</code>对象的<code class=\"language-text\">onabort</code>方法并调用父类的<code class=\"language-text\">dispatchEvent</code>方法。</p>\n<p>而在适配器中，<code class=\"language-text\">axios</code>将<code class=\"language-text\">onCanceled</code>方法加入到<code class=\"language-text\">abort</code>的事件监听器中。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// xhr.js</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">||</span> config<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// Handle cancellation</span>\r\n  <span class=\"token comment\">// eslint-disable-next-line func-names</span>\r\n  <span class=\"token function-variable function\">onCanceled</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cancel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>cancel <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>cancel <span class=\"token operator\">&amp;&amp;</span> cancel<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Cancel</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"canceled\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> cancel<span class=\"token punctuation\">)</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  config<span class=\"token punctuation\">.</span>cancelToken <span class=\"token operator\">&amp;&amp;</span> config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>onCanceled<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 如果已经取消，则直接执行onCanceled方法，否则将onCanceled方法加入到`abort`的事件监听器中</span>\r\n    config<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">.</span>aborted\r\n      <span class=\"token operator\">?</span> <span class=\"token function\">onCanceled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>signal<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"abort\"</span><span class=\"token punctuation\">,</span> onCanceled<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>通过执行 <code class=\"language-text\">XMLHttpRequest.abort()</code>，我们达到了终止请求的目的，在之后我们执行 <code class=\"language-text\">reject</code> 来改变<strong>适配器</strong>的 Promise 的状态。</p>\n<blockquote>\n<p>关于 XMLHttpRequest、适配器会在后文中详细讲到。</p>\n</blockquote>\n<h3>Axios 对象</h3>\n<h4>构造函数</h4>\n<p>这是 Axios 对象的创建过程，代码如下，这里使用<strong>构造函数模式</strong>来创建。挂载了用户传入的配置，基于 <code class=\"language-text\">InterceptorManager()</code> 对象，初始化<strong>请求拦截器</strong>（requestInterceptor）和**\r\n响应拦截器**(\r\nresponseInterceptor)。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\r\n * 创建一个新的Axios实例\r\n *\r\n * @param {Object} instanceConfig The default config for the instance\r\n */</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">Axios</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instanceConfig</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>defaults <span class=\"token operator\">=</span> instanceConfig\r\n\r\n  <span class=\"token comment\">// 初始化拦截器</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptors <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n    request<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    response<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>拦截器（interceptors）</h4>\n<p>axios 一个重大的特性就是可以拦截请求和响应，调用者可以非常简单地使用下面的方法来实现请求/响应拦截。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 引入axios</span>\r\n<span class=\"token comment\">// 添加请求拦截器</span>\r\naxios<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 在发送请求之前做些什么</span>\r\n    <span class=\"token keyword\">return</span> config\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 对请求错误做些什么</span>\r\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// 添加响应拦截器</span>\r\naxios<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 对响应数据做点什么</span>\r\n    <span class=\"token keyword\">return</span> response\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 对响应错误做点什么</span>\r\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>InterceptorManager 对象</h4>\n<p>前面说到，在 Axios 对象创建时，初始化了两个<strong>拦截器</strong>（请求、响应）</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 初始化拦截器</span>\r\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptors <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  request<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n  response<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>InterceptorManage()的代码如下。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">InterceptorManager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">use</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fulfilled<span class=\"token punctuation\">,</span> rejected</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n    fulfilled<span class=\"token operator\">:</span> fulfilled<span class=\"token punctuation\">,</span>\r\n    rejected<span class=\"token operator\">:</span> rejected<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">eject</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">eject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">id</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token class-name\">InterceptorManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">forEach</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handlers<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">forEachHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">h</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>h <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>h<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们可以看到，构造函数初始化了一个 <code class=\"language-text\">handlers</code> 变量，是一个栈。</p>\n<h5>InterceptorManager.prototype.use — 拦截器的注册</h5>\n<p>用户在执行 <code class=\"language-text\">axios.interceptors.request.use(fullfillFunction, rejectFunction)</code> 时，会将用户传入的 <code class=\"language-text\">fullfillFunction</code>, <code class=\"language-text\">rejectFunction</code>\r\n合并成一个对象, 然后<strong>压入 <code class=\"language-text\">handlers</code> 栈中</strong>。</p>\n<p>这个函数返回拦截器栈顶部元素的下标。</p>\n<h5>InterceptorManager.prototype.eject — 拦截器的移除</h5>\n<p>类似的，<code class=\"language-text\">InterceptorManager.prototype.eject(index)</code> 可以用来移除一个拦截函数。</p>\n<h5>InterceptorManager.prototype.forEach — 遍历、过滤拦截器</h5>\n<p>这个方法很重要，它利用我们前面说到的 <code class=\"language-text\">foreach</code> 工具函数来实现拦截器的遍历，同时过滤掉为 <code class=\"language-text\">null</code> 的拦截器项（这些 <code class=\"language-text\">null</code> 项由 <code class=\"language-text\">InterceptorManager.prototype.eject</code> 产生）</p>\n<p>拦截器是如何工作的？我们就需要了解下面这个方法。</p>\n<h4>Axios.prototype.request — 发送请求的核心</h4>\n<p><code class=\"language-text\">Axios.prototype.request</code> 是发送请求的核心部分，它返回一个 <code class=\"language-text\">Promise</code>，内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">request</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">request</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> config <span class=\"token operator\">===</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    config <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n    config<span class=\"token punctuation\">.</span>url <span class=\"token operator\">=</span> arguments<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    config <span class=\"token operator\">=</span> config <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  config <span class=\"token operator\">=</span> <span class=\"token function\">mergeConfig</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// 设置config.method</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    config<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    config<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>defaults<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    config<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> <span class=\"token string\">\"get\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// 连接拦截器中间件</span>\r\n  <span class=\"token keyword\">var</span> chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dispatchRequest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">]</span>\r\n  <span class=\"token comment\">// 实例化一个Promise</span>\r\n  <span class=\"token keyword\">var</span> promise <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">unshiftRequestInterceptors</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token parameter\">interceptor</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    chain<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span>interceptor<span class=\"token punctuation\">.</span>fulfilled<span class=\"token punctuation\">,</span> interceptor<span class=\"token punctuation\">.</span>rejected<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">pushResponseInterceptors</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token parameter\">interceptor</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    chain<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>interceptor<span class=\"token punctuation\">.</span>fulfilled<span class=\"token punctuation\">,</span> interceptor<span class=\"token punctuation\">.</span>rejected<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    promise <span class=\"token operator\">=</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token keyword\">return</span> promise\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们可以从中获取主要流程：</p>\n<ul>\n<li>\n<p><strong>配置的合并</strong>（mergeConfig()）, 合并了默认配置（this.default）和用户配置。</p>\n</li>\n<li>\n<p><strong>处理（用户传入的）请求方式</strong>，默认为【GET】</p>\n</li>\n<li>\n<p>遍历配置的拦截器，<strong>扩展流程链</strong>（一个列表），通过之前说到的 <code class=\"language-text\">forEach()</code> 遍历所有注册的拦截器，并添加到<strong>流程链</strong> <code class=\"language-text\">chain</code> 中。</p>\n<ul>\n<li>\n<p>如果是<strong>请求拦截器</strong>，我们将它放到流程链的<strong>前面</strong>。</p>\n</li>\n<li>\n<p>如果是<strong>响应拦截器</strong>，我们将它放在流程链的<strong>后面</strong>。</p>\n</li>\n<li>\n<p>下面是一种示例情况（ <code class=\"language-text\">dispatchRequest()</code> 使用 <code class=\"language-text\">promise</code> 包装了整个网络请求，后面会详细介绍）：</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\r\n    <span class=\"token function\">请求拦截1</span><span class=\"token punctuation\">(</span>请求成功时<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> 请求拦截<span class=\"token number\">1</span>（请求失败时）<span class=\"token punctuation\">,</span>\r\n    dispatchRequest<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\r\n    响应拦截<span class=\"token number\">1</span>（响应成功时）， 响应拦截<span class=\"token number\">1</span>（响应失败时）\r\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>从代码中我们可以看到，请求拦截和响应拦截以<code class=\"language-text\">dispatchRequest</code>，并且请求成功和请求失败的回调函数是<strong>成对</strong>的。</p>\n</li>\n<li>\n<p><strong>开始执行</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  promise <span class=\"token operator\">=</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>chain<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> chain<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里的<code class=\"language-text\">promise</code>变量在前面通过<code class=\"language-text\">Promise.resolve()</code>来初始化。这是一个<code class=\"language-text\">resolved</code>的<code class=\"language-text\">promise</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> promise <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<p>关于<code class=\"language-text\">promise.resolve()</code></p>\n<p>Promise 并非一开始就必须处于<strong>pending</strong>状态。通过调用<code class=\"language-text\">Promise.resolve()</code>静态方法，可以实例化一个<strong>resolved</strong>的 Promise。下面两个 Promise 实例实际上是一样的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> p1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">let</span> p2 <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>初始化完成的<code class=\"language-text\">promise</code>进入<code class=\"language-text\">while</code>循环，自左向右遍历流程链列表。成对的移出流程链列表的头两个元素，分别称为 promise 的<code class=\"language-text\">resolve</code>和<code class=\"language-text\">reject</code>项。（同时我们也找出了流程链第二项是<code class=\"language-text\">undefined</code>的原因\r\n— 作为<code class=\"language-text\">reject</code>，和作为<code class=\"language-text\">resolve</code>的<code class=\"language-text\">dispatchRequest</code>一起处理）</p>\n<h4>Axios.prototype[method] — 提供请求的语法糖</h4>\n<p><code class=\"language-text\">Axios.prototype[method]</code> 巧妙地利用上面的 <code class=\"language-text\">forEach</code> 来生成，从而扩展 <code class=\"language-text\">Axios.prototype</code> 的请求语法糖。执行这些语法糖本质上是调用了 <code class=\"language-text\">request()</code>,但是带入了<strong>请求类型</strong>\r\n的配置参数。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">utils<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token punctuation\">[</span><span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"head\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"options\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token function\">forEachMethodNoData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token function\">mergeConfig</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n          method<span class=\"token operator\">:</span> method<span class=\"token punctuation\">,</span>\r\n          url<span class=\"token operator\">:</span> url<span class=\"token punctuation\">,</span>\r\n          data<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>config <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\n\r\nutils<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"put\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">forEachMethodWithData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">/*eslint func-names:0*/</span>\r\n  <span class=\"token class-name\">Axios</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">,</span> config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>\r\n      <span class=\"token function\">mergeConfig</span><span class=\"token punctuation\">(</span>config <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n        method<span class=\"token operator\">:</span> method<span class=\"token punctuation\">,</span>\r\n        url<span class=\"token operator\">:</span> url<span class=\"token punctuation\">,</span>\r\n        data<span class=\"token operator\">:</span> data<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>上面的代码在 <code class=\"language-text\">var Axios = require('./core/Axios');</code> 时被执行，它们遍历包含请求类型的数组，然后将支持的请求方法 <code class=\"language-text\">this.request</code> (也就是上面的 <code class=\"language-text\">request</code>)\r\n挂载到 <code class=\"language-text\">Axios.prototype</code> 上面。</p>\n<h2>实例的运行(执行请求)</h2>\n<h3>dispatchRequest</h3>\n<p><code class=\"language-text\">dispatchRequest(config)</code> 使用配置的适配器向服务器发送请求。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatchRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">throwIfCancellationRequested</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\r\n\r\n  config<span class=\"token punctuation\">.</span>headers <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>headers <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// Transform request data</span>\r\n  config<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> <span class=\"token function\">transformData</span><span class=\"token punctuation\">(</span>\r\n    config<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\r\n    config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\r\n    config<span class=\"token punctuation\">.</span>transformRequest\r\n  <span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token comment\">// Flatten headers</span>\r\n  config<span class=\"token punctuation\">.</span>headers <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">merge</span><span class=\"token punctuation\">(</span>\r\n    config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>common <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span>config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    config<span class=\"token punctuation\">.</span>headers\r\n  <span class=\"token punctuation\">)</span>\r\n\r\n  utils<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token punctuation\">[</span><span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"get\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"head\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"post\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"put\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"common\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">cleanHeaderConfig</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">delete</span> config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">)</span>\r\n\r\n  <span class=\"token keyword\">var</span> adapter <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>adapter <span class=\"token operator\">||</span> defaults<span class=\"token punctuation\">.</span>adapter\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">adapter</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">onAdapterResolution</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">throwIfCancellationRequested</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token comment\">// Transform response data</span>\r\n      response<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> <span class=\"token function\">transformData</span><span class=\"token punctuation\">(</span>\r\n        response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\r\n        response<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\r\n        config<span class=\"token punctuation\">.</span>transformResponse\r\n      <span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token keyword\">return</span> response\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">onAdapterRejection</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">reason</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token function\">isCancel</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">throwIfCancellationRequested</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\r\n\r\n        <span class=\"token comment\">// Transform response data</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>reason <span class=\"token operator\">&amp;&amp;</span> reason<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          reason<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> <span class=\"token function\">transformData</span><span class=\"token punctuation\">(</span>\r\n            reason<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">,</span>\r\n            reason<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\r\n            config<span class=\"token punctuation\">.</span>transformResponse\r\n          <span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>reason<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>自上而下解读：</p>\n<ul>\n<li><code class=\"language-text\">throwIfCancellationRequested(config);</code> 如果请求取消，则抛出 <code class=\"language-text\">Cancel</code>。</li>\n<li>确保请求头存在。</li>\n<li>利用 <code class=\"language-text\">transformData()</code> 转换请求数据, <code class=\"language-text\">transformData()</code> 的主要功能是传入<strong>formData</strong>和<strong>headers</strong>，然后进行一系列处理，具体细节在后面给出。</li>\n<li>利用 <code class=\"language-text\">utils.merge()</code> 处理 <code class=\"language-text\">config.headers.common</code>、<code class=\"language-text\">config.headers[config.method]</code>、<code class=\"language-text\">config.headers</code> 下的请求头，将他们<strong>合并</strong>、<strong>去重</strong>。</li>\n<li>删除多余的请求头（默认的方法请求头）。</li>\n<li><strong>初始化请求适配器</strong>，如果当前环境为浏览器，我们使用<strong>XHR</strong>适配器，否则（ node 环境）我们使用<strong>HTTP</strong>适配器。</li>\n<li>带入配置，执行 adapter。</li>\n<li>利用 <code class=\"language-text\">transformData()</code> 转换响应数据。</li>\n</ul>\n<h3>XHR 适配器</h3>\n<h4>代码及解释</h4>\n<p>XHR 适配器封装了一个<strong>Promise</strong>，面向浏览器的<strong>XHR</strong>请求，本质上是封装了浏览器内置的 <code class=\"language-text\">XMLHttpRequest()</code>。</p>\n<p>它的逻辑比上面的 HTTP 适配器简单，下面是 XHR 适配器的代码，位于 <code class=\"language-text\">xhr.js</code> 中。</p>\n<p>由于代码较长，我以注释的形式加以解析。</p>\n<p>一些比较重要的部分，或者需要额外解释的部分放在代码区之后逐一介绍。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// xhr.js</span>\r\n<span class=\"token comment\">// axios 的 xhr 适配器</span>\r\n\r\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">xhrAdapter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">dispatchXhrRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 初始化数据和请求头</span>\r\n    <span class=\"token keyword\">var</span> requestData <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>data\r\n    <span class=\"token keyword\">var</span> requestHeaders <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>headers\r\n\r\n    <span class=\"token comment\">// 对于FormData，Content-Type 由浏览器自行设定</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isFormData</span><span class=\"token punctuation\">(</span>requestData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">delete</span> requestHeaders<span class=\"token punctuation\">[</span><span class=\"token string\">\"Content-Type\"</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// Let the browser set it</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 通过 XMLHttpRequest 构造函数 生成 XHR 对象</span>\r\n    <span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// HTTP basic authentication，后面会讲</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> username <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>username <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n      <span class=\"token keyword\">var</span> password <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password\r\n        <span class=\"token operator\">?</span> <span class=\"token function\">unescape</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\r\n      requestHeaders<span class=\"token punctuation\">.</span>Authorization <span class=\"token operator\">=</span> <span class=\"token string\">\"Basic \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>username <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> password<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 根据BaseUrl和后缀来拼接URL</span>\r\n    <span class=\"token keyword\">var</span> fullPath <span class=\"token operator\">=</span> <span class=\"token function\">buildFullPath</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>baseURL<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 准备了一个异步的 request(只是准备、没有发送)</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>\r\n      config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token function\">buildURL</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>paramsSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token boolean\">true</span>\r\n    <span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 设置超时时间 （单位为毫秒）</span>\r\n    request<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>timeout\r\n\r\n    <span class=\"token comment\">// 每次 readyState 从一个值变成另一个值，都会触发 readystatechange 事件</span>\r\n    <span class=\"token comment\">// 监听 readystatechange 事件</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onreadystatechange</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 响应阶段，细节信息我们在下面会提到</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request <span class=\"token operator\">||</span> request<span class=\"token punctuation\">.</span>readyState <span class=\"token operator\">!==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 该请求出错了，我们没有得到响应, 将由 onerror 处理</span>\r\n      <span class=\"token comment\">// 本地文件传输协议除外，它即使请求成功，也会返回状态为 0</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n        request<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span>\r\n        <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>responseURL <span class=\"token operator\">&amp;&amp;</span> request<span class=\"token punctuation\">.</span>responseURL<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file:\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 获取响应头</span>\r\n      <span class=\"token keyword\">var</span> responseHeaders <span class=\"token operator\">=</span>\r\n        <span class=\"token string\">\"getAllResponseHeaders\"</span> <span class=\"token keyword\">in</span> request\r\n          <span class=\"token operator\">?</span> <span class=\"token function\">parseHeaders</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">getAllResponseHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\r\n\r\n      <span class=\"token comment\">// 获取响应数据</span>\r\n      <span class=\"token keyword\">var</span> responseData <span class=\"token operator\">=</span>\r\n        <span class=\"token operator\">!</span>config<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">||</span> config<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">===</span> <span class=\"token string\">\"text\"</span>\r\n          <span class=\"token operator\">?</span> request<span class=\"token punctuation\">.</span>responseText\r\n          <span class=\"token operator\">:</span> request<span class=\"token punctuation\">.</span>response\r\n\r\n      <span class=\"token comment\">// 响应</span>\r\n      <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        data<span class=\"token operator\">:</span> responseData<span class=\"token punctuation\">,</span>\r\n        status<span class=\"token operator\">:</span> request<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">,</span>\r\n        statusText<span class=\"token operator\">:</span> request<span class=\"token punctuation\">.</span>statusText<span class=\"token punctuation\">,</span>\r\n        headers<span class=\"token operator\">:</span> responseHeaders<span class=\"token punctuation\">,</span>\r\n        config<span class=\"token operator\">:</span> config<span class=\"token punctuation\">,</span>\r\n        request<span class=\"token operator\">:</span> request<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 处理 promise</span>\r\n      <span class=\"token function\">settle</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token comment\">// 清理请求数据</span>\r\n      request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 处理下面的状态：</span>\r\n    <span class=\"token comment\">// 请求被取消，更确切地来说，是非正常的取消（相对于手动取消）</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onabort</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleAbort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">createError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Request aborted\"</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ECONNABORTED\"</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token comment\">// 清理请求数据</span>\r\n      request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 处理一些底层的网络错误，这些错误的具体内容被浏览器所隐藏 抛出一个笼统的 Network Error</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// Real errors are hidden from us by the browser</span>\r\n      <span class=\"token comment\">// onerror should only fire if it's a network error</span>\r\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">createError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Network Error\"</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token comment\">// 清理请求数据</span>\r\n      request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 处理超时</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">ontimeout</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> timeoutErrorMessage <span class=\"token operator\">=</span> <span class=\"token string\">\"timeout of \"</span> <span class=\"token operator\">+</span> config<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">+</span> <span class=\"token string\">\"ms exceeded\"</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>timeoutErrorMessage<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        timeoutErrorMessage <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>timeoutErrorMessage\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>timeoutErrorMessage<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token string\">\"ECONNABORTED\"</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\n      <span class=\"token comment\">// 清理请求数据</span>\r\n      request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 添加xsrf头</span>\r\n    <span class=\"token comment\">// 仅在标准浏览器环境中运行时才能执行此操作。</span>\r\n    <span class=\"token comment\">// 例如 web worker 和 react-native 之类，则不会</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isStandardBrowserEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 添加xsrf头</span>\r\n      <span class=\"token keyword\">var</span> xsrfValue <span class=\"token operator\">=</span>\r\n        <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>withCredentials <span class=\"token operator\">||</span> <span class=\"token function\">isURLSameOrigin</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\r\n        config<span class=\"token punctuation\">.</span>xsrfCookieName\r\n          <span class=\"token operator\">?</span> cookies<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>xsrfCookieName<span class=\"token punctuation\">)</span>\r\n          <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\r\n\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xsrfValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        requestHeaders<span class=\"token punctuation\">[</span>config<span class=\"token punctuation\">.</span>xsrfHeaderName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> xsrfValue\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 添加请求头</span>\r\n    <span class=\"token comment\">// 对每个请求头执行 setRequestHeader 函数</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"setRequestHeader\"</span> <span class=\"token keyword\">in</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      utils<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>requestHeaders<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">setRequestHeader</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val<span class=\"token punctuation\">,</span> key</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n          <span class=\"token keyword\">typeof</span> requestData <span class=\"token operator\">===</span> <span class=\"token string\">\"undefined\"</span> <span class=\"token operator\">&amp;&amp;</span>\r\n          key<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"content-type\"</span>\r\n        <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">// 如果数据未定义，则删除Content-Type</span>\r\n          <span class=\"token keyword\">delete</span> requestHeaders<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\r\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">// 否则，将标头添加到请求中</span>\r\n          request<span class=\"token punctuation\">.</span><span class=\"token function\">setRequestHeader</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 默认情况下，跨源请求不提供凭据（ cookie、 HTTP 认证和客户端 SSL 证书）。可以通过将</span>\r\n    <span class=\"token comment\">// withCredentials 属性设置为 true 来表明请求会发送凭据。</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isUndefined</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>withCredentials<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      request<span class=\"token punctuation\">.</span>withCredentials <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>config<span class=\"token punctuation\">.</span>withCredentials\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 如果用户设置了响应类型，则处理之。</span>\r\n    <span class=\"token comment\">// 主要的响应类型列举如下：</span>\r\n    <span class=\"token comment\">// \"arraybuffer\" \"blob\" \"document\" \"json\" \"text\";</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>responseType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n        request<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>responseType\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// 浏览器预期抛出的DOMException不兼容 XMLHttpRequest Level 2。</span>\r\n        <span class=\"token comment\">// 但是，对于“json”类型，可以取消此设置，因为可以默认使用transformResponse功能对其进行解析。</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">!==</span> <span class=\"token string\">\"json\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">throw</span> e\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 下载事件  我们可以通过这个属性来实现对下载进度的监控。</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> config<span class=\"token punctuation\">.</span>onDownloadProgress <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      request<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"progress\"</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>onDownloadProgress<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 上传事件，注意: 并非所有浏览器都支持上传事件</span>\r\n    <span class=\"token comment\">// 我们可以通过这个属性来实现对上传进度的监控。</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> config<span class=\"token punctuation\">.</span>onUploadProgress <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span> <span class=\"token operator\">&amp;&amp;</span> request<span class=\"token punctuation\">.</span>upload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      request<span class=\"token punctuation\">.</span>upload<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"progress\"</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>onUploadProgress<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 处理取消行为</span>\r\n      config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">.</span>promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">onCanceled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cancel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">return</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\r\n        request<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span>\r\n        <span class=\"token comment\">// 清理请求</span>\r\n        request <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>requestData<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 清理请求</span>\r\n      requestData <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 发送请求</span>\r\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>requestData<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面的代码 + 注释已经大致概括了整个过程，下面是一些细节介绍。</p>\n<blockquote>\n<p>除非特殊注明，下面的代码块中的所有代码都来自<code class=\"language-text\">xhr.js</code>。</p>\n</blockquote>\n<h4>核心内容 - XMLHttpRequest</h4>\n<p><code class=\"language-text\">XMLHttpRequest</code>是 Ajax 风格通信的一种具体实现，这个对象最早由微软发明，然后被其他浏览器所借鉴。这个接口可以实现：</p>\n<ul>\n<li><strong>异步</strong>从服务器获取额外数据，即用户点击不用页面刷新也可以获取数据</li>\n<li>在页面<strong>已加载后</strong>从服务器请求/接收数据</li>\n<li>在<strong>后台</strong>向服务器发送数据</li>\n</ul>\n<p>上面的代码中出现了许多 XHR 的内容，下面给出解释，对于更多的<code class=\"language-text\">XMLHttpRequest</code>相关内容，请自行参阅相关文档。</p>\n<h5>open() - 请求的准备</h5>\n<p>使用 XHR 对象首先要调用 open()方法，这个方法接收 3 个参数：<strong>请求类型</strong>（ GET、 POST 等）、<strong>请求 URL</strong>，以及表示请求是否异步的布尔值。</p>\n<p>例如上面的代码中有如下内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 请求的准备</span>\r\nrequest<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>\r\n  config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token function\">buildURL</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>paramsSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token boolean\">true</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这段代码表示，为 <code class=\"language-text\">request</code> 这个 <code class=\"language-text\">XMLHttpRequest</code> 对象<strong>准备</strong>请求，<strong>请求方法、url 均来自用户配置</strong>，且这个请求为异步请求。</p>\n<h5>send() - 请求的正式执行</h5>\n<p>send()用来发送定义好的请求， send()方法接收一个参数，是<strong>作为请求体发送的数据</strong>。如果不需要发送请求体，则必须传 null，因为这个参数在某些浏览器中是必需的。</p>\n<h5>readyState - 请求的阶段</h5>\n<p>在实际情况下，我们更期望使用<strong>异步请求</strong>，于是<strong>监听请求状态</strong>就成了一个必需，XHR 有一个 <code class=\"language-text\">readyState</code> 属性可供使用，可能的值如下所示：</p>\n<ul>\n<li>0：<strong>未初始化</strong> (Uninitialized)。尚未调用 <code class=\"language-text\">open()</code> 方法。</li>\n<li>1：<strong>已打开</strong> (Open)。已调用 <code class=\"language-text\">open()</code> 方法，尚未调用 <code class=\"language-text\">send()</code> 方法。</li>\n<li>2：<strong>已发送</strong> (Sent)。已调用 <code class=\"language-text\">send()</code> 方法，尚未收到响应。</li>\n<li>3：<strong>接收中</strong> (Receiving)。已经收到部分响应。</li>\n<li>4：<strong>完成</strong> (Complete)。已经收到所有响应。</li>\n</ul>\n<h5>onreadystatechange - 阶段监听</h5>\n<p>每次 <code class=\"language-text\">readyState</code> 从一个值变成另一个值，都会触发 <code class=\"language-text\">readystatechange</code>事件。</p>\n<p>基于上面两个 API，我们来查看下面的代码，这些代码是 XHR 适配器的<strong>监听部分</strong>，其中，一些处理加工响应内容的代码已经被省略。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 每次 readyState 从一个值变成另一个值，都会触发 readystatechange 事件</span>\r\n<span class=\"token comment\">// 监听 readystatechange 事件</span>\r\nrequest<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onreadystatechange</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleLoad</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 响应阶段，细节信息我们在下面会提到</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>request <span class=\"token operator\">||</span> request<span class=\"token punctuation\">.</span>readyState <span class=\"token operator\">!==</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// 省略一些响应的处理部分</span>\r\n\r\n  <span class=\"token comment\">// 处理 promise</span>\r\n  <span class=\"token function\">settle</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果<code class=\"language-text\">readyState</code> 不为<strong>4</strong>，也就是不处在<strong>完成</strong> (Complete，已经收到所有响应)状态，我们及时 <code class=\"language-text\">return</code> 来提早结束函数以继续监听。</p>\n<p>当 <code class=\"language-text\">readyState</code> 为<strong>4</strong>时，我们进行一系列处理，然后执行 <code class=\"language-text\">settle()</code>。</p>\n<h5>abort() - 请求的终止</h5>\n<p>如果该请求已被发出，<code class=\"language-text\">XMLHttpRequest.abort()</code> 方法将终止该请求。当一个请求被终止，它的 <code class=\"language-text\">readyState</code> 将被置为 <code class=\"language-text\">XMLHttpRequest.UNSENT</code>，并且请求的<code class=\"language-text\">status</code>置为 0。</p>\n<h5>settle() - 根据响应结果更新 Promise</h5>\n<p><code class=\"language-text\">settle</code> 函数用来处理<strong>Promise</strong>（改变状态），根据<strong>响应信息</strong>来进行 <code class=\"language-text\">resolve</code> 或者 <code class=\"language-text\">reject</code>，内容如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// settle.js</span>\r\nmodule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">settle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> validateStatus <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">.</span>validateStatus\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>status <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>validateStatus <span class=\"token operator\">||</span> <span class=\"token function\">validateStatus</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n      <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">\"Request failed with status code \"</span> <span class=\"token operator\">+</span> response<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">,</span>\r\n        response<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">,</span>\r\n        <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n        response<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span>\r\n        response\r\n      <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">settle()</code> 接收三个参数，resolve promise 的函数、reject promise 的函数、响应状态。</p>\n</li>\n<li>\n<p><code class=\"language-text\">settle()</code> <strong>根据用户的响应状态</strong>来决定到底是 <code class=\"language-text\">resolve</code> 还是 <code class=\"language-text\">reject</code></p>\n</li>\n<li>\n<p>在上面的代码中，如果<code class=\"language-text\">response.status</code>不为 0，或者符合用户配置中传入的自定义验证函数，执行 <code class=\"language-text\">resolve</code>，反之执行 <code class=\"language-text\">reject</code>。</p>\n</li>\n<li>\n<p>默认的自定义验证函数如下, 当状态码为<strong>2XX</strong>（代表请求已成功被服务器接收、理解、并接受）时，执行 <code class=\"language-text\">resolve</code>。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token operator\">:</span> number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> status <span class=\"token operator\">>=</span> <span class=\"token number\">200</span> <span class=\"token operator\">&amp;&amp;</span> status <span class=\"token operator\">&lt;</span> <span class=\"token number\">300</span></code></pre></div>\n</li>\n</ul>\n<h5>onerror</h5>\n<p><code class=\"language-text\">onerror</code> 是 XMLHttpRequest 由于错误而失败时调用的函数。用于处理一些底层的网络错误，这些错误的具体内容被浏览器所隐藏， axios 会抛出一个笼统的<code class=\"language-text\">Network Error</code>。</p>\n<h4>HTTP basic authentication</h4>\n<p>在 HTTP 中，<strong>Basic Authorization</strong>基本认证是一种用来允许 Web 浏览器或其他客户端程序在请求时提供用户名和口令形式的身份凭证的一种登录验证方式。</p>\n<h5>实现方式</h5>\n<p>请看来自 XHR 适配器的一部分代码:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// HTTP basic authentication</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> username <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>username <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n  <span class=\"token keyword\">var</span> password <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password\r\n    <span class=\"token operator\">?</span> <span class=\"token function\">unescape</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span>\r\n  requestHeaders<span class=\"token punctuation\">.</span>Authorization <span class=\"token operator\">=</span> <span class=\"token string\">\"Basic \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>username <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> password<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>代码首先查看<code class=\"language-text\">config.auth</code>（用户配置的 auth）是否存在，然后从中获取用户名和密码，之后将我们的<code class=\"language-text\">Authorization</code>请求头赋值为以下内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">requestHeaders<span class=\"token punctuation\">.</span>Authorization <span class=\"token operator\">=</span> <span class=\"token string\">\"Basic \"</span> <span class=\"token operator\">+</span> <span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>username <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> password<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这就是<code class=\"language-text\">HTTP basic authentication</code>的主体，分为两部分：</p>\n<ul>\n<li><code class=\"language-text\">'Basic '</code> 字符串（注意有个空格）</li>\n<li>拼接过后的用户名和密码(以冒号分割)，并且，这部分内容会用<code class=\"language-text\">Base64</code>编码处理。</li>\n</ul>\n<h5>缺陷</h5>\n<p>通过上面的实现方式，我们不难发现一些安全性问题成为<code class=\"language-text\">HTTP basic authentication</code>的重大缺陷。</p>\n<ul>\n<li>\n<p>用户名和密码以<strong>明文</strong>（Base64，可以被解码）传输，需要配合<strong>HTTPS</strong>来保证信息传输的安全。</p>\n</li>\n<li>\n<p>即使密码被强加密，第三方仍可通过加密后的用户名和密码进行<strong>重放攻击</strong>。</p>\n</li>\n<li>\n<p>没有提供任何针对代理和中间节点的防护措施。</p>\n</li>\n<li>\n<p>假冒服务器很容易骗过认证，诱导用户输入用户名和密码。</p>\n</li>\n</ul>\n<h4>XSRF（<strong>CSRF</strong>）跨站请求伪造</h4>\n<p>axios 的 Features 之一（原文）: Client side support for protecting against（客户端支持防止 XSRF）</p>\n<p><strong>CSRF（Cross-site request forgery）跨站请求伪造</strong>：攻击者诱导受害者进入<strong>第三方网站</strong>，在<strong>第三方网站</strong>中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的。</p>\n<h5>处理手段</h5>\n<ul>\n<li>验证码，<code class=\"language-text\">CSRF</code>攻击的发生通常在用户不知情的情况下。</li>\n<li>检查<strong>Origin</strong>属性<strong>Referer</strong>属性头\r\n通常网站的页面与页面之间有一定的逻辑联系，例如想要发送登录的请求 example.com/api/login 时，通常用户在登录的页面 example.com/login 下。那么我们只需要验证请求的 Referer 是否为 example.com/login 即可。还有一个要注意的地方，如果全部这样检测，那么从搜索引擎访问的也会被当成 CSRF 攻击了，所以服务器还要做一些设置。</li>\n</ul>\n<p>缺陷：某些情况下浏览器不会发送 Referer</p>\n<ul>\n<li>CSRF Token</li>\n</ul>\n<p>CSRF 的本质在于请求的参数可以被攻击者猜到</p>\n<p>Token 是在服务器端通过某种算法得出，同时存放在表单和用户的 Cookie 中，发送请求后服务器对请求实体的 token 和 cookie 中的 token 进行对比。</p>\n<ul>\n<li>Cookie 的 SameSite 属性。</li>\n</ul>\n<p>SameSite 可以设置为三个值：Strict，Lax，None。</p>\n<p>Strict 模式：浏览器禁止第三方请求携带 Cookie，比如 example.com 以外的网站在向 example.com/api/login 发送请求时不会发送 Cookie。</p>\n<p>Lax 模式：相对宽松，只能在 get 方法提交表单况或者 a 标签发送 get 请求的情况下可以携带 Cookie，其他情况均不能。</p>\n<p>None 模式：默认模式，请求自动带上 Cookie。（chrome 80 后可能默认模式会改为 Lax）</p>\n<h5>axios 中的处理方式</h5>\n<p>回到源码，我们来看看 axios 是如何处理的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 添加xsrf头</span>\r\n<span class=\"token comment\">// 仅在标准浏览器环境中运行时才能执行此操作。</span>\r\n<span class=\"token comment\">// 例如 web worker 和 react-native 之类，则不会</span>\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isStandardBrowserEnv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 添加xsrf头</span>\r\n  <span class=\"token keyword\">var</span> xsrfValue <span class=\"token operator\">=</span>\r\n    <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>withCredentials <span class=\"token operator\">||</span> <span class=\"token function\">isURLSameOrigin</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\r\n    config<span class=\"token punctuation\">.</span>xsrfCookieName\r\n      <span class=\"token operator\">?</span> cookies<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>xsrfCookieName<span class=\"token punctuation\">)</span>\r\n      <span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xsrfValue<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    requestHeaders<span class=\"token punctuation\">[</span>config<span class=\"token punctuation\">.</span>xsrfHeaderName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> xsrfValue\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>判断是否在标准浏览器环境。</p>\n</li>\n<li>\n<p>生成 XSRF 请求头的值。</p>\n<ul>\n<li>\n<p>用户配置中是否传入了<code class=\"language-text\">withCredentials</code> (跨域请求凭证)</p>\n</li>\n<li>\n<p>通过 <code class=\"language-text\">isURLSameOrigin(fullPath)</code>确定 URL 是否与当前位置具有相同的来源（<strong>如果域名或 IP 地址、端口与协议都相同，那么就会被判定为同源</strong>）</p>\n</li>\n<li>\n<p>上述两个条件有一个满足时，检查<code class=\"language-text\">xsrfCookieName</code>(用作 xsrf token 的值的 cookie 的名称)，如果存在，通过<code class=\"language-text\">cookies.read()</code>读取这个 cookie，否则置为<code class=\"language-text\">undefined</code></p>\n</li>\n<li>\n<p>经过上面的赋值，如果最终的值存在，则设置请求头，请求头的名称由配置<code class=\"language-text\">config.xsrfHeaderName</code>决定。</p>\n</li>\n</ul>\n</li>\n</ul>\n<p>综上所述，它防止攻击的原理是：</p>\n<p>通过用户配置的<code class=\"language-text\">config.xsrfHeaderName</code>和<code class=\"language-text\">config.xsrfCookieName</code>。在每次发送请求的时候，会自动从 <code class=\"language-text\">cookie</code> 中读取对应的 <code class=\"language-text\">token</code> 值，然后将其添加到请求 <code class=\"language-text\">headers</code>\r\n中。这个<code class=\"language-text\">token</code>由服务端颁发，服务端收到<code class=\"language-text\">token</code>会验证合法性选择接受或者拒绝服务，由于这个 <code class=\"language-text\">token</code>\r\n是很难伪造的，所以就能区分这个请求是否是用户正常发起的。（当然，还是需要前后端配合，axios 在这方面只是为我们提供了一个便于配置的环境，让我们不需要额外处理）</p>\n<p>注意：XSS 漏洞可能会泄露 token，例如，用户的 token 存入 localstorage 中，注入的 js 代码可以轻松地获取 token</p>\n<h4>多次出现的 request = null</h4>\n<p>上面的代码中出现了很多将<strong>XMLHTTPRequest</strong>对象置为空的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 一系列操作结束</span>\r\n<span class=\"token comment\">// Clean up request</span>\r\nrequest <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>这种操作被称为<strong>解除引用</strong>，优化内存占用的最佳手段就是保证在执行代码时只保存必要的数据。如果数据不再必要，那么把它设置为 <strong>null</strong>，从而释放其引用。</p>\n<p>我们来看下面代码（摘自《javascript 高级程序设计》）</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createPerson</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> localPerson <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  localPerson<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name\r\n  <span class=\"token keyword\">return</span> localPerson\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">let</span> globalPerson <span class=\"token operator\">=</span> <span class=\"token function\">createPerson</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Nicholas\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token comment\">// 解除 globalPerson 对值的引用</span>\r\nglobalPerson <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>对上面代码的解读：</p>\n<ul>\n<li><code class=\"language-text\">createPerson(name)</code> 运用<strong>工厂模式</strong>创建一个特定对象，返回值 <code class=\"language-text\">localPerson</code> 便是我们创建的对象，赋值给了 <code class=\"language-text\">globalPerson</code>。</li>\n<li>变量 <code class=\"language-text\">globalPerson</code> 保存着 <code class=\"language-text\">createPerson()</code> 函数调用返回的值。</li>\n<li><code class=\"language-text\">localPerson</code> 在 <code class=\"language-text\">createPerson()</code> 执行完成超出上下文后会<strong>自动解除引用</strong>，不需要显式处理。</li>\n<li>但 <code class=\"language-text\">globalPerson</code> 是一个<strong>全局变量</strong>，应该在不再需要时手动解除其引用。</li>\n<li>最后一行就是解除引用的方式。</li>\n</ul>\n<p>用户在访问一个网页的过程中可能会发起大量请求，axios 在发起一个请求时，都会创建一个 <code class=\"language-text\">XMLHTTPRequest()</code> 对象。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 通过 XMLHttpRequest 构造函数 生成 XHR 对象</span>\r\n<span class=\"token keyword\">var</span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>在上面的代码中，变量 <code class=\"language-text\">request</code> 保存着 <code class=\"language-text\">XMLHttpRequest()</code> 构造函数的返回值。 <strong>请求——响应</strong>整个过程结束之后应该<strong>及时手动地解除引用</strong>。</p>\n<h3>HTTP 适配器</h3>\n<p><strong>http 适配器</strong>封装了一个 Promise，用于执行<strong>http</strong>请求，服务于<strong>Node.js 环境</strong>，它的代码如下，由于代码较长，我以注释的形式加以解析。</p>\n<h4>代码及解释</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">httpAdapter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">dispatchHttpRequest</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token parameter\">resolvePromise<span class=\"token punctuation\">,</span>\r\n    rejectPromise</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 初始化配置</span>\r\n    <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolvePromise</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">rejectPromise</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">var</span> data <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>data\r\n    <span class=\"token keyword\">var</span> headers <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>headers\r\n\r\n    <span class=\"token comment\">// 设置默认的用户代理（某些服务器需要）</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"User-Agent\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"user-agent\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"User-Agent\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"axios/\"</span> <span class=\"token operator\">+</span> pkg<span class=\"token punctuation\">.</span>version\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 二进制数据流</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isStream</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// Buffer代表一个缓冲区，主要用于操作二进制数据流</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">isBuffer</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// Nothing to do...</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isArrayBuffer</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        data <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isString</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        data <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// 转换条件错误</span>\r\n        <span class=\"token comment\">// 转换后的数据必须是字符串，ArrayBuffer，Buffer 或 Stream</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n          <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token string\">\"Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream\"</span><span class=\"token punctuation\">,</span>\r\n            config\r\n          <span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 如果数据存在，添加 Content-Length 标头</span>\r\n      headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"Content-Length\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>length\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// HTTP Basic Auth, 用于权限相关的处理</span>\r\n    <span class=\"token keyword\">var</span> auth <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> username <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>username <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n      <span class=\"token keyword\">var</span> password <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n      <span class=\"token comment\">// 拼接auth字符串</span>\r\n      auth <span class=\"token operator\">=</span> username <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> password\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 处理请求url， 通过baseURL（如果有的话），和后缀url来进行拼接</span>\r\n    <span class=\"token comment\">// 仅当请求的URL不是绝对URL时，</span>\r\n    <span class=\"token comment\">// 才通过将baseURL与请求的URL组合在一起来创建新的URL。</span>\r\n    <span class=\"token keyword\">var</span> fullPath <span class=\"token operator\">=</span> <span class=\"token function\">buildFullPath</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>baseURL<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 处理 fullPath（这里的 parse 调用了一个第三方的的url处理库，细节代码比较复杂）</span>\r\n    <span class=\"token keyword\">var</span> parsed <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>fullPath<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 处理协议相关</span>\r\n    <span class=\"token keyword\">var</span> protocol <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">.</span>protocol <span class=\"token operator\">||</span> <span class=\"token string\">\"http:\"</span>\r\n\r\n    <span class=\"token comment\">// 当url中带有权限相关内容时，我们重写 auth 变量</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>auth <span class=\"token operator\">&amp;&amp;</span> parsed<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> urlAuth <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">var</span> urlUsername <span class=\"token operator\">=</span> urlAuth<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n      <span class=\"token keyword\">var</span> urlPassword <span class=\"token operator\">=</span> urlAuth<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span>\r\n      auth <span class=\"token operator\">=</span> urlUsername <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> urlPassword\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 如果我们通过赋值auth对象的方式来生成Authorization请求头，那么我们删除默认的请求头</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">delete</span> headers<span class=\"token punctuation\">.</span>Authorization\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 运用正则表达式 /https:?/ 进行https的判断</span>\r\n    <span class=\"token keyword\">var</span> isHttpsRequest <span class=\"token operator\">=</span> isHttps<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>protocol<span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// `httpAgent` 和 `httpsAgent` 分别在 node.js 中用于定义在执行 http 和 https 时使用的自定义代理</span>\r\n    <span class=\"token keyword\">var</span> agent <span class=\"token operator\">=</span> isHttpsRequest <span class=\"token operator\">?</span> config<span class=\"token punctuation\">.</span>httpsAgent <span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>httpAgent\r\n\r\n    <span class=\"token comment\">// 汇总配置</span>\r\n    <span class=\"token keyword\">var</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 这里的build url 在url 的末尾附加了一系列参数</span>\r\n      <span class=\"token comment\">// 如果用户没有传入自定义的 config.paramsSerializer(序列化函数) 那么序列化将按照默认的方式进行</span>\r\n      path<span class=\"token operator\">:</span> <span class=\"token function\">buildURL</span><span class=\"token punctuation\">(</span>\r\n        parsed<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">,</span>\r\n        config<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">,</span>\r\n        config<span class=\"token punctuation\">.</span>paramsSerializer\r\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^\\?</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      method<span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      headers<span class=\"token operator\">:</span> headers<span class=\"token punctuation\">,</span>\r\n      agent<span class=\"token operator\">:</span> agent<span class=\"token punctuation\">,</span>\r\n      agents<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> http<span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>httpAgent<span class=\"token punctuation\">,</span> https<span class=\"token operator\">:</span> config<span class=\"token punctuation\">.</span>httpsAgent <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      auth<span class=\"token operator\">:</span> auth<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>socketPath<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      options<span class=\"token punctuation\">.</span>socketPath <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>socketPath\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 配置主机名和端口</span>\r\n      options<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">.</span>hostname\r\n      options<span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> parsed<span class=\"token punctuation\">.</span>port\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 代理配置 'proxy' 定义代理服务器的主机名称和端口</span>\r\n    <span class=\"token keyword\">var</span> proxy <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>proxy\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>proxy <span class=\"token operator\">&amp;&amp;</span> proxy <span class=\"token operator\">!==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> proxyEnv <span class=\"token operator\">=</span> protocol<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"_proxy\"</span>\r\n      <span class=\"token keyword\">var</span> proxyUrl <span class=\"token operator\">=</span>\r\n        process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">[</span>proxyEnv<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">[</span>proxyEnv<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proxyUrl<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">var</span> parsedProxyUrl <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>proxyUrl<span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">var</span> noProxyEnv <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span>no_proxy <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NO_PROXY</span>\r\n        <span class=\"token keyword\">var</span> shouldProxy <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\r\n\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>noProxyEnv<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">var</span> noProxy <span class=\"token operator\">=</span> noProxyEnv<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n          shouldProxy <span class=\"token operator\">=</span> <span class=\"token operator\">!</span>noProxy<span class=\"token punctuation\">.</span><span class=\"token function\">some</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">proxyMatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">proxyElement</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>proxyElement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n              <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\r\n            <span class=\"token punctuation\">}</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proxyElement <span class=\"token operator\">===</span> <span class=\"token string\">\"*\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n              <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\r\n            <span class=\"token punctuation\">}</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n              proxyElement<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> <span class=\"token string\">\".\"</span> <span class=\"token operator\">&amp;&amp;</span>\r\n              parsed<span class=\"token punctuation\">.</span>hostname<span class=\"token punctuation\">.</span><span class=\"token function\">substr</span><span class=\"token punctuation\">(</span>\r\n                parsed<span class=\"token punctuation\">.</span>hostname<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> proxyElement<span class=\"token punctuation\">.</span>length\r\n              <span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> proxyElement\r\n            <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n              <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\r\n            <span class=\"token punctuation\">}</span>\r\n\r\n            <span class=\"token keyword\">return</span> parsed<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">===</span> proxyElement\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>shouldProxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          proxy <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n            host<span class=\"token operator\">:</span> parsedProxyUrl<span class=\"token punctuation\">.</span>hostname<span class=\"token punctuation\">,</span>\r\n            port<span class=\"token operator\">:</span> parsedProxyUrl<span class=\"token punctuation\">.</span>port<span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span>\r\n\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>parsedProxyUrl<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">var</span> proxyUrlAuth <span class=\"token operator\">=</span> parsedProxyUrl<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\":\"</span><span class=\"token punctuation\">)</span>\r\n            proxy<span class=\"token punctuation\">.</span>auth <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n              username<span class=\"token operator\">:</span> proxyUrlAuth<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n              password<span class=\"token operator\">:</span> proxyUrlAuth<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span>\r\n          <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      options<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">=</span> proxy<span class=\"token punctuation\">.</span>host\r\n      options<span class=\"token punctuation\">.</span>host <span class=\"token operator\">=</span> proxy<span class=\"token punctuation\">.</span>host\r\n      options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">.</span>host <span class=\"token operator\">=</span>\r\n        parsed<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>parsed<span class=\"token punctuation\">.</span>port <span class=\"token operator\">?</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> parsed<span class=\"token punctuation\">.</span>port <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\r\n      options<span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> proxy<span class=\"token punctuation\">.</span>port\r\n      options<span class=\"token punctuation\">.</span>path <span class=\"token operator\">=</span>\r\n        protocol <span class=\"token operator\">+</span>\r\n        <span class=\"token string\">\"//\"</span> <span class=\"token operator\">+</span>\r\n        parsed<span class=\"token punctuation\">.</span>hostname <span class=\"token operator\">+</span>\r\n        <span class=\"token punctuation\">(</span>parsed<span class=\"token punctuation\">.</span>port <span class=\"token operator\">?</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> parsed<span class=\"token punctuation\">.</span>port <span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\r\n        options<span class=\"token punctuation\">.</span>path\r\n\r\n      <span class=\"token comment\">// 基本代理授权</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>proxy<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">var</span> base64 <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>\r\n          proxy<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>username <span class=\"token operator\">+</span> <span class=\"token string\">\":\"</span> <span class=\"token operator\">+</span> proxy<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">,</span>\r\n          <span class=\"token string\">\"utf8\"</span>\r\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"base64\"</span><span class=\"token punctuation\">)</span>\r\n        options<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"Proxy-Authorization\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Basic \"</span> <span class=\"token operator\">+</span> base64\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">var</span> transport\r\n\r\n    <span class=\"token comment\">// https 代理配置</span>\r\n    <span class=\"token keyword\">var</span> isHttpsProxy <span class=\"token operator\">=</span>\r\n      isHttpsRequest <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>proxy <span class=\"token operator\">?</span> isHttps<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>proxy<span class=\"token punctuation\">.</span>protocol<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>transport<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      transport <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>transport\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>maxRedirects <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      transport <span class=\"token operator\">=</span> isHttpsProxy <span class=\"token operator\">?</span> https <span class=\"token operator\">:</span> http\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 定义在 node.js 中 follow 的最大重定向数目</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>maxRedirects<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        options<span class=\"token punctuation\">.</span>maxRedirects <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>maxRedirects\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 使用重定向功能包装协议</span>\r\n      transport <span class=\"token operator\">=</span> isHttpsProxy <span class=\"token operator\">?</span> httpsFollow <span class=\"token operator\">:</span> httpFollow\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>maxBodyLength <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      options<span class=\"token punctuation\">.</span>maxBodyLength <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>maxBodyLength\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 创建请求 调用了nodejs原生的API 即 http.request(options[,callback])</span>\r\n    <span class=\"token keyword\">var</span> req <span class=\"token operator\">=</span> transport<span class=\"token punctuation\">.</span><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleResponse</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>aborted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\r\n\r\n      <span class=\"token comment\">// uncompress the response body transparently if required</span>\r\n      <span class=\"token keyword\">var</span> stream <span class=\"token operator\">=</span> res\r\n\r\n      <span class=\"token comment\">// return the last request in case of redirects</span>\r\n      <span class=\"token keyword\">var</span> lastRequest <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>req <span class=\"token operator\">||</span> req\r\n\r\n      <span class=\"token comment\">// if no content, is HEAD request or decompress disabled we should not decompress</span>\r\n      <span class=\"token comment\">// 如果没有内容，体现为状态码204 -- 对于一些提交到服务器处理的数据,只需要返回是否成功的情况下,可以考虑使用状态码204</span>\r\n      <span class=\"token comment\">// head 请求 -- 检查资源的有效性，也是没有消息体的</span>\r\n      <span class=\"token comment\">// 解压缩被禁用</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n        res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">!==</span> <span class=\"token number\">204</span> <span class=\"token operator\">&amp;&amp;</span>\r\n        lastRequest<span class=\"token punctuation\">.</span>method <span class=\"token operator\">!==</span> <span class=\"token string\">\"HEAD\"</span> <span class=\"token operator\">&amp;&amp;</span>\r\n        config<span class=\"token punctuation\">.</span>decompress <span class=\"token operator\">!==</span> <span class=\"token boolean\">false</span>\r\n      <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// 获取内容的编码方式</span>\r\n        <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"content-encoding\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">/*eslint default-case:0*/</span>\r\n          <span class=\"token keyword\">case</span> <span class=\"token string\">\"gzip\"</span><span class=\"token operator\">:</span>\r\n          <span class=\"token keyword\">case</span> <span class=\"token string\">\"compress\"</span><span class=\"token operator\">:</span>\r\n          <span class=\"token keyword\">case</span> <span class=\"token string\">\"deflate\"</span><span class=\"token operator\">:</span>\r\n            <span class=\"token comment\">// add the unzipper to the body stream processing pipeline</span>\r\n            stream <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>zlib<span class=\"token punctuation\">.</span><span class=\"token function\">createUnzip</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n\r\n            <span class=\"token comment\">// remove the content-encoding in order to not confuse downstream operations</span>\r\n            <span class=\"token keyword\">delete</span> res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"content-encoding\"</span><span class=\"token punctuation\">]</span>\r\n            <span class=\"token keyword\">break</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 响应配置</span>\r\n      <span class=\"token keyword\">var</span> response <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        status<span class=\"token operator\">:</span> res<span class=\"token punctuation\">.</span>statusCode<span class=\"token punctuation\">,</span>\r\n        statusText<span class=\"token operator\">:</span> res<span class=\"token punctuation\">.</span>statusMessage<span class=\"token punctuation\">,</span>\r\n        headers<span class=\"token operator\">:</span> res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">,</span>\r\n        config<span class=\"token operator\">:</span> config<span class=\"token punctuation\">,</span>\r\n        request<span class=\"token operator\">:</span> lastRequest<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 流式文件</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">===</span> <span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        response<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> stream\r\n        <span class=\"token comment\">// 这个函数根据响应状态解决或拒绝Promise：</span>\r\n        <span class=\"token comment\">// 它会 查看response的 status 根据状态来决定 resolve 还是 reject</span>\r\n        <span class=\"token function\">settle</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">var</span> responseBuffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n        <span class=\"token comment\">// 获取数据事件</span>\r\n        stream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleStreamData</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">chunk</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          responseBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span>\r\n\r\n          <span class=\"token comment\">// 如果指定 maxContentLength ，请确保内容长度不超过maxContentLength, 否则我们执行reject</span>\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n            config<span class=\"token punctuation\">.</span>maxContentLength <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">&amp;&amp;</span>\r\n            Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>responseBuffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> config<span class=\"token punctuation\">.</span>maxContentLength\r\n          <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            stream<span class=\"token punctuation\">.</span><span class=\"token function\">destroy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n              <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n                <span class=\"token string\">\"maxContentLength size of \"</span> <span class=\"token operator\">+</span>\r\n                  config<span class=\"token punctuation\">.</span>maxContentLength <span class=\"token operator\">+</span>\r\n                  <span class=\"token string\">\" exceeded\"</span><span class=\"token punctuation\">,</span>\r\n                config<span class=\"token punctuation\">,</span>\r\n                <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n                lastRequest\r\n              <span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n        <span class=\"token comment\">// 错误事件</span>\r\n        stream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleStreamError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>aborted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\r\n          <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">enhanceError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> lastRequest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n        <span class=\"token comment\">// 请求结束事件</span>\r\n        stream<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleStreamEnd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token comment\">// 连接缓冲区数组</span>\r\n          <span class=\"token comment\">// 如果列表中有多个项目，则创建一个新的缓冲区。</span>\r\n          <span class=\"token keyword\">var</span> responseData <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>responseBuffer<span class=\"token punctuation\">)</span>\r\n\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>responseType <span class=\"token operator\">!==</span> <span class=\"token string\">\"arraybuffer\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token comment\">// 转换成字符串</span>\r\n            responseData <span class=\"token operator\">=</span> responseData<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>responseEncoding<span class=\"token punctuation\">)</span>\r\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\r\n              <span class=\"token operator\">!</span>config<span class=\"token punctuation\">.</span>responseEncoding <span class=\"token operator\">||</span>\r\n              config<span class=\"token punctuation\">.</span>responseEncoding <span class=\"token operator\">===</span> <span class=\"token string\">\"utf8\"</span>\r\n            <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n              responseData <span class=\"token operator\">=</span> utils<span class=\"token punctuation\">.</span><span class=\"token function\">stripBOM</span><span class=\"token punctuation\">(</span>responseData<span class=\"token punctuation\">)</span>\r\n            <span class=\"token punctuation\">}</span>\r\n          <span class=\"token punctuation\">}</span>\r\n\r\n          response<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> responseData\r\n          <span class=\"token comment\">// 在上面的文章里已经提到了这个函数</span>\r\n          <span class=\"token comment\">// 这个函数根据响应状态解决或拒绝Promise：</span>\r\n          <span class=\"token comment\">// 它会 查看response的 status 根据状态来决定 resolve 还是 reject</span>\r\n          <span class=\"token function\">settle</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 处理错误</span>\r\n    req<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleRequestError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>aborted <span class=\"token operator\">&amp;&amp;</span> err<span class=\"token punctuation\">.</span>code <span class=\"token operator\">!==</span> <span class=\"token string\">\"ERR_FR_TOO_MANY_REDIRECTS\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\r\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">enhanceError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\r\n    <span class=\"token comment\">// 处理请求超时</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 有时，响应将非常缓慢，并且没有响应，connect事件将被事件循环系统阻止。</span>\r\n      <span class=\"token comment\">// 并且将触发计时器回调，并在连接之前调用abort（），然后获取“套接字挂起”和代码ECONNRESET。</span>\r\n      <span class=\"token comment\">// 这时，如果我们有大量请求，nodejs将在后台挂断一些套接字。而且这个数字会不断增加。</span>\r\n      <span class=\"token comment\">// 然后这些挂断的套接字将逐渐使CPU变得更糟。</span>\r\n      <span class=\"token comment\">// ClientRequest.setTimeout将在指定的毫秒内触发，并可以确保在连接后将触发abort（）。</span>\r\n      req<span class=\"token punctuation\">.</span><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>timeout<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleRequestTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        req<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n          <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n            <span class=\"token string\">\"timeout of \"</span> <span class=\"token operator\">+</span> config<span class=\"token punctuation\">.</span>timeout <span class=\"token operator\">+</span> <span class=\"token string\">\"ms exceeded\"</span><span class=\"token punctuation\">,</span>\r\n            config<span class=\"token punctuation\">,</span>\r\n            <span class=\"token string\">\"ECONNABORTED\"</span><span class=\"token punctuation\">,</span>\r\n            req\r\n          <span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// Handle cancellation</span>\r\n      config<span class=\"token punctuation\">.</span>cancelToken<span class=\"token punctuation\">.</span>promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">onCanceled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cancel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>aborted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\r\n\r\n        req<span class=\"token punctuation\">.</span><span class=\"token function\">abort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>cancel<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    <span class=\"token comment\">// 发送请求</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isStream</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      data\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handleStreamError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">enhanceError</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      req<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>Buffer(缓冲区)</h4>\n<p>JavaScript 语言自身只有字符串数据类型，没有二进制数据类型。</p>\n<p>但在处理像<strong>TCP 流</strong>或<strong>文件流</strong>时，必须使用到二进制数据。因此在 Node.js 中，定义了一个 Buffer 类，该类用来创建一个专门存放二进制数据的缓存区。</p>\n<p>在 Node.js 中，Buffer 类是随 Node 内核一起发布的核心库。Buffer 库为 Node.js 带来了一种存储原始数据的方法，可以让 Node.js 处理二进制数据。</p>\n<p>请看下面的代码，这是 http 适配器对 data 进行<strong>预处理</strong>的部分。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 二进制数据流</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isStream</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// Buffer代表一个缓冲区，主要用于操作二进制数据流</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">isBuffer</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// Nothing to do...</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isArrayBuffer</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    data <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>utils<span class=\"token punctuation\">.</span><span class=\"token function\">isString</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    data <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 转换条件错误</span>\r\n    <span class=\"token comment\">// 转换后的数据必须是字符串，ArrayBuffer，Buffer 或 Stream</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n      <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">\"Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream\"</span><span class=\"token punctuation\">,</span>\r\n        config\r\n      <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// 如果数据存在，添加 Content-Length 标头</span>\r\n  headers<span class=\"token punctuation\">[</span><span class=\"token string\">\"Content-Length\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>length\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p>首先读取<code class=\"language-text\">config</code>的<code class=\"language-text\">data</code>(用户传入的配置)，然后判断 data 是否为二进制数据流，如果不是，开始执行下面的分支处理。</p>\n</li>\n<li>\n<p>如果是<code class=\"language-text\">ArrayBuffer</code>, 我们调用<code class=\"language-text\">Buffer.from(new Uint8Array(data))</code>将其转为<code class=\"language-text\">Buffer</code>。</p>\n</li>\n<li>\n<p>如果是<code class=\"language-text\">String</code>，我们调用<code class=\"language-text\">Buffer.from(data, 'utf-8')</code>将其转为<code class=\"language-text\">Buffer</code>。</p>\n</li>\n<li>\n<p>如果以上转换条件都不符合，我们抛出异常，并将<code class=\"language-text\">Promise</code>的状态置为<code class=\"language-text\">reject</code>。</p>\n</li>\n<li>\n<p>设置<code class=\"language-text\">Content-Length</code>请求头。</p>\n</li>\n</ul>\n<h4>Proxy - 代理</h4>\n<p>从上面可以看出，axios 为我们提供了代理请求的接口。</p>\n<p>从概念上来说，代理服务器(Proxy Server)是一种代理网络用户去取得网络信息的存在，是一种网络信息中转站。比如说你要访问 C 网站，你可以告诉代理服务器 B — 我要访问 C 网站，代理服务器访问 C 网站然后将 C 网站的内容返回给你。</p>\n<p>代理服务的优点：</p>\n<ul>\n<li>一个 iP 地址或 Internet 帐户供多个用户同时使用</li>\n<li>缓存功能，可以降低费用，提高速度</li>\n<li>对内部网络用户进行权限和信息流量计费管理</li>\n<li>对进入内部网络的 Internet 信息实施监控和过滤</li>\n</ul>\n<h2>异常处理</h2>\n<p>使用适当的信息创建自定义错误可以有效提高代码的可维护性。 我们来看 axios 内部如何实现<strong>异常处理</strong>。</p>\n<h4>createError.js</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token parameter\">message<span class=\"token punctuation\">,</span>\r\n  config<span class=\"token punctuation\">,</span>\r\n  code<span class=\"token punctuation\">,</span>\r\n  request<span class=\"token punctuation\">,</span>\r\n  response</span>\r\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> error <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token function\">enhanceError</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">createError()</code>可以使用使用指定的消息，配置，错误代码，请求和响应来创建错误。</p>\n<p>例如，axios 在收到非<code class=\"language-text\">2XX - 正常</code>的返回时，就会<code class=\"language-text\">reject</code>Promise，并且抛出一个<code class=\"language-text\">createError</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token function\">createError</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token string\">\"Request failed with status code \"</span> <span class=\"token operator\">+</span> response<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">,</span>\r\n    response<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n    response<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span>\r\n    response\r\n  <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<h4>enhanceError.js</h4>\n<p><code class=\"language-text\">createError()</code>最终返回一个<code class=\"language-text\">enhanceError()</code>，是一个默认异常的<strong>扩展</strong>（enhance），也是自定义异常的核心所在。</p>\n<p><code class=\"language-text\">enhanceError()</code>传入一个<code class=\"language-text\">error</code>对象以及一系列响应、请求的配置，来扩展这个<code class=\"language-text\">Error</code>，这包括：</p>\n<ul>\n<li>将用户配置、请求对象（如果有的话）、响应对象（如果有的话）、响应（错误）码带入 error 中。</li>\n<li>附加一个<code class=\"language-text\">toJson()</code>方法</li>\n<li>值得注意的是，不同浏览器的<code class=\"language-text\">Error()</code>对象的成员变量可能有差别，下面的注释就体现了这一点。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">exports</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">enhanceError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  error<span class=\"token punctuation\">.</span>config <span class=\"token operator\">=</span> config\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    error<span class=\"token punctuation\">.</span>code <span class=\"token operator\">=</span> code\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  error<span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> request\r\n  error<span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> response\r\n  error<span class=\"token punctuation\">.</span>isAxiosError <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\r\n\r\n  error<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">toJSON</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">toJSON</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// Standard</span>\r\n      message<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\r\n      name<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">,</span>\r\n      <span class=\"token comment\">// Microsoft</span>\r\n      description<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>description<span class=\"token punctuation\">,</span>\r\n      number<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>number<span class=\"token punctuation\">,</span>\r\n      <span class=\"token comment\">// Mozilla</span>\r\n      fileName<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>fileName<span class=\"token punctuation\">,</span>\r\n      lineNumber<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lineNumber<span class=\"token punctuation\">,</span>\r\n      columnNumber<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>columnNumber<span class=\"token punctuation\">,</span>\r\n      stack<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">,</span>\r\n      <span class=\"token comment\">// Axios</span>\r\n      config<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">,</span>\r\n      code<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>code<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> error\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>注意 <code class=\"language-text\">toJSON()</code> 函数中 <code class=\"language-text\">this</code> 的指向。<code class=\"language-text\">this</code> 到底引用哪个对象必须到<strong>函数被调用时</strong>才可以确定。在 <code class=\"language-text\">toJson()</code> 执行时，this 引用了 <code class=\"language-text\">error</code></p>\n</blockquote>\n<h2>参考资料</h2>\n<table>\n<thead>\n<tr>\n<th>标题</th>\n<th>来源</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>axios GitHub 仓库</td>\n<td><a href=\"https://github.com/axios/axios\">https://github.com/axios/axios</a></td>\n</tr>\n<tr>\n<td>前端安全系列之二：如何防止 CSRF 攻击</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/46592479\">https://zhuanlan.zhihu.com/p/46592479</a></td>\n</tr>\n<tr>\n<td>axios 中文文档</td>\n<td><a href=\"http://www.axios-js.com/zh-cn/\">http://www.axios-js.com/zh-cn/</a></td>\n</tr>\n<tr>\n<td>XMLHttpRequest Living Standard</td>\n<td><a href=\"https://xhr.spec.whatwg.org/#send-flag\">https://xhr.spec.whatwg.org/#send-flag</a></td>\n</tr>\n<tr>\n<td>《JavaScript 高级程序设计》</td>\n<td>---</td>\n</tr>\n<tr>\n<td>Node.js Buffer(缓冲区)</td>\n<td><a href=\"https://www.runoob.com/nodejs/nodejs-buffer.html\">https://www.runoob.com/nodejs/nodejs-buffer.html</a></td>\n</tr>\n<tr>\n<td>Axios 源码解析 —— 一个小而美的 HttpClient</td>\n<td><a href=\"https://zhuanlan.zhihu.com/p/104568514\">https://zhuanlan.zhihu.com/p/104568514</a></td>\n</tr>\n<tr>\n<td>使用 Typescript 重构 axios</td>\n<td><a href=\"https://www.cnblogs.com/wangjiachen666/p/11234163.html\">https://www.cnblogs.com/wangjiachen666/p/11234163.html</a></td>\n</tr>\n</tbody>\n</table>","frontmatter":{"title":"Axios源码解析","date":"March 01, 2022","description":null},"timeToRead":43},"previous":{"fields":{"slug":"/2021-11/better-perfermance-react/"},"frontmatter":{"title":"谈谈React的性能优化"}},"next":{"fields":{"slug":"/2022-03/vue-router/"},"frontmatter":{"title":"vue-router源码浅析"}}},"pageContext":{"id":"bef513ae-52dc-5d89-93d3-1948076dec32","previousPostId":"3be17587-aac5-561c-a5ea-fdf60486e1bf","nextPostId":"2b6ab457-ca0b-5e79-99af-6c13583dce2f"}},"staticQueryHashes":["2841359383","3415673938"]}