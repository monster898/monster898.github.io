{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11/event-loop/","result":{"data":{"site":{"siteMetadata":{"title":"好成的blog"}},"markdownRemark":{"id":"a7dff7dd-79d9-50d7-852a-c35ff1dbba40","excerpt":"总述 本文将深入分析浏览器和 NodeJS 的事件循环。 事件循环 如何理解事件循环？ HTML Standard 如此介绍道： To coordinate events, user interaction, scripts, rendering, networking, and so forth, user…","html":"<h2>总述</h2>\n<p>本文将深入分析浏览器和 NodeJS 的事件循环。</p>\n<h2>事件循环</h2>\n<p>如何理解事件循环？</p>\n<p><a href=\"https://html.spec.whatwg.org/multipage/webappapis.html#event-loops\">HTML Standard</a> 如此介绍道：</p>\n<p>To coordinate events, user interaction, scripts, rendering, networking, and so forth, user agents must use event loops\r\nas described in this section. Each agent has an associated event loop, which is unique to that agent.</p>\n<blockquote>\n<p>为了协调事件、用户交互、脚本、渲染、网络等，用户代理（如浏览器）必须使用事件循环。 每个代理有一个关联的事件循环，它是唯一的。</p>\n</blockquote>\n<p><a href=\"https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick\">NodeJS 官网</a> 如此介绍道：</p>\n<p>The event loop is what allows NodeJS to perform non-blocking I/O operations — despite the fact that JavaScript is\r\nsingle-threaded。</p>\n<blockquote>\n<p>事件循环是 NodeJS 处理非阻塞 I/O 操作的机制——尽管 JavaScript 是单线程处理的。</p>\n</blockquote>\n<p>这里顺便提一下 <strong>IO</strong>：维基百科这样描述：I/O 通常指数据在存储器（内部和外部）或其他周边设备之间的输入和输出，是信息处理系统（例如计算机）与外部世界（可能是人类或另一信息处理系统）之间的通信。 我们 node 开发环境中最常见的有<strong>文件读写</strong>、<strong>网络请求</strong>操作。</p>\n<p>对于浏览器，用户交互（如浏览器鼠标事件）、网络（ajax 请求）是浏览器内部提供的 API （当然再往底层走也是面向操作系统）。</p>\n<p>综上所述，事件循环是 JavaScript 引擎和浏览器接口/操作系统沟通的一座桥梁，是浏览器、NodeJS 实现异步的方法。</p>\n<h2>浏览器的事件循环</h2>\n<h3>概念</h3>\n<p>介绍浏览器的事件循环之前，我们必须理解一些概念：</p>\n<p><strong>Task（任务）</strong>：一个任务就是由执行诸如从头执行一段程序、执行一个事件回调或一个 <strong>interval/timeout</strong> 被触发之类的标准机制而被调度的任意 JavaScript 代码。这些都在任务队列（task\r\nqueue）上被调度。</p>\n<p><strong>Task queues（任务队列）</strong>：一个事件循环具有一个或多个任务队列。任务队列是任务的<strong>集合</strong>。</p>\n<p><strong>Web API（浏览器接口）</strong>：浏览器提供给用户的 API。</p>\n<p><strong>Call Stack（调用栈）</strong>：主函数的调用栈。</p>\n<h3>基本流程</h3>\n<p>来看下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hi!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">foo</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token string\">\"hello \"</span> <span class=\"token operator\">+</span> name\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setTimeout Finish\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sam\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>如果没有事件循环，那么执行 <code class=\"language-text\">setTimeout()</code> 会被阻塞，到 1s 之后才执行，这会大大降低程序运行的效率。事件循环机制就是解决这个问题的关键。</p>\n<p>实际运行时，是这样实现的：</p>\n<p>首先，我们执行 <code class=\"language-text\">console.log(\"Hi!\")</code>:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 574px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7eb9feadbfe45d2c127c84a8b19f5308/86389/20201225193822.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.68354430379746%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABXElEQVQoz8WT227CMAxA+zc0FzsXtyGlaVJaChsg/v9ztqQDoWmbtL3sPFiKpePYVlI1bRuGMMRhCMOYRu+3xtiYUorRex9jCn1ARCGEc27aT32/Q0QoVLu+fzm/nC/nzOslxmHr/e12u54v0zydTq/HZTHGKIUh9Nfr5bgcrDUloypE0EpxzjhniKiUJiJezlJKIbgQout843baDqC8MsFQaN1Oa10ZY7TWjDHOGADYUpYX2BoZ894DYM0EF1IIrGuulM6yLrDCJ5k/yYiYL7hnVus/ZFX6/kK21v7iZuectWQttW1LlKO9YwrOOSIyxjySTdNkGRHXYiV81JZS4BMAgF9RAUCMaVmO03SY53m/3y+Hg996KSX8SJaVUjGlok3zPKeUxnHsus7+CBHlF7Y+tM1mw1jN6nrdXOn8W4QQ6+R5YU3TrKt/oO48xlNPICIR5YUBgP4T77/qDcimq4KwiOq1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201225193822\"\n        title=\"20201225193822\"\n        src=\"/static/7eb9feadbfe45d2c127c84a8b19f5308/86389/20201225193822.png\"\n        srcset=\"/static/7eb9feadbfe45d2c127c84a8b19f5308/c26ae/20201225193822.png 158w,\n/static/7eb9feadbfe45d2c127c84a8b19f5308/6bdcf/20201225193822.png 315w,\n/static/7eb9feadbfe45d2c127c84a8b19f5308/86389/20201225193822.png 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>然后是函数 <code class=\"language-text\">foo()</code> 的定义，啥也不执行。</p>\n<p>接着执行 <code class=\"language-text\">setTimeout()</code> 函数：</p>\n<p>首先，让 <code class=\"language-text\">setTimeout()</code> 函数入栈：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 605px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899e83a85515cbe6f352a496ec72aad2/90cbd/20201225194900.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.62025316455697%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABWUlEQVQoz52R647bIBBG923KbYbhYrCbsmCvHZyoTd7/bSqHNHFXilba8wMB4tMwZ94Q8VdKueRSyjhOY8lkzDRNy7y8p5RzmUoBAKXU4XBYa40xKKUAABHfAKBM43paT+fTWtdl/gghLstcj7WUPH3MYyl2w+VcTuuaUnLOGWO2sFLK+26tx+NxWZY5pYSI7AdjjHEhOGdCiGHoNQWFUagO6SdgcM5prbfK1lqllLgRYwQAzrnY0fe9lPK2lUJIxrgxhuj/MGMshICI+7CUchfe4Jxbaz9XfhUehuH74S8qI2LLxxiJSEqp/gEAfd+3aTWklE9hRGTozs3Etm7DsXfa8cFzVACgtQ4hdL4LIXrvu66z1sJX3OccQrhcr7XW338utdbz+VxyIa3pNVrre2XnHADemlGtt/ad9ugT7dJ7vxOm9V5Ss/IKIcTTNhE55x4y9mJe7ZuwvwT4oPaKTmBdAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201225194900\"\n        title=\"20201225194900\"\n        src=\"/static/899e83a85515cbe6f352a496ec72aad2/90cbd/20201225194900.png\"\n        srcset=\"/static/899e83a85515cbe6f352a496ec72aad2/c26ae/20201225194900.png 158w,\n/static/899e83a85515cbe6f352a496ec72aad2/6bdcf/20201225194900.png 315w,\n/static/899e83a85515cbe6f352a496ec72aad2/90cbd/20201225194900.png 605w\"\n        sizes=\"(max-width: 605px) 100vw, 605px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">setTimeout()</code> 立即执行，他会调用浏览器的 <strong>WebAPI</strong>，然后立刻出栈（执行完成），此时浏览器底层会<strong>单独地</strong>进行相应的系统调用（如计时器）：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 594px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a51fa03a74a5c1dae6c3643690584adf/5fd3e/20201225194626.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.15189873417721%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABbklEQVQoz5WSbW7bMAxAcxvrmxYpSolteclqJ+2WOEV3/7tssjog3lZse9APgeKDRFI7a+3xdLzerrfC8np/TYmfpqdvb29fXy7TPN9vS4qstU77eF+WZbkSebeys9Yyc0oprqQUu27cH44x5RjHmPLz85dhyEQh8CHGPu37wF0IyXtfZERUSgkhmqax1nDshQrpcOT4SemA1MV0QArGRW2DtkEZMrYlwiITkTFGKSWlBHDMsZEaKaAnY1wjtPdIREqKskqWMMYQ0e8yMLMsCYU1JhFX+R0tpfyLrFdqcCurX2Wtdb3MOcfMQgj5EyFElR8jG9l737YtACBiSgm2hBCY+THivUfEndtirXXO1eMKIrYrfkuZs1tzx3HM/TAMOY9jzrnvegDQWpuPsdaWZ3vvz5fzPM3n82We52maPp9OMUb6EyGEugGA95qllM0DZUha6Q9QSlVr/WGEAFCrtf+AMQYAilzbg//Pj4Z9B46NoPvJGQShAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201225194626\"\n        title=\"20201225194626\"\n        src=\"/static/a51fa03a74a5c1dae6c3643690584adf/5fd3e/20201225194626.png\"\n        srcset=\"/static/a51fa03a74a5c1dae6c3643690584adf/c26ae/20201225194626.png 158w,\n/static/a51fa03a74a5c1dae6c3643690584adf/6bdcf/20201225194626.png 315w,\n/static/a51fa03a74a5c1dae6c3643690584adf/5fd3e/20201225194626.png 594w\"\n        sizes=\"(max-width: 594px) 100vw, 594px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>我们接着执行 <code class=\"language-text\">console.log(foo(\"sam\"))</code> ，注意此时 Web API 的计时器也在<strong>同步地执行</strong>，具体的入栈出栈操作这里不再赘述。</p>\n<p>此时主函数的代码执行完毕，主线程会一直去查看任务队列有没有任务，如果有，将它压如调用栈，执行之。</p>\n<p>一旦计时器执行完成，<strong>Web API</strong> 会将回调函数放入回调队列中。主线程发现回调队列有内容，会从队列中取出它，放到调用栈中执行：</p>\n<p>您可以进入<a href=\"http://latentflip.com/loupe/?code=Y29uc29sZS5sb2coIkhpISIpOw0KDQpzZXRUaW1lb3V0KGZ1bmN0aW9uIHRpbWVvdXQoKSB7DQogIGNvbnNvbGUubG9nKCJoZWxsbyB3b3JsZCEiKTsNCn0sIDIwMDApOw0KDQpjb25zb2xlLmxvZygibWFpbiBlbmQiKTs%3D!!!PGJ1dHRvbj5DbGljayBtZSE8L2J1dHRvbj4%3D\">这个网站</a>\r\n来可视化体验浏览器的事件循环过程。</p>\n<h3>宏任务和微任务</h3>\n<p>值得注意的是，上面提到的回调队列是有优先级的顺序的，这里需要了解一下两个名词：</p>\n<ul>\n<li><strong>宏任务队列</strong>（macrotask queue）：<strong>ajax</strong>、<strong>setTimeout</strong>、<strong>setInterval</strong>、<strong>DOM 监听</strong>等。</li>\n<li><strong>微任务队列</strong>（microtask queue）：Promise 的 then 回调、<code class=\"language-text\">queueMicrotask()</code> 等。</li>\n</ul>\n<p>其步骤总结如下图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 436px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a87bb2480ebfd3c2854f088f85d3a3b8/939c5/event-loop.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 121.51898734177216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAYABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHuzsliNkrQf//EABsQAAICAwEAAAAAAAAAAAAAAAABESECIjEy/9oACAEBAAEFApMnS5Q3qiB+Vz//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAYEAACAwAAAAAAAAAAAAAAAAABEBEgIf/aAAgBAQAGPwKkh4v/xAAcEAACAwEAAwAAAAAAAAAAAAABEQAhMUFxgbH/2gAIAQEAAT8hTHLCODzMoR1URTS2Ew/kIHRBRgOUphvuf//aAAwDAQACAAMAAAAQMC8A/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQMBAT8QY//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB0QAQEAAgIDAQAAAAAAAAAAAAERACExQVFxobH/2gAIAQEAAT8QVaQ1NMyGudlO3GsVajTonzOcq239wLCVU6TrGNI0t4YmIKecvESARnoy9203Ec//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"event loop\"\n        title=\"event loop\"\n        src=\"/static/a87bb2480ebfd3c2854f088f85d3a3b8/939c5/event-loop.jpg\"\n        srcset=\"/static/a87bb2480ebfd3c2854f088f85d3a3b8/ff44c/event-loop.jpg 158w,\n/static/a87bb2480ebfd3c2854f088f85d3a3b8/a6688/event-loop.jpg 315w,\n/static/a87bb2480ebfd3c2854f088f85d3a3b8/939c5/event-loop.jpg 436w\"\n        sizes=\"(max-width: 436px) 100vw, 436px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>我们可以发现，事件循环期望微任务<strong>尽可能快地被执行完成</strong>，在上图中体现为每次执行完成一个宏任务，都会去查看微任务队列中有没有内容，如果有，则执行它们直至队列为空。</p>\n<h3>实践</h3>\n<p>来看下面的代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setTimeout!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise1\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise2\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>分析一下过程：</p>\n<ul>\n<li>打印 <strong>start</strong> 字符串。</li>\n<li><code class=\"language-text\">setTimeout()</code> 进入 <strong>macrotask queue</strong>。</li>\n<li><code class=\"language-text\">Promise.then()</code> 后的回调进入 <strong>microtask queue</strong>。</li>\n<li>执行最后一行，打印 end 字符串。</li>\n<li>全局代码执行完毕，接下来执行 <strong>microtask</strong> 的任务，打印 promise1、promise2。</li>\n<li>这时 microtask 队列已经为空，从上面的流程图可知，接下来主线程可能会去做一些 UI 渲染工作，然后开始下一轮 event loop， 执行 <code class=\"language-text\">setTimeout()</code> 的回调，打印出 **setTimeout!**字符串。</li>\n</ul>\n<p>接下来，我们介绍 NodeJS 的事件循环，其机制比浏览器复杂得多。</p>\n<h2>NodeJS 的事件循环</h2>\n<p>NodeJS 的事件循环的核心是 <strong><a href=\"https://zh.wikipedia.org/wiki/Libuv\">libuv</a></strong> 库，它提供对基于事件循环的异步 I/O 的支持。</p>\n<ul>\n<li>我们的 JavaScript 会被送到 <strong>v8</strong> 引擎进行处理。</li>\n<li>代码中会调用 Node API，会交给 libuv 库处理。</li>\n<li>libuv 通过一个事件循环（可以理解为轮询）来查询结果，并将结果放到事件队列中，然后交给 v8 引擎。</li>\n</ul>\n<h3>流程</h3>\n<p>下图是事件循环的流程，一次事件循环又被称为一次 <strong>Tick</strong>，<strong>每个阶段都有一个队列来执行回调</strong>。不同类型的事件在它们自己的队列中排队。</p>\n<ul>\n<li><strong>Expired Timers And Intervals Queue</strong>：本阶段执行已经被 <code class=\"language-text\">setTimeout()</code> 和 <code class=\"language-text\">setInterval()</code> 的调度回调函数。</li>\n<li><strong>IO Events Queue</strong>：已完成的 IO 事件</li>\n<li><strong>Immediate Queue</strong>：<code class=\"language-text\">setImmediate()</code> 回调函数在这里执行。</li>\n<li><strong>Close Handlers Queue</strong>：一些关闭的回调函数，如：<code class=\"language-text\">socket.on('close', ...)</code>。</li>\n</ul>\n<p>下图展示了这个流程：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a9092234619aedb5afcfdff99dbd31df/97a96/1_2yXbhvpf1kj5YT-m_fXgEQ.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.65822784810127%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAADvklEQVQ4y02TbUxbZRTHD4IkKsJAQQkOt4xsMX5Y5kI0upCYLQ6zT2iWZSozMEFwMbhswekIxpB9WMCMBJwW3BKChNeVUmi64kbpy33uvX2ep7cvbC0UGQuDQlduL4W+bIk85lYxni/nfDj5nf/J/xxgjMFikIGaASBNzf/Wz3588ouCs7WXdl/4tu21mvqmoqrPvnoVAJ7Z6QWAF3JzX84BgAzYiY5f9QcMk3NVgnOjnM4kTxBPvBK7Y7Vu/1+HOCxrxk1+NqyjW2O3fcwtBKd93li56I7VUG/ivSNlH0J7pxb+JwLgcnPnnhG9q4LD8hUOy4NWIXTVwq8dn0bBfcQTrx3WEX1T87XeUcPMiJ+E21y2xdctWD6IsPwpIpEmC7+WR2eSQDzxtOqaxhRTlZyJsDxtQcGqnWlmdxJ4gwOGrvfBxcpKMPVOwLYzWMRMpnQnDgOiCvBUOYiIcgG7Y4BIJJ2nCoBpjIBlQgI7iTQtWAMgGD3AenohPG6BoU+OZrm+P/fKRufVgrGKw7sWho1lMv8gixn/ABGHMxGJAMLyN1Z+dY8gbcK0EAK4L6x8HaDhloCktPrEYPND9LB0U1jct3zb8cZCV/cQvdH3VHelNeTt1SbnNZopVT39rg7YvQeqiLewJ9Hg8m+fElyx9214PRewcyM+onUwTbee2flV5nFvHmfm6fT+utOZ879cv3W/T8fMHd0sMGRk811dkvnzY1lshT3vM4jZ1B0LjOqdTNM9zqwoyJye+FFAzugxnfHeyaExWm3DcoXNFcvB4wjYFoO5nztuSDf7Wf8PLY/pzYFkQNMtPNJOHtqgqyVh29z+WRJqwFNz7VaD9JMXPWqdpeG9wDujKWeoN3HeKoaB8zPQYSVN9m5lLGknj9gvnSseOHOi0NZYtxu1NBYydwgSdj+wIgAiRQF7k+Ul+Vlg51fhzwAD1akM58wT1aV6RCJvI6KACz+GbYs7/QlZKTaP2sE4cBfu3LIAMjhgQHoKk84Y2OmGakgBwvLIlG1ZZ+XXykRpMwVM4/85gRyeKs08VT7gqPKSX1jJnBeXK6zcyvk7lqUv71qXGjhH+CPs2noOkUghT5XDohRtIt7EGTMXZDxVarQTnhTwPygikUyeKqcQVS7yWD49S8M9U9Yl1nqtj/0+yDFRioocXj/AU+VHDsvVbe2DJer71dZfLs3Ly89X6x1gCqquqx6sg8iA+WC6H6/tRXj93d96TKUTJt87xBN/M5JgIEpR4LCceoDCwuJcAHgRALKzs3dl/A3Ij3PDjlCAvAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1 2yXbhvpf1kj5YT m fXgEQ\"\n        title=\"1 2yXbhvpf1kj5YT m fXgEQ\"\n        src=\"/static/a9092234619aedb5afcfdff99dbd31df/f058b/1_2yXbhvpf1kj5YT-m_fXgEQ.png\"\n        srcset=\"/static/a9092234619aedb5afcfdff99dbd31df/c26ae/1_2yXbhvpf1kj5YT-m_fXgEQ.png 158w,\n/static/a9092234619aedb5afcfdff99dbd31df/6bdcf/1_2yXbhvpf1kj5YT-m_fXgEQ.png 315w,\n/static/a9092234619aedb5afcfdff99dbd31df/f058b/1_2yXbhvpf1kj5YT-m_fXgEQ.png 630w,\n/static/a9092234619aedb5afcfdff99dbd31df/40601/1_2yXbhvpf1kj5YT-m_fXgEQ.png 945w,\n/static/a9092234619aedb5afcfdff99dbd31df/78612/1_2yXbhvpf1kj5YT-m_fXgEQ.png 1260w,\n/static/a9092234619aedb5afcfdff99dbd31df/97a96/1_2yXbhvpf1kj5YT-m_fXgEQ.png 2400w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>可以看出，<strong>Expired timers</strong> 即上面的定时器阶段、<strong>IO Events</strong> 即上面的 <code class=\"language-text\">poll</code> 阶段、<code class=\"language-text\">close Handlers</code> 即上面的 <code class=\"language-text\">close callbacks</code> 阶段。</p>\n<p>我们还注意到两个中间队列，（这两个队列不属于 libuv，属于 nodeJS 运行环境）：</p>\n<ul>\n<li><strong>Next Ticks Queue</strong>：使用 <code class=\"language-text\">process.nextTick()</code> 函数添加的回调，它比 <strong>Other Microtasks Queue</strong> 优先级高。</li>\n<li><strong>Other Microtasks Queue</strong>：其他微任务队列，例如 promise 的 <code class=\"language-text\">then()</code> 回调、<code class=\"language-text\">queueMicroTask()</code>。</li>\n</ul>\n<p>事件循环的启动从定时器（timers）阶段开始，<strong>一旦一个阶段完成</strong>，事件循环就会检查上面说到的两个中间队列中是否有可用的回调。如果有，事件循环将立即开始处理它们，直到清空这两个队列为止。</p>\n<h1></h1>\n<p>2021-11-19 修正:</p>\n<p>上面说到的一旦一个阶段完成再去检查两个中间队列(nextTick queue 和 Other Microtasks queue)中是否有可用的回调<strong>有误</strong></p>\n<p>实际上在高低版本的 Node 中表现不同，低版本（v11.0 以前）的 Node 表现的行为和浏览器环境有很大的不同，是因为低版本下的 Node 在执行完一个阶段的所有宏任务再执行微任务；而高版本的 Node 表现和浏览器一致，即执行完一个宏任务再执行微任务。</p>\n<p>以下的这段代码在不同版本的 Node 下表现的行为就会有所不同</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\nprocess<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ol>\n<li>当我们遇到 setImmediate 后，将其回调函数放进 check 阶段的宏队列中。</li>\n<li>当我们遇到 process.nextTick 后，将其回调函数放进 nextTick 队列中。因为此时同步代码（或者说最初的宏任务）执行完毕，那么执行 nextTick 队列中的任务。</li>\n<li>输出 2， 遇到 setImmediate 后，将其回调函数放进 check 阶段的宏队列中。</li>\n<li>开始执行 check 队列中的宏任务。</li>\n<li>执行 check 第一个宏任务，输出 1，将 nextTick 的回调放进队列里。\r\n以上五步，无论版本如何都是一致的，接下来就是高低版本 Node 的不同。</li>\n</ol>\n<p>低版本 Node</p>\n<p>因为低版本 Node 是执行完一个阶段中的全部宏任务后，再执行微队列的全部任务。所以先输出 3，再输出 4。</p>\n<p>高版本 Node</p>\n<p>因为高版本 Node 是执行完一个宏任务，就执行微队列的全部任务。所以先输出 4，再输出 3。</p>\n<p>在<code class=\"language-text\">nextTick queue</code>和<code class=\"language-text\">Other Microtasks Queue</code>中，表现与低版本相同，会执行完<code class=\"language-text\">Other Microtasks Queue</code>中的所有任务再去执行<code class=\"language-text\">nextTick queue</code>中的任务。</p>\n<h3>Timer 阶段</h3>\n<p>这是事件循环的第一个阶段，Node 会去检查有无已过期的<strong>timer</strong>，如果有则把它的回调压入<strong>timer</strong>的任务队列中等待执行，事实上，Node 并不能保证<strong>timer</strong>在预设时间到了就会立即执行，因为 Node 对<strong>timer</strong>的过期检查不一定靠谱，它会受机器上其它运行程序影响，或者那个时间点主线程不空闲。比如下面的代码，<code class=\"language-text\">setTimeout()</code> 和 <code class=\"language-text\">setImmediate()</code> 的执行顺序是不确定的。</p>\n<div class=\"gatsby-highlight\" data-language=\"node\"><pre class=\"language-node\"><code class=\"language-node\">setTimeout(() =&gt; {\r\n  console.log(&quot;setTimeout&quot;)\r\n}, 0)\r\nsetImmediate(() =&gt; {\r\n  console.log(&quot;setImmediate&quot;)\r\n})</code></pre></div>\n<p>可以得到输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ node timeout_vs_immediate.js\r\nsetTimeout\r\nimmediate\r\n$ node timeout_vs_immediate.js\r\nimmediate\r\nsetTimeout</code></pre></div>\n<p>这是因为 setTimeout 最少为 1 毫秒，所以关键就在这个 1 毫秒，如果同步代码执行时间较长，进入 Event Loop 的时候 1 毫秒已经过了，setTimeout 执行，如果 1 毫秒还没到，就先执行了 setImmediate。</p>\n<p>但如果把它们放到一个 I/O 回调里面，就一定是 <code class=\"language-text\">setImmediate()</code> 先执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// timeout_vs_immediate.js</span>\r\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span>\r\nfs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>__filename<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"timeout\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"immediate\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>可以得到输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ node timeout_vs_immediate.js\r\nimmediate\r\n<span class=\"token function\">timeout</span>\r\n$ node timeout_vs_immediate.js\r\nimmediate\r\n<span class=\"token function\">timeout</span></code></pre></div>\n<p>上面代码会先进入 I/O callbacks 阶段，然后是 check 阶段，最后才是 timers 阶段。因此，setImmediate 才会早于 setTimeout 执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"outer\"</span><span class=\"token punctuation\">)</span>\r\n\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setTimeout\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"setImmediate\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>上面代码类似，从最外层看，已经到 timer 阶段，且之后并没有回调函数了,进入 check queue 执行<code class=\"language-text\">setImmediate</code>，然后是新一轮 timer，执行<code class=\"language-text\">setTimeout</code>。</p>\n<h3>原生 Promise</h3>\n<p>上图已经指出，promise 的 <code class=\"language-text\">then()</code> 回调属于<strong>其他微任务队列（Other Microtasks Queue）</strong>，来看下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise1 resolved\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise2 resolved\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise3 resolved\"</span><span class=\"token punctuation\">)</span>\r\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"next tick inside promise resolve handler\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise4 resolved\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise5 resolved\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set immediate1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set immediate2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nprocess<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"next tick1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nprocess<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"next tick2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\nprocess<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"next tick3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set timeout\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set immediate3\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"set immediate4\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>五个 promise 的 <code class=\"language-text\">then</code> 回调将进入 <strong>Other Microtasks Queue</strong>。</li>\n<li>两个 <code class=\"language-text\">setImmediate</code> 将进入 <strong>Check Queue</strong>。</li>\n<li>三个 <code class=\"language-text\">next tick</code> 回调将进入 <strong>nextTick queue</strong>。</li>\n<li>一个 <code class=\"language-text\">setTimeout</code> 回调将在适当的时刻进入 <strong>timers Queue</strong>。</li>\n<li>两个 <code class=\"language-text\">setImmediate</code> 回调将进入 <strong>Check Queue</strong>。</li>\n<li>事件循环将开始检查并处理 process.nextTick 队列。</li>\n<li>检查 <strong>Other Microtasks Queue</strong>，处理相应的 promise 回调。</li>\n<li>在上一步的过程中，一个新的 <code class=\"language-text\">nextTick</code> 回调被加入<strong>nextTick queue</strong>。node 会去处理它。直至没有更多的微任务(注意是执行完一个阶段后才会去检查 nextTick queue 或 Other Microtasks Queue)。</li>\n<li>事件循环进入计时器阶段，处理一个计时器回调。</li>\n<li>进入检测（check）阶段，处理所有的 <code class=\"language-text\">set immediate</code>。</li>\n</ul>\n<p>最终程序将打印如下内容：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">next tick1\r\nnext tick2\r\nnext tick3\r\npromise1 resolved\r\npromise2 resolved\r\npromise3 resolved\r\npromise4 resolved\r\npromise5 resolved\r\nnext tick inside promise resolve handler\r\nset timeout\r\nset immediate1\r\nset immediate2\r\nset immediate3\r\nset immediate4</code></pre></div>\n<h1></h1>\n<h3>最佳实践(BEST PRACTICE)</h3>\n<h4>避免在重复调用的代码块中进行同步 IO</h4>\n<p>尽量避免在重复调用的代码块中同步 I/O 函数(fs.readFileSync、 fs.renameSync 等) ，比如循环和经常调用的函数。</p>\n<p>这会在很大程度上降低应用程序的性能，因为每次执行同步 I/O 操作时，事件循环都会一直被阻塞，直到完成。</p>\n<h4>函数应该完全异步或者完全同步</h4>\n<p>请看下面代码</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">filename<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> content</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n\r\n    cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> content\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">letsRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myfile.txt\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// error handler redacted</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file read complete\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file read initiated\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果我们调用两次 <code class=\"language-text\">letsRead</code> 将输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"plain\"><pre class=\"language-plain\"><code class=\"language-plain\">file read initiated\r\nfile read complete\r\nfile read complete\r\nfile read initiated</code></pre></div>\n<p>前后顺序不一致！不难推测出后面的代码是完全同步的，而前面的代码执行掺杂了异步的操作。</p>\n<p>当我们的应用程序变得越来越复杂时，这种不一致的同步 - 异步混合函数可能会导致许多问题，这些问题极难调试和修复。</p>\n<p>因此，强烈建议始终遵循上面的同步或异步规则，例如上面的代码可以改为：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> cache <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">ReadFile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">filename<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> process<span class=\"token punctuation\">.</span><span class=\"token function\">nextTick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> content</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n\r\n    cache<span class=\"token punctuation\">[</span>filename<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> content\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> content<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">letsRead</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"myfile.txt\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// error handler redacted</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file read complete\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"file read initiated\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>参考资料</h2>\n<p>nodejs</p>","frontmatter":{"title":"分析浏览器和 NodeJS 的事件循环","date":"November 09, 2021","description":"event loop"},"timeToRead":12},"previous":{"fields":{"slug":"/2021-11/谈谈前端性能优化/"},"frontmatter":{"title":"谈谈前端性能优化"}},"next":{"fields":{"slug":"/2021-11/es6/"},"frontmatter":{"title":"一些有趣的es6案例分析"}}},"pageContext":{"id":"a7dff7dd-79d9-50d7-852a-c35ff1dbba40","previousPostId":"57275088-ec7a-5e67-9df3-0ac1701f74db","nextPostId":"db5bd321-d9ea-5b99-983c-5733163a37d5"}},"staticQueryHashes":["2841359383","3415673938"]}