{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11/谈谈前端性能优化/","result":{"data":{"site":{"siteMetadata":{"title":"好成的blog"}},"markdownRemark":{"id":"57275088-ec7a-5e67-9df3-0ac1701f74db","excerpt":"在使用框架进行前端开发的时候，针对特定框架我们有特定的性能优化手段，实际上，面向浏览器、资源请求也可以作出很多的优化，这篇文章简单总结一下。 合理利用缓存 第一部分我们聊聊缓存，这是前后端一个很重要的知识点。缓存可以减少冗余传输、减少带宽，降低源服务器的压力。 缓存的工作机制如下： 浏览器先根据这个资源的 http…","html":"<p>在使用框架进行前端开发的时候，针对特定框架我们有特定的性能优化手段，实际上，面向浏览器、资源请求也可以作出很多的优化，这篇文章简单总结一下。</p>\n<h2>合理利用缓存</h2>\n<p>第一部分我们聊聊<strong>缓存</strong>，这是前后端一个很重要的知识点。缓存可以减少冗余传输、减少带宽，降低源服务器的压力。</p>\n<p>缓存的工作机制如下：</p>\n<ul>\n<li>浏览器先根据这个资源的 http 头信息来判断是否命中强缓存。如果命中则直接加在缓存中的资源，并不会将请求发送到服务器。</li>\n<li>如果未命中强缓存，则浏览器会将资源加载请求发送到服务器(新鲜度再验证)。服务器来判断浏览器本地缓存是否失效。若可以使用，则服务器并不会返回资源信息，浏览器继续从缓存加载资源。</li>\n<li>如果未命中协商缓存，则服务器会将完整的资源返回给浏览器，浏览器加载新资源，并更新缓存。</li>\n</ul>\n<p>一图以蔽之：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 468px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bd0c12e8889a29ac478be94e7b658f09/90372/20201221142823.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72.78481012658227%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACXUlEQVQoz1WTaVPbMBCG+/9/QClpWo5CC/SAAGFKaael/ZjmcHwmEwvsOLZjWbId34esju0pMe+nHUnv7O6j3ReU0pKUCGHD0C3LiuO4OqnVDhpxPH//+4/rus3VC0qp67o8L/A8r2mrolaWZYaucywbR1FeFE/mi4vezqvdx0dla4YQStJMURSO5R6ALIoiQggAcH15KQpC864x397enZycLpfLrRkh1O2+7XS6oigJLDsY/A2CIIrCKcMAACrn/8J7vauXO7sAPGzNRVG4DoYQEkLiOPY8j1KapalpmnlRlGVJCCnqwPM80zCeGqnMhBAHYwgtCKFt221OhJA2sOmU/fnr3nGcbWaMHZbleF5QVTUMoziOkyRZrVaj4TAMwyiKkiRJk0rn571Op/sMmGVZE4aRpBkzYWpgEsYYAHDT708ZxnWcmSTO53PTNM8+fjo6/qAqajszPnx3tLd/IC9kSeAHg0FcpY9ZllWUxzRNJ6PReMKEYXh51d/tvH6WmRAS+L7jOKQs8zxPkoRSmiZJBSyv2CR1I5TSwPet9ZoQsgVWliXGWNM0Q9eNle44OMvzskbVQH4CNh5P7r7/QAi1/xlzHC8KIgAAY2zbdhiGuq4Pa2AI2XNpJsvycqldXfe73TeK0ip7vbaGozEviKPRCMgLUZRs2xYF8abfZ6fTwPchhMi2MUKfv1zs7R8qbWCu552enh0dv19q2nwmTcaTNMsCP+BYVtM0f7N5AEBeLAzT/Hr7bf/gUFVb40mKYuNtEMYFIXmep0laTViWQgiL1lY0K2ToRp7nDbB/QOkzWxRIepoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201221142823\"\n        title=\"20201221142823\"\n        src=\"/static/bd0c12e8889a29ac478be94e7b658f09/90372/20201221142823.png\"\n        srcset=\"/static/bd0c12e8889a29ac478be94e7b658f09/c26ae/20201221142823.png 158w,\n/static/bd0c12e8889a29ac478be94e7b658f09/6bdcf/20201221142823.png 315w,\n/static/bd0c12e8889a29ac478be94e7b658f09/90372/20201221142823.png 468w\"\n        sizes=\"(max-width: 468px) 100vw, 468px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>强制缓存</h3>\n<p>强制缓存的状态码为 200，要实现强制缓存，需要依靠这些请求头：</p>\n<p><strong>Cache-Control</strong>，这个头的可能值如下：</p>\n<ul>\n<li><code class=\"language-text\">private</code> 客户端可以缓存</li>\n<li><code class=\"language-text\">public</code> 客户端和代理服务器都可以缓存</li>\n<li><code class=\"language-text\">max-age=x</code> 缓存内容将在 x 秒后失效</li>\n<li><code class=\"language-text\">no-cache</code> 需要使用对比缓存验证数据, 强制向源服务器再次验证 (没有强制缓存)</li>\n<li><code class=\"language-text\">no-store</code> 所有内容都不会缓存，强制缓存和对比缓存都不会触发 (不缓存)</li>\n</ul>\n<p><strong>Expires</strong>，一个时间戳，表示在此时候之后，响应过期。</p>\n<p>如果在 Cache-Control 响应头设置了 <code class=\"language-text\">max-age</code> 或者 <code class=\"language-text\">s-max-age</code> 指令，那么 <code class=\"language-text\">Expires</code> 头会被忽略。</p>\n<p>Cache-Control 中的 <code class=\"language-text\">max-age=x</code> 和 <code class=\"language-text\">Expires</code> 的值有所区别 --- 一个是相对时间、一个是绝对时间。</p>\n<h3>协商缓存</h3>\n<p>协商缓存的状态码为 304（3xx 属于重定向，这没毛病 — 重定向到本地的缓存），要想实现协商缓存，需要依赖下面这些请求/响应头：</p>\n<p><strong>ETag</strong></p>\n<p><code class=\"language-text\">ETag</code> 用来标示资源是否改变。</p>\n<p>例如：服务器产生 ETag，并在 HTTP 响应头中将其传送到客户端，服务器用它来判断页面是否被修改过，如果未修改返回 304，无需传输整个对象。</p>\n<p><strong>If-None-Match</strong></p>\n<p>和 <code class=\"language-text\">Etag</code> 匹配的请求头，客户端接收到 <code class=\"language-text\">ETag</code> 之后，下次可以通过这个请求头来发送它，服务端可以通过比较来决定是否需要缓存。</p>\n<p><strong>Last-Modified</strong></p>\n<p>包含源头服务器认定的资源做出修改的日期及时间。它通常被用作一个验证器来判断接收到的或者存储的资源是否彼此一致。</p>\n<p><strong>If-Modified-Since</strong></p>\n<p>和 <code class=\"language-text\">Last-Modified</code> 匹配的请求头，客户端会发送上一次的 <code class=\"language-text\">Last-Modified</code>，服务端通过判断时间来决定是否返回 304。</p>\n<h3>实践 — 强制缓存和协商缓存</h3>\n<p><strong>Last-Modified + If-Modified-Since</strong></p>\n<p>下面的代码利用 <strong>Last-Modified</strong> 和 <strong>If-Modified-Since</strong> 来实现协商缓存，<strong>Last-Modified</strong> 是服务端返回的，可以是当前时间，下次浏览器请求这个资源时就会把这个\r\n<strong>Last-Modified</strong> 交给服务端，让服务端来进行验证。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/15ce5ec381daa4e540ddf8e4e1538122/0d98f/Snipaste_2021-11-07_17-59-29.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.0126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAABJNAAASTQHzl8SnAAAB9UlEQVQoz4WTCYobQQxF+zRp1yLVJqnWLrc9Tgec+98ntGcgA2Ey8BEU6An09WuJbma6sxQjd2i/Q5upD435YtPF0v+1cHgbcvTRgxxtPmVcMTWFrCypb2HEHv0QEY3Fph1pcyIQy2pp/RZ2roc4oRyuHq7+hHIoeltdkVDFZ/RdAX8JG8iRdp7P1I/cjlxvPpXgsvfNxmnCdi5v0hcw5pqOIL9sf6I8KN9mvd/72NoMeeeyI+9WHiaOf0csNg7tigLRkBXmC2QF5VVFW9EoxtV3aVc+hB9aWBrVO9en8E14EE+XhgliYjGxnOMsK5CX+ecJLsAK5V2LBpLQsB2htdhbmt3XGnnr11m3QVTBMXoxNA1dTZoQ6mfDuPMu7ZBWebS6tfKCaQwezXPTyAZYuXZxXfthXP4La8gx7lluJA/km+RHyQ9OPaB4zOQKxmJTdpSRxEaGWGwoH/AFmNOs5UE0kUYq19U3APZAAOROI8n4ZIKoIMqzRrlYXs15v2UFimH0tCGQwy24irFququ0W7pGziZtOu2IhTAHzCYIcnZcjcuLcQVcRiADbLGBK8YX7bv2zfjmgmhfdWgGxaEAinZsgxgnCniBcHavkDWyAlrf82Tiq6Yf5v2ZVks/LK2vnKzm1LlzTOJ5M/yWpUWq336Gzwn7AwwruvhAG8kSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Snipaste 2021 11 07 17 59 29\"\n        title=\"Snipaste 2021 11 07 17 59 29\"\n        src=\"/static/15ce5ec381daa4e540ddf8e4e1538122/f058b/Snipaste_2021-11-07_17-59-29.png\"\n        srcset=\"/static/15ce5ec381daa4e540ddf8e4e1538122/c26ae/Snipaste_2021-11-07_17-59-29.png 158w,\n/static/15ce5ec381daa4e540ddf8e4e1538122/6bdcf/Snipaste_2021-11-07_17-59-29.png 315w,\n/static/15ce5ec381daa4e540ddf8e4e1538122/f058b/Snipaste_2021-11-07_17-59-29.png 630w,\n/static/15ce5ec381daa4e540ddf8e4e1538122/40601/Snipaste_2021-11-07_17-59-29.png 945w,\n/static/15ce5ec381daa4e540ddf8e4e1538122/78612/Snipaste_2021-11-07_17-59-29.png 1260w,\n/static/15ce5ec381daa4e540ddf8e4e1538122/0d98f/Snipaste_2021-11-07_17-59-29.png 1276w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>ETag + If-None-Match</strong></p>\n<p>下面的代码利用 <strong>ETag + If-None-Match</strong> 实现缓存，服务端将文件计算 hash 值放入 Etag 返回，下次用户再次访问时 If-None-Match 会携带这个 ETag，服务端将新的文件计算\r\nhash，然后对比来判断是否 304。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa653c3a6f89f53b606d34eb0ab96b6a/e4611/Snipaste_2021-11-07_18-02-39.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.9493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAABJNAAASTQHzl8SnAAABwUlEQVQoz42T647cIAyF8zSTC2CuxsYkIXPfff8XapPRtmq1rUb6fiDkYx18TBfdOafmIml+QvmIdbZJBp3eoaPwWPjKUjw+5/aB0nSgEfJbYrDVhxoSjZZVbDqKxaIsDTr1R8UEeTT4vVh7DrzFcsVyQd6o3iKdqd4CNZRrWR6BmsNlUHHnL7HxkuVS1ptsn1gvZb3neuXljnKR9uT5bnxxuPi87l3S3Ksw6Pii864hNipVebFZPFUIdQI+oBFI2aLcF3a//EWXSRxfER8pbYizT+2oY+VZuTICjeZP4DcdmIRxteWWZokiss7akyX2hU3g0fxv7J0DKniJcs9rTbWu2xqTmEg2MyBPBk/q32IDkvyyhpJdKUEkVs7VYjGJTWQVakS2gQf9TVrdBFRi27DtRhOnVHoTdUDtcQQcHFuPCrDXeDqi6lXsv7x0o8HkZwqzhmxts450XFQ8T3FzqfpIQ2gqLN5SdgyOTCJAhlBGg3vOyiAYVJABREFWrkxORifakbY0OZks760hTwYnh8ria+067faR9gZHkwYd95V8LdNu73Cown7W6fR6qjp42UZkg83gWVjAc6/Sm1/qp/gHKcKvF9HELdoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Snipaste 2021 11 07 18 02 39\"\n        title=\"Snipaste 2021 11 07 18 02 39\"\n        src=\"/static/fa653c3a6f89f53b606d34eb0ab96b6a/f058b/Snipaste_2021-11-07_18-02-39.png\"\n        srcset=\"/static/fa653c3a6f89f53b606d34eb0ab96b6a/c26ae/Snipaste_2021-11-07_18-02-39.png 158w,\n/static/fa653c3a6f89f53b606d34eb0ab96b6a/6bdcf/Snipaste_2021-11-07_18-02-39.png 315w,\n/static/fa653c3a6f89f53b606d34eb0ab96b6a/f058b/Snipaste_2021-11-07_18-02-39.png 630w,\n/static/fa653c3a6f89f53b606d34eb0ab96b6a/40601/Snipaste_2021-11-07_18-02-39.png 945w,\n/static/fa653c3a6f89f53b606d34eb0ab96b6a/78612/Snipaste_2021-11-07_18-02-39.png 1260w,\n/static/fa653c3a6f89f53b606d34eb0ab96b6a/e4611/Snipaste_2021-11-07_18-02-39.png 1298w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>有关缓存的详细知识，请参考此文章\r\n<a href=\"https://samguo.me/HTTP-cache/HTTP-cache/\">谈谈 HTTP 缓存</a></p>\n<h2>优化资源的编码/大小</h2>\n<p>如果缓存是“获取速度快”，那么优化编码就是“拿得尽可能少”。</p>\n<p>就拿图片来说，将一个较大尺寸的图片后添加到页面的较小一块区域，显示部分还是那么大，但是我们下载的图片还是那个 “大尺寸的大小”。浪费了流量并损害了页面性能。</p>\n<h3>图片自适应</h3>\n<p>我们按照不同宽度准备好几张照片，达到<strong>为不同设备加载不同图片</strong>的目的，这便是响应式图片（图片自适应）。针对这种需求，我们使用 h5 的 <code class=\"language-text\">&lt;img></code> 标签新特性 <strong>srcset</strong> 和 <strong>sizes</strong>。</p>\n<p>例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>img</span>\r\n  <span class=\"token attr-name\">srcset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>img1.jpg 320w, img2.jpg 800w<span class=\"token punctuation\">\"</span></span>\r\n  <span class=\"token attr-name\">sizes</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>(max-width: 480px) 440px,\r\n            800px<span class=\"token punctuation\">\"</span></span>\r\n  <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>img.jpg<span class=\"token punctuation\">\"</span></span>\r\n  <span class=\"token attr-name\">alt</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hello world<span class=\"token punctuation\">\"</span></span>\r\n<span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>上面的代码中，<code class=\"language-text\">srcset</code> 表示<strong>图像集</strong>。</p>\n<p><code class=\"language-text\">sizes</code> 表示<strong>媒体条件</strong>：如果浏览器视窗宽度为 <code class=\"language-text\">440px</code>，那么 <code class=\"language-text\">(max-width: 480px)</code> 的媒体条件为真，显示图片的槽的宽度限制为 <code class=\"language-text\">440px</code>，其余条件显示图片的槽的宽度限制为 <code class=\"language-text\">800px</code>。</p>\n<p><code class=\"language-text\">srcset</code> 表示<strong>图像集</strong>：<code class=\"language-text\">320w</code>表示图片真实固有宽度大小，注意到这里使用<code class=\"language-text\">w</code>单位，而不是你预计的<code class=\"language-text\">px</code>，这是图像的真实大小。</p>\n<p>所以，有了这些属性，浏览器会：</p>\n<ol>\n<li>查看设备宽度</li>\n<li>检查 sizes 列表中哪个媒体条件是第一个为真</li>\n<li>查看给予该媒体查询的槽大小</li>\n<li>加载 srcset 列表中引用的最接近所选的槽大小的图像</li>\n</ol>\n<p>除了 IE 浏览器，主流浏览器均已兼容此功能。</p>\n<h3>代码压缩</h3>\n<p>按需加载代码：</p>\n<ul>\n<li>使用代码拆分将 JavaScript 分解成关键部分和非关键部分。我们可以使用<strong>webpack</strong>等工具实现。</li>\n<li>延迟加载非关键代码。（懒加载）</li>\n</ul>\n<p>例如：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token comment\">&lt;!-- test--></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\r\n      <span class=\"token comment\">/* awesome-container is only used on the landing page */</span>\r\n      <span class=\"token selector\">.awesome-container</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">font-size</span><span class=\"token punctuation\">:</span> 120%<span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token selector\">.awesome-container</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 50%<span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token comment\">&lt;!-- awesome container content: START --></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span>…<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token comment\">&lt;!-- awesome container content: END --></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\r\n      <span class=\"token function\">awesomeAnalytics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// beacon conversion metrics</span>\r\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>对于上面的代码，我们可以：</p>\n<ul>\n<li>直接删除注释可显著减小网页的总大小。</li>\n<li>可以将将两个 <code class=\"language-text\">awesome-container</code> 选择器声明折叠为一个而不影响任何其他样式，从而节省更多字节。</li>\n<li>空白（空格和制表符）能够在 HTML、CSS 和 JavaScript 中给开发者提供方便。但是生产环境下体积会变大，我们可以增加一个压缩程序来去掉所有制表符和空格。</li>\n</ul>\n<h3>GZIP 压缩</h3>\n<p>说到资源的大小优化，一个经典的案例便是<strong>GZIP</strong>。这是一种用来改进 web 应用程序性能的技术，web 服务器和客户端（浏览器）必须共同支持 gzip。目前主流的浏览器，Chrome, firefox, IE\r\n等都支持该协议。常见的服务器如 Apache，Nginx，IIS 同样支持 gzip。</p>\n<p>gzip 压缩比率在 3 到 10 倍左右，可以大大节省服务器的网络带宽。</p>\n<p><strong>工作流程</strong></p>\n<p>下图是 gzip 的工作流程：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7391f9631592a16d56786f8d9f575492/74866/20201101225138.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.9873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACAUlEQVQoz42Sy47iMBBF869sWMBn8AF8AGrNshtGqBE9PMSzEQQIhDzEmyAiQsABI0QibIckHtHWIDSMWnMW3th16/pWcfQBz/Mcx7Ft23EcjDFCyPM8dhX84f44CALO933P867XaxAEjuOMx+PhcKgoiiiKvV4PQkgpxRizsiAIMEI3VYR83+fuMpTS0+kky7IkSaqq9vt9QRB6vZ6mafV6fbfbIYQAAG2e77Tb3W5X13WO5/lMJpPL5dLptGEYEELLsvYPAADYCSGczWa/Pj4y7+/FQmEgilylUuF5PhaLjb6glPq+T59g1jRNS70lf7y8/EylZEniEolEOByORCLRaFTXdRZb8ARTnM/nxXzhs1avVqoDccBBCOPxeCgUarVaj2H+s/NqtYIQskFMJ9NbYISQ5XJJv4UVr9frarny9vpaq9Rm0+ltVK7rGobB3H4vQQgBAIxHI7DbXS4XjqluNhv636zXa9aGM01zuVwqiqLr+ul0uju8c/3CdV1K6Xa7nUwmzWZzsViYpsmVy+VkMpnP57PZbKPRYLvR7XZFUVQURVVV0zQBALqu27Yty3I2my2VSsViURAEDmN8uVwwxoSQ8/k8Go1kWVYUpdPp9Pt9SZKOx6NlWWzJCSH4C4SQ67rcX3lst1vTNPf7/eFw2Gw2hmGsVitN0wghz5//DSnu+q68+mi1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201101225138\"\n        title=\"20201101225138\"\n        src=\"/static/7391f9631592a16d56786f8d9f575492/f058b/20201101225138.png\"\n        srcset=\"/static/7391f9631592a16d56786f8d9f575492/c26ae/20201101225138.png 158w,\n/static/7391f9631592a16d56786f8d9f575492/6bdcf/20201101225138.png 315w,\n/static/7391f9631592a16d56786f8d9f575492/f058b/20201101225138.png 630w,\n/static/7391f9631592a16d56786f8d9f575492/74866/20201101225138.png 668w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>;</p>\n<ul>\n<li>浏览器请求 url，并在 request header 中设置属性 <code class=\"language-text\">accept-encoding:gzip</code>。表明浏览器支持 gzip，例如下图：</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4c7150294cbc85809a770e5607cce362/889a4/20201101225226.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABCElEQVQoz5WR2W7EMAhF8/9fOclDDF7iDbDjZaZKppXmqVWPBOIB0IW7IKLWaJ3rvaeURPj5zZxzjh96Hx/1xZxziSEAKAQEQFAKEZUCjVopZa1lopyJmYP3whxjTCmFGGMIpZQlxag1AoBzLqVkjCHiep6t9efz+fqVxTm3bdu6rogIiJlImFPOY4zPvveiz3wN55yNteESEkTk9R8Wo826bvu+G2PqeRJRjJGIUkq11j+GQwhK7YjaH14jhhBba/evx+vPm601j8dDKQBQSoH3vpQiIqUWZhaRS0VOxCylEFE9KzGxCAsvRNlZexyH9z6EK6SUOebbzDFGu7nr3i+PR2+t38Z/AYa+CB3mYzRiAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201101225226\"\n        title=\"20201101225226\"\n        src=\"/static/4c7150294cbc85809a770e5607cce362/f058b/20201101225226.png\"\n        srcset=\"/static/4c7150294cbc85809a770e5607cce362/c26ae/20201101225226.png 158w,\n/static/4c7150294cbc85809a770e5607cce362/6bdcf/20201101225226.png 315w,\n/static/4c7150294cbc85809a770e5607cce362/f058b/20201101225226.png 630w,\n/static/4c7150294cbc85809a770e5607cce362/889a4/20201101225226.png 658w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>服务器收到浏览器发送的请求之后，判断浏览器是否支持 gzip，如果支持 gzip，则向浏览器传送压缩过的内容，不支持则向浏览器发送未经压缩的内容。如果支持，response\r\nheaders 返回 <code class=\"language-text\">content-encoding:gzip</code></li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 613px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ea12b70a900a17c75d63b8f23137f6cb/5754a/20201101225238.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.37974683544304%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAhElEQVQY05XLyxKCMAxGYd7/NSEO/KWhlCS9AMXRcS36Lc7udMwecNM0hRD2fReRnPP1my6ZPd4AMC/XP7qUEtFARACccynnq7XjOFpr97OqOmDhhZnneY5xVVXZ4tnO+9nUaKC+HwCsYRURFf0wu5tNx3EE4L3fYqy1llJKfqXW+n1+AlssXpezGQZ/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201101225238\"\n        title=\"20201101225238\"\n        src=\"/static/ea12b70a900a17c75d63b8f23137f6cb/5754a/20201101225238.png\"\n        srcset=\"/static/ea12b70a900a17c75d63b8f23137f6cb/c26ae/20201101225238.png 158w,\n/static/ea12b70a900a17c75d63b8f23137f6cb/6bdcf/20201101225238.png 315w,\n/static/ea12b70a900a17c75d63b8f23137f6cb/5754a/20201101225238.png 613w\"\n        sizes=\"(max-width: 613px) 100vw, 613px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>浏览器接收到服务器的响应之后判断内容是否被压缩，如果被压缩则解压缩并显示页面内容。</li>\n</ul>\n<p><strong>实践：NGINX 与 GZIP</strong></p>\n<p>下面是一个 nginx 配置，是本人部署的一个真实案例。</p>\n<div class=\"gatsby-highlight\" data-language=\"nginxconfiguration\"><pre class=\"language-nginxconfiguration\"><code class=\"language-nginxconfiguration\">\r\nserver{\r\n    # 端口号\r\n    listen       80;\r\n    # 网站文件根目录\r\n    root  /home/web/build;\r\n    # 开启gzip压缩\r\n    gzip on;\r\n    gzip_min_length 1k;\r\n    gzip_buffers 4 16k;\r\n    gzip_comp_level 2;\r\n    gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;\r\n\r\n    # 支持browser路由\r\n    location / {\r\n        try_files $uri $uri/  /index.html;\r\n    }\r\n}</code></pre></div>\n<h3>衡量 JavaScript 脚本</h3>\n<p>可以使用 <code class=\"language-text\">&lt;script></code> 标签的 <code class=\"language-text\">async</code> 和 <code class=\"language-text\">defer</code>：</p>\n<p><strong>defer</strong> 意为“推迟”，在浏览器中体现为<strong>立即下载脚本但推迟执行</strong>。</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Example HTML Page<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">defer</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>example1.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">defer</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>example2.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token comment\">&lt;!-- 这里是页面内容 --></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>defer 是有序的，它会自上而下按顺序执行。</p>\n<p>defer 的<strong>加载</strong>会在 <code class=\"language-text\">DOMContentLoaded</code> 事件之前执行。</p>\n<p><strong>async</strong> 意为“异步”，来看下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Example HTML Page<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">async</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>example1.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">async</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>example2.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token comment\">&lt;!-- 这里是页面内容 --></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>标记为 <code class=\"language-text\">async</code> 的脚本并不保证能按照它们出现的次序执行，但保证会在页面的 <code class=\"language-text\">load</code> 事件前执行。</p>\n<p>这里我想到了一个前端模块化库 — <strong>require.js</strong>。它就是利用 <code class=\"language-text\">async</code> 来实现模块化的。由于 <code class=\"language-text\">async</code> 保证在 <code class=\"language-text\">load</code> 之前执行完成，所以模块的加载顺序就不成问题。有兴趣的可以去了解一下它的原理。</p>\n<h2>面向浏览器的优化</h2>\n<p>浏览器是前端代码的主要载体，如何针对浏览器的一些机制来进行优化就显得非常重要。所以我们需要理解浏览器是如何显示网页的。</p>\n<h3>浏览器如何显示网页？</h3>\n<p>浏览器如何渲染一个网页？主要分为以下步骤：</p>\n<p><strong>DOM 树的生成</strong></p>\n<p>当渲染进程接收 HTML 数据时，<strong>主线程</strong>开始解析 HTML 并将其转换为文档对象模型（DOM）。</p>\n<p>当遇到外链时，会单独开启一个下载线程去下载资源。</p>\n<p>CSS 下载是异步的，不会阻塞浏览器构建 DOM 树，但它会阻塞渲染，也就是在构建渲染树时，会等到 css 下载解析完毕后才进行，这是为了防止 css 规则不断改变，避免了重复的构建。 对于 JS 也是一个道理，当 HTML</p>\n<p>对于 <code class=\"language-text\"> &lt;script></code> 脚本，会暂停解析 HTML 文档，开始加载、解析并执行 JavaScript 代码。因为 JavaScript 可以使用 <code class=\"language-text\">document.write()</code> 的方法来改写文档，这会改变整个 DOM 结构。</p>\n<p>遇到图片等资源时，异步下载，不会阻塞解析，下载完毕后直接用图片<strong>替换</strong>其应该所处的位置即可。</p>\n<p><strong>CSS 规则树的生成</strong></p>\n<p>主线程解析 CSS 并确定每个 DOM 节点计算后的样式。</p>\n<p><strong>布局</strong></p>\n<p>现在，渲染进程知道每个节点的样式和文档的结构，但这不足以渲染页面。</p>\n<p>布局是计算元素几何形状的过程。<strong>主线程</strong>遍历计算样式后的 DOM 树，计算样式并创建<strong>布局树（渲染树）</strong>，其中包含 x 、y 坐标和边界框大小等信息。</p>\n<p>布局树（渲染树）可能与 DOM 树结构类似，但它仅包含页面上<strong>可见内容</strong>相关的信息。</p>\n<p>例如，下面的这些 css 元素不是布局树的一部分：</p>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token selector\">#element</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> none<span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token selector\">p::before</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">content</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Hi!\"</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>利用 <code class=\"language-text\">visibility</code> 和 <code class=\"language-text\">opacity</code> 隐藏的节点，还是会显示在渲染树上的。只有 <code class=\"language-text\">display:none</code> 的节点才不会显示在渲染树上。</strong></p>\n<p><strong>绘制</strong></p>\n<p>拥有 DOM、样式和布局仍然不足以渲染页面。假设你正在尝试重现一幅画。你知道元素的大小、形状和位置，但你仍需要判断绘制它们的顺序。</p>\n<p>在绘制步骤中，<strong>主线程</strong>遍历<strong>布局树</strong>创建绘制记录。绘制记录可以看成是绘图过程的记录。</p>\n<p>下面总结一下全过程：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4fd6e321ede7b36703ac7a36d7fbd129/889a4/20201031201457.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.46835443037975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABd0lEQVQoz3WRzUorQRBG+wHcuHHhE/iivoArQVFBuQsVRUUENRfJIppoDKIGJjEhGc38ZZJp08lMpqurSjqKG7WoRVFQh49TgpmYgAiRCImI6bHWONz5XzgtSzliZoPEf5T4uTJAtZtW2EuY2dL+LpFlbj9aGSbXDU85XjSa6KGSzpsTSA8RX8Jh6cVNNTCzzWVZxAyzJqHGF76/EITrJ9XX3fJ9mKT1TvX0avO5XWbm206wd9cY5/b4ZwaBSADIzGBQA4LBt0Q+uqEvxxooTuKO182mKs2hJ1VfTbUZTfNilheMCcSM+CnLwjIN+3f11cL1peN68eCicnB0tdH12/We3CrdHz94XnwZRYt+OJdOtwURg2Fr2RJshBywN5ikOYABNXmXShKRQUxznWlAJIMDMH1ELZL3c6e11GwvFxvRv1LVjdVTq3JW3G6+1r5NE//uXIzGa0E074c73Th/9oK+VE23/tSsRMPQGkb8+tYM8DUxzpo+AHu09YqqknPBAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20201031201457\"\n        title=\"20201031201457\"\n        src=\"/static/4fd6e321ede7b36703ac7a36d7fbd129/f058b/20201031201457.png\"\n        srcset=\"/static/4fd6e321ede7b36703ac7a36d7fbd129/c26ae/20201031201457.png 158w,\n/static/4fd6e321ede7b36703ac7a36d7fbd129/6bdcf/20201031201457.png 315w,\n/static/4fd6e321ede7b36703ac7a36d7fbd129/f058b/20201031201457.png 630w,\n/static/4fd6e321ede7b36703ac7a36d7fbd129/889a4/20201031201457.png 658w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>网页载入时，上述过程（至少）会执行一次，但是某些操作会导致网页重新渲染，即重新生成布局和重新绘制。前者叫做”回流”（<code class=\"language-text\">reflow</code>），后者叫做”重绘”（<code class=\"language-text\">repaint</code>）。</p>\n<p>结合上面的描述，我们不难得出以下结论：</p>\n<ul>\n<li>要想提高性能，就是要降低”回流”和”重绘”的频率和范围。</li>\n<li>回流必然导致重绘。</li>\n<li>布局改变（例如改变宽高、元素位置）会导致回流，而一些颜色的改变会导致重绘。</li>\n</ul>\n<p>浏览器对一些 DOM 操作行为做了一些优化，可能导致多次重新渲染的操作会被<strong>队列化</strong>，结合到一起：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 理论上一次重绘 + 一次重排（很明显包括重绘了），但浏览器只会触发一次重排和重绘</span>\r\ndiv<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>color <span class=\"token operator\">=</span> <span class=\"token string\">\"blue\"</span>\r\ndiv<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>marginTop <span class=\"token operator\">=</span> <span class=\"token string\">\"30px\"</span></code></pre></div>\n<p>但有些操作会强制刷新队列，引起重绘：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">offsetTop、offsetLeft、offsetWidth、offsetHeight\r\nscrollTop、scrollLeft、scrollWidth、scrollHeight\r\nclientTop、clientLeft、clientWidth、clientHeight\r\ngetComputedStyle()\r\ngetBoundingClientRect</code></pre></div>\n<p>这些操作会强制队列刷新，如果要利用他们，尽量将值缓存起来。</p>\n<p>总结一下，主要有下面这些方案：</p>\n<ul>\n<li>在过程中尽可能<strong>缓存</strong>一些布局信息。</li>\n<li>使用<strong>文档片段</strong>（<code class=\"language-text\">fragement</code>），它存在于内存中，并不在 DOM 树中，所以将子元素插入到文档片段时不会引起页面回流（对元素位置和几何上的计算）。\r\n因此，使用文档片段通常会带来更好的性能。可参考<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Document/createDocumentFragment\">MDN 的相关介绍</a>。</li>\n<li>注意样式的修改，不要一条一条地修改，而是一起修改或者改变类名。</li>\n<li><strong>利用 display 属性</strong>，上面提到，<code class=\"language-text\">display:none</code> 不会进入布局树。如果对某个元素有大量的 DOM 操作，我们可以先为其 css 属性为 <code class=\"language-text\">display:none</code>，然后再进行操作，操作完成再恢复，\r\n这样只会触发<strong>两次渲染</strong>。</li>\n<li>使用一些基于<strong>虚拟 DOM</strong> 的前端开发框架，例如 vue、React。</li>\n<li>优化 JavaScript 执行，例如 <code class=\"language-text\">window.requestAnimationFrame()</code>，我们接下来会讲到这一部分。</li>\n</ul>\n<h3>优化 JavaScript 执行</h3>\n<p>首先得知晓一个名词：屏幕刷新率，一秒之间能够完成多少次重新渲染，这个指标就被称为”刷新率”（FPS）。大多数设备为 60 次/秒。</p>\n<p>如果在页面中有一个动画或渐变效果，或者用户正在滚动页面，那么浏览器渲染动画或页面的每一帧的速率也<strong>需要跟设备屏幕的刷新率保持一致</strong>。其中每个帧的预算时间为 (1 秒/ 60 = 16.66 毫秒)。</p>\n<p>实际上，浏览器有额外工作要做，因此您的所有工作需要在 10 毫秒内完成。如果无法符合此预算，帧率将下降，并且内容会在屏幕上抖动。 此现象通常称为卡顿，会对用户体验产生负面影响。</p>\n<p>每一帧的工作流程如下所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/193c9/frame-full.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.18987341772152%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAAB1azKQJ//xAAXEAEBAQEAAAAAAAAAAAAAAAAAAQIR/9oACAEBAAEFAtRxI//EABURAQEAAAAAAAAAAAAAAAAAAAIQ/9oACAEDAQE/AVP/xAAWEQADAAAAAAAAAAAAAAAAAAACEDL/2gAIAQIBAT8BGF//xAAUEAEAAAAAAAAAAAAAAAAAAAAQ/9oACAEBAAY/An//xAAbEAABBAMAAAAAAAAAAAAAAAAAARExkUFRYf/aAAgBAQABPyFJlmdje2INmz//2gAMAwEAAgADAAAAEPfv/8QAFREBAQAAAAAAAAAAAAAAAAAAEDH/2gAIAQMBAT8Qg//EABYRAQEBAAAAAAAAAAAAAAAAAAABMf/aAAgBAgEBPxDRI//EABsQAAEEAwAAAAAAAAAAAAAAAAEAETFRIXHR/9oACAEBAAE/ECHDoJB2Z36nzMrr/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"frame full\"\n        title=\"frame full\"\n        src=\"/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/828fb/frame-full.jpg\"\n        srcset=\"/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/ff44c/frame-full.jpg 158w,\n/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/a6688/frame-full.jpg 315w,\n/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/828fb/frame-full.jpg 630w,\n/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/0ede0/frame-full.jpg 945w,\n/static/dc48e4bd5b41dac0b0e8cb64a8e603c9/193c9/frame-full.jpg 1093w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>我们上面一直在说减少重排、重绘，用类似的图来表达就是这样，这是我们最期望的效果：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c91ff089a7a0512aeffd63e0c53dfa97/193c9/frame-no-layout-paint.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 15.18987341772152%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEC/9oADAMBAAIQAxAAAAHVnJawI//EABcQAQEBAQAAAAAAAAAAAAAAAAEAAkL/2gAIAQEAAQUC0XIX/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQMBAT8BZ//EABYRAAMAAAAAAAAAAAAAAAAAAAIQMv/aAAgBAgEBPwEZX//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABsQAAICAwEAAAAAAAAAAAAAAAABETFBUZGh/9oACAEBAAE/IVQ7vY14ERnp/9oADAMBAAIAAwAAABD77//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABURAQEAAAAAAAAAAAAAAAAAAAAB/9oACAECAQE/EBI//8QAHBAAAQQDAQAAAAAAAAAAAAAAAQARITFBUWFx/9oACAEBAAE/ECHj4EhPE43xPk23X//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"frame no layout paint\"\n        title=\"frame no layout paint\"\n        src=\"/static/c91ff089a7a0512aeffd63e0c53dfa97/828fb/frame-no-layout-paint.jpg\"\n        srcset=\"/static/c91ff089a7a0512aeffd63e0c53dfa97/ff44c/frame-no-layout-paint.jpg 158w,\n/static/c91ff089a7a0512aeffd63e0c53dfa97/a6688/frame-no-layout-paint.jpg 315w,\n/static/c91ff089a7a0512aeffd63e0c53dfa97/828fb/frame-no-layout-paint.jpg 630w,\n/static/c91ff089a7a0512aeffd63e0c53dfa97/0ede0/frame-no-layout-paint.jpg 945w,\n/static/c91ff089a7a0512aeffd63e0c53dfa97/193c9/frame-no-layout-paint.jpg 1093w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>Style</strong> 指样式计算。此过程是根据匹配选择器计算出哪些元素应用哪些 CSS 规则的过程，这个过程不仅包括计算层叠样式表中的权重来确定样式，也包括内联的样式，来计算每个元素的最终样式。\r\n<strong>Composite</strong> 指合成。由于页面的各部分可能被绘制到多个层上，因此它们需要按正确顺序绘制到屏幕上，才能正确地渲染页面。</p>\n<h4>使用 requestAnimationFrame 执行动画</h4>\n<p>为什么要用它？使用 <code class=\"language-text\">setTimeout()</code> 不好吗？事实上，JS 的执行会<strong>阻止渲染</strong>（js 主线程和渲染线程是互斥的），请看下图来理解：</p>\n<p>图中 <code class=\"language-text\">Frame</code> 代表一帧，但是 <code class=\"language-text\">js</code> 的执行让某些帧无法执行，导致丢帧，在用户面前体现为卡顿</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6e35a283b1b93f266a18f739475db1ea/00d43/pagejank2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABEElEQVQY02WOXUvCUACG93eiSymi/9A/DLqKVJAhzDaxIpq0ue+50fSoZ1+OmbZFw7k5zzkLqYug5+K9eS7eh6r/Qo6zzXPDtHXD8vxQHKmuFxwNIfU/qH2RI4QIPuyLHUYlqRIwMbI0WHp2li6Td7jLIlKluPrEqKrKAiGEMSaEYIyp5miRH7DuzHqTbf3F19LJx1OjfG0E3OWEPvPZ89q8wOJpbV8JpsY6yW/ez/OzNB48PLY6tGiBHtMdcJ23sXB3ey2JL9w93aWbji2xTJtl2oKi3rRoTVN5nuf6/eFwSME5gBAqihxHIQAzWdHWm1RWdADm0PVVVY+i1QJ6gihtNmvLNKbTaRiGruvGcfwNvBIA+ozyqlsAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pagejank2\"\n        title=\"pagejank2\"\n        src=\"/static/6e35a283b1b93f266a18f739475db1ea/f058b/pagejank2.png\"\n        srcset=\"/static/6e35a283b1b93f266a18f739475db1ea/c26ae/pagejank2.png 158w,\n/static/6e35a283b1b93f266a18f739475db1ea/6bdcf/pagejank2.png 315w,\n/static/6e35a283b1b93f266a18f739475db1ea/f058b/pagejank2.png 630w,\n/static/6e35a283b1b93f266a18f739475db1ea/40601/pagejank2.png 945w,\n/static/6e35a283b1b93f266a18f739475db1ea/00d43/pagejank2.png 1000w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>于是我们使用 <code class=\"language-text\">requestAnimationFrame()</code> 来解决这个问题，它的原理是在每一次重绘前执行相应的 js 代码，来达到下图的理想状态：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b1959d9953869798ba89282c6533bd2/00d43/raf.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABEklEQVQY0z3Pa0+CUADGcb7/B6h3bW2mc3htuXDEZYhyFQR1ReblGFrERcjjCTbgtK6/V/+Xz0NwpoN2tfvlUp3pOOiqTrhyuscXkbX2x10dPD+ObLt8JceLYD7vYySVGOOywN8I2gk31kVPkJSNu1LOOvp+sRYVvnLroKV1yQ0FCfgr9bwtre2nMbDJjwz7b57rulEUESOB698NWw3SMsbXPfam05hNH65qDXnA9elBq9WeT0yKFpv16sScVqpNlmUYhqEoiud5osQ4TVOw3aZZhk4wThIIj1EUxsk7OkE/CA5xjBAMo0Oe/679R2CMi6LwPA8AoGmaoiiyLKuqahiGruuappmm+dMQwq+/f/I8/wS49gASG27MDgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"raf\"\n        title=\"raf\"\n        src=\"/static/7b1959d9953869798ba89282c6533bd2/f058b/raf.png\"\n        srcset=\"/static/7b1959d9953869798ba89282c6533bd2/c26ae/raf.png 158w,\n/static/7b1959d9953869798ba89282c6533bd2/6bdcf/raf.png 315w,\n/static/7b1959d9953869798ba89282c6533bd2/f058b/raf.png 630w,\n/static/7b1959d9953869798ba89282c6533bd2/40601/raf.png 945w,\n/static/7b1959d9953869798ba89282c6533bd2/00d43/raf.png 1000w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>下面的案例来自 <a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame\">MDN</a> ：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some-element-you-want-to-animate\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">let</span> start\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">step</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">timestamp</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>start <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> start <span class=\"token operator\">=</span> timestamp\r\n  <span class=\"token keyword\">const</span> elapsed <span class=\"token operator\">=</span> timestamp <span class=\"token operator\">-</span> start\r\n  <span class=\"token comment\">//这里使用 `Math.min()` 确保元素刚好停在200px的位置。</span>\r\n  element<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>transform <span class=\"token operator\">=</span> <span class=\"token string\">\"translateX(\"</span> <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">min</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span> <span class=\"token operator\">*</span> elapsed<span class=\"token punctuation\">,</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"px)\"</span>\r\n  <span class=\"token comment\">// 在两秒后停止动画</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elapsed <span class=\"token operator\">&lt;</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 若你想在浏览器下次重绘之前继续更新下一帧动画，</span>\r\n    <span class=\"token comment\">// 那么回调函数自身必须再次调用 window.requestAnimationFrame()</span>\r\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span>\r\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span>step<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">window.requestAnimationFrame(callback)</code> 告诉浏览器——你希望执行一个动画，并且要求浏览器在下次重绘之前调用指定的回调函数更新动画，它的执行频率和屏幕刷新次数相匹配。</p>\n<h4>在 <code class=\"language-text\">window.requestIdleCallback()</code> 执行低优先级的逻辑</h4>\n<p><code class=\"language-text\">window.requestIdleCallback()</code> 指定只有当一帧的末尾有空闲时间，才会执行回调函数。从上面的信息可以得知，当前帧的运行时间少于每个帧的预算时间 <strong>16.66 毫秒</strong>时会执行回调。</p>\n<h4>使用防抖和节流</h4>\n<p>防抖节流一个常见的对象就是输入处理程序，正如上面所说，频繁执行 js 会导致卡帧，甚至导致额外（且不必要）的布局工作，另外结合其它的业务也会导致额外请求开支（例如请求校验）。</p>\n<p>防抖节流都是为了<strong>控制事件触发频率</strong>来实现性能的优化，其原理都依赖 JavaScript 的闭包。 例如输入框，我们希望用户输入<strong>停止</strong>了，再去远程校验，或者是去获取搜索信息，核心思想是<strong>等用户停下来再执行</strong>.</p>\n<p>来看下面的防抖（debounce）代码，网页中有一个输入框，用户不断输入内容，如果用户输入停止超过 1 秒则打印 <code class=\"language-text\">Input Event</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>防抖和节流<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span><span class=\"token punctuation\">></span></span>\r\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">placeholder</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>请输入内容....<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>test-input<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\r\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">debounce</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> delay</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">let</span> timer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">}</span>\r\n          timer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">const</span> input <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test-input\"</span><span class=\"token punctuation\">)</span>\r\n      input<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">\"input\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span>\r\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>来看下面的节流（throttle）代码，网页中有一个 div，用户鼠标不断在其中移动，我们监听鼠标的移动，每隔 1s 打印 <code class=\"language-text\">Mouse Event</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>防抖和节流<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">\r\n      <span class=\"token selector\">#test-div</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100px<span class=\"token punctuation\">;</span>\r\n        <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100px<span class=\"token punctuation\">;</span>\r\n        <span class=\"token property\">background-color</span><span class=\"token punctuation\">:</span> #409eff<span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>test-div<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>测试节流<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\r\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\r\n      <span class=\"token comment\">// 节流函数</span>\r\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">throttle</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> delay</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">let</span> timer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token keyword\">return</span>\r\n          <span class=\"token punctuation\">}</span>\r\n          timer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 箭头函数没有arguments类数组对象</span>\r\n            timer <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> delay<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token comment\">// 第二种写法 根据时间来判断</span>\r\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">throttle2</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn<span class=\"token punctuation\">,</span> delay</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">let</span> pre <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token keyword\">let</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>now <span class=\"token operator\">-</span> pre <span class=\"token operator\">></span> delay<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n            <span class=\"token function\">fn</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\r\n            pre <span class=\"token operator\">=</span> now\r\n          <span class=\"token punctuation\">}</span>\r\n        <span class=\"token punctuation\">}</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">const</span> div <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test-div\"</span><span class=\"token punctuation\">)</span>\r\n      div<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">\"mousemove\"</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token function\">throttle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n          console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span>\r\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\r\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h4>使用 Web Worker</h4>\n<p>在许多情况下，可以将纯计算工作移到 <code class=\"language-text\">Web Worker</code>，数据操作或遍历（例如排序或搜索）、复杂的加密算法、复杂 canvas 的渲染往往很适合这种模型。</p>\n<p>Web Worker 的 API 使用这里不再赘述，<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers\">MDN</a>\r\n上讲的非常详细且通俗易懂。</p>\n<h2>参考资料</h2>\n<ul>\n<li>\n<p>Paul Lewis，<a href=\"https://developers.google.cn/web/fundamentals/performance/rendering\">Rendering Performance</a></p>\n</li>\n<li>\n<p>MDN，<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame\">requestAnimationFrame</a></p>\n</li>\n<li>\n<p>MDN，<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback\">requestIdleCallback</a></p>\n</li>\n<li>\n<p>Mariko Kosaka，<a href=\"https://developers.google.com/web/updates/2018/09/inside-browser-part1\">Inside look at modern web browser</a></p>\n</li>\n</ul>","frontmatter":{"title":"谈谈前端性能优化","date":"November 07, 2021","description":null},"timeToRead":17},"previous":{"fields":{"slug":"/2021-09/How-https-ensure-web-security/"},"frontmatter":{"title":"HTTPS如何确保安全性？"}},"next":{"fields":{"slug":"/2021-11/event-loop/"},"frontmatter":{"title":"分析浏览器和 NodeJS 的事件循环"}}},"pageContext":{"id":"57275088-ec7a-5e67-9df3-0ac1701f74db","previousPostId":"1f0838dc-61cc-58e8-a9c5-e46387469d86","nextPostId":"a7dff7dd-79d9-50d7-852a-c35ff1dbba40"}},"staticQueryHashes":["2841359383","3415673938"]}