{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11/express-and-koa/","result":{"data":{"site":{"siteMetadata":{"title":"好成的blog"}},"markdownRemark":{"id":"9c468c35-f83c-5e49-9b6e-44c54264790f","excerpt":"本文将结合源码剖析 node.js 的两款优秀框架 express 和 koa 的原理。本文假设读者已对这两款框架有所了解，并会简单使用。 express 中间件的注册 来看下面的 DEMO，它可以启动一个 express…","html":"<p>本文将结合源码剖析 <strong>node.js</strong> 的两款优秀框架 <strong>express</strong> 和 <strong>koa</strong> 的原理。本文假设读者已对这两款框架有所了解，并会简单使用。</p>\n<h2>express</h2>\n<h3>中间件的注册</h3>\n<p>来看下面的 DEMO，它可以启动一个 express 服务器：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token comment\">/* 中间件M1 */</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件M2 */</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 02 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token string\">\"/home\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件M3 */</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 01\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件M4 */</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 02\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件M5 */</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 03\"</span><span class=\"token punctuation\">)</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"your project is running successfully!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>其中，函数体 <code class=\"language-text\">(req, res, next) => {}</code> 被称为<strong>中间件函数</strong>（下文所有提到的中间件函数均指这种形式的函数体），中间件函数能够访问请求对象 (req)、响应对象 (res)\r\n以及应用程序的请求/响应循环中的下一个中间件函数。下一个中间件函数通常由名为 <strong>next</strong> 的变量来表示，通过调用函数 <code class=\"language-text\">next()</code> 可以将控制权转移到下一个中间件函数中。</p>\n<h4>express 应用程序的创建 — require(“express”)</h4>\n<p>我们都知道，<code class=\"language-text\">require(\"express\")</code> 所得到的值是一个函数，JavaScript 中的函数也是对象，所以它可以拥有各种成员变量例如 <code class=\"language-text\">app.use</code>，点进去我们就可以看到它的实现 <code class=\"language-text\">createApplication()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">exports <span class=\"token operator\">=</span> module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> createApplication\r\n<span class=\"token keyword\">function</span> <span class=\"token function\">createApplication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">app</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    app<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">mixin</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">mixin</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> proto<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// expose the prototype that will get set on requests</span>\r\n  app<span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n    app<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> enumerable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// expose the prototype that will get set on responses</span>\r\n  app<span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n    app<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> configurable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> enumerable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> writable<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> value<span class=\"token operator\">:</span> app <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> app\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>app 从一个中间件函数开始，调用 app 会执行 <code class=\"language-text\">app.handle(req, res, next)</code></p>\n<p>接着，通过 <code class=\"language-text\">mixin</code> 方法将一些成员合并到 app 上，然后执行一些初始化工作：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">mixin</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">mixin</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">,</span> proto<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>我们常见的 <code class=\"language-text\">app.use()</code>、<code class=\"language-text\">app.get()</code> 方法就是来自上面的 <code class=\"language-text\">proto</code>，下面我们分析 <code class=\"language-text\">app.use()</code>。</p>\n<h3>app.use() —中间件的注册</h3>\n<p>这个函数要求我们传入一个中间件函数，我们可以传入一个路径 + 一个或多个中间件函数，或者仅传入一个或多个中间件函数。它的流程如下：</p>\n<ul>\n<li>在 this.lazyrouter() 之前的代码都是处理参数的，它会从参数中拿到路径（如果有的话）和若干个中间件函数，并调用 <code class=\"language-text\">flatten</code> 来将他们扁平化（其实就是把它们传到一个数组里面了）：</li>\n<li>调用 <code class=\"language-text\">this.lazyrouter()</code> 初始化路由，接下来会讲。</li>\n<li>利用 <code class=\"language-text\">Array.prototype.forEach()</code> 遍历上面扁平化的 <code class=\"language-text\">fns</code>。</li>\n<li>在 forEach 回调函数体中，普通的中间件会执行 <code class=\"language-text\">router.use(path, fn)</code>。</li>\n<li>最后，返回 <strong>this</strong>，也就是 <strong>app</strong>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">use</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\r\n  <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token string\">\"/\"</span>\r\n  <span class=\"token comment\">// default path to '/'</span>\r\n  <span class=\"token comment\">// disambiguate app.use([fn])</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> arg <span class=\"token operator\">=</span> fn\r\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> arg<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      arg <span class=\"token operator\">=</span> arg<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// first arg is the path</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> arg <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      offset <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\r\n      path <span class=\"token operator\">=</span> fn\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">var</span> fns <span class=\"token operator\">=</span> <span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fns<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"app.use() requires a middleware function\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token comment\">// setup router</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lazyrouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">var</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router\r\n  fns<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// non-express app</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fn <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>fn<span class=\"token punctuation\">.</span>handle <span class=\"token operator\">||</span> <span class=\"token operator\">!</span>fn<span class=\"token punctuation\">.</span>set<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> router<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 这里是重点</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".use app under %s\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span>\r\n    fn<span class=\"token punctuation\">.</span>mountpath <span class=\"token operator\">=</span> path\r\n    fn<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\r\n    <span class=\"token comment\">// restore .app property on req and res</span>\r\n    router<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token function\">mounted_app</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> orig <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>app\r\n      fn<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">setPrototypeOf</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> orig<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">setPrototypeOf</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> orig<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span>\r\n        <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token comment\">// mounted an app</span>\r\n    fn<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"mount\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们可以提炼出两个核心方法，一个是 <code class=\"language-text\">this.lazyrouter()</code>，还有一个是 <code class=\"language-text\">router.use(path, fn)</code>。</p>\n<h3>this.lazyrouter() — 全局路由初始化</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">lazyrouter</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">lazyrouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Router</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      caseSensitive<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enabled</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"case sensitive routing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      strict<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">enabled</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"strict routing\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"query parser fn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>middleware<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这个函数用来初始化路由，如果 <code class=\"language-text\">this._router</code> 不存在（这里的 this 是 app），那么我们会 new 一个 <strong>Router</strong> 对象，并赋值给它。</p>\n<p>然后执行 <code class=\"language-text\">this._router</code> 的 <code class=\"language-text\">use</code> 方法，<strong>注册了两个中间件</strong> <code class=\"language-text\">query(this.get('query parser fn'))</code> 和 <code class=\"language-text\">middleware.init(this)</code>。</p>\n<p>还记得上面对用户传入的中间件函数的遍历吗？express 对每一个中间件函数都会调用 <code class=\"language-text\">router.use(path, fn)</code> 方法。所以 <code class=\"language-text\">app.use(middleWares)</code>\r\n<strong>本质上</strong>就是 <code class=\"language-text\">router.use(middleWares)</code></p>\n<p>也就是说，中间件会被注册到**相对应的路由（Router 对象）**中。在上面的代码中就是全局路由，相应的路径为 <code class=\"language-text\">/</code>。接下来我们分析 <code class=\"language-text\">router.use(path, fn)</code>。</p>\n<h1>中间件的注册</h1>\n<h4>router.use(path, fn)</h4>\n<p>这个函数位于 <code class=\"language-text\">router/index.js</code> 下，我们注意到：</p>\n<ul>\n<li>首先还是进行参数处理，扁平化若干个中间件函数，如果数量为 0 会抛出异常。</li>\n<li>遍历每个中间件函数，对每个中间件函数，我们会 new 一个 <strong>Layer</strong> 对象出来，然后把这个对象 push 到一个栈中，根据 this 的指向，这个栈是属于 Router 对象的，在这里是全局 Router 对象。</li>\n<li>最终返回 this，也就是 router 对象。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">proto<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">use</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> offset <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\r\n  <span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token string\">\"/\"</span>\r\n  <span class=\"token comment\">// default path to '/'</span>\r\n  <span class=\"token comment\">// disambiguate router.use([fn])</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> arg <span class=\"token operator\">=</span> fn\r\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> arg<span class=\"token punctuation\">.</span>length <span class=\"token operator\">!==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      arg <span class=\"token operator\">=</span> arg<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// first arg is the path</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> arg <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      offset <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\r\n      path <span class=\"token operator\">=</span> fn\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">var</span> callbacks <span class=\"token operator\">=</span> <span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">,</span> offset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callbacks<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Router.use() requires a middleware function\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> callbacks<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> callbacks<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n    <span class=\"token comment\">// add the middleware</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use %o %s\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token string\">\"&lt;anonymous>\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">var</span> layer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Layer</span><span class=\"token punctuation\">(</span>\r\n      path<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">{</span>\r\n        sensitive<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>caseSensitive<span class=\"token punctuation\">,</span>\r\n        strict<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n        end<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n      fn\r\n    <span class=\"token punctuation\">)</span>\r\n    layer<span class=\"token punctuation\">.</span>route <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>综上所述，我们可以轻松得出以下结论：</p>\n<ul>\n<li>app.use 在没有传路径时会以 <code class=\"language-text\">/</code> 也就是全局路由作为路径。</li>\n<li><code class=\"language-text\">/</code> 在 express 底层代表了一个 Router 对象，它维护了一个<strong>栈</strong>，栈中的每一个元素被称为层（即上面的 Layer 对象），每一层维护相应的中间件函数。</li>\n<li>中间件的注册本质上就是将一个或者多个中间件函数压入对应的路由栈。</li>\n</ul>\n<p>带着这个结论，我们再来看看 <code class=\"language-text\">app[method]</code> 方法。</p>\n<h4>app[method] 方法</h4>\n<p>app[method] 代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">methods<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">method</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  app<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>method <span class=\"token operator\">===</span> <span class=\"token string\">\"get\"</span> <span class=\"token operator\">&amp;&amp;</span> arguments<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// app.get(setting)</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">lazyrouter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">var</span> route <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router<span class=\"token punctuation\">.</span><span class=\"token function\">route</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\r\n    route<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">,</span> <span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>首先通过 <code class=\"language-text\">this.lazyrouter()</code> 初始化 全局 router（如果没有被初始化过）。</li>\n<li>接着执行 <code class=\"language-text\">this._router.route(path)</code> 来初始化<strong>当前路径</strong>所对应的路由，在上面的 DEMO 中，当前路径为 <code class=\"language-text\">/home</code>。</li>\n<li>然后执行 <code class=\"language-text\">route[method]</code>。</li>\n</ul>\n<p>所以 app[method] 的本质就是为所配置的路径初始化对应的路由，然后执行 <code class=\"language-text\">route[method]</code>。</p>\n<p>下面是 <code class=\"language-text\">this._router.route(path)</code> 代码：</p>\n<ul>\n<li>它以我们设置的路径为参数， new 了一个 <strong>Router</strong> 对象。</li>\n<li>初始化了一个 <strong>Layer</strong>，之后将这个 Layer 压入栈中，注意，这里的 <code class=\"language-text\">this</code> 为 <code class=\"language-text\">app.\\_router</code>，也就是全局 router 对象。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">proto<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">route</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">route</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> route <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Route</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">var</span> layer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Layer</span><span class=\"token punctuation\">(</span>\r\n    path<span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">{</span>\r\n      sensitive<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>caseSensitive<span class=\"token punctuation\">,</span>\r\n      strict<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>strict<span class=\"token punctuation\">,</span>\r\n      end<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    route<span class=\"token punctuation\">.</span><span class=\"token function\">dispatch</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">)</span>\r\n  layer<span class=\"token punctuation\">.</span>route <span class=\"token operator\">=</span> route\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> route\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果对前面的代码还有印象的话，在 执行 new Layer() 时，我们传入的第二个参数是我们的中间件函数，在这里是 <code class=\"language-text\">route.dispatch.bind(route)</code>，这是用来处理用户请求的核心方法，我们后面会讲。</p>\n<p>再来看 <code class=\"language-text\">route[method]</code> ，这里就是我们传入的若干个中间件函数被处理的地方，注意，这里的 this 是我们 new 的 Route 对象（对应 home 路径）：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Route</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> handles <span class=\"token operator\">=</span> <span class=\"token function\">flatten</span><span class=\"token punctuation\">(</span><span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> handles<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> handle <span class=\"token operator\">=</span> handles<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> handle <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> type <span class=\"token operator\">=</span> <span class=\"token function\">toString</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>handle<span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">var</span> msg <span class=\"token operator\">=</span>\r\n        <span class=\"token string\">\"Route.\"</span> <span class=\"token operator\">+</span> method <span class=\"token operator\">+</span> <span class=\"token string\">\"() requires a callback function but got a \"</span> <span class=\"token operator\">+</span> type\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s %o\"</span><span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">var</span> layer <span class=\"token operator\">=</span> <span class=\"token function\">Layer</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> handle<span class=\"token punctuation\">)</span>\r\n    layer<span class=\"token punctuation\">.</span>method <span class=\"token operator\">=</span> method\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>methods<span class=\"token punctuation\">[</span>method<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>首先依然是我们熟悉的中间件函数扁平化，然后遍历结果数组，对每一个中间件函数，执行 Layer 函数，值得注意的是，我们之前的 Layer 都是通过 new 操作符来创建的，这里有些不同。实际上 Layer 函数会根据 this\r\n来判断是否需要 new Layer 对象：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Layer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">path<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Layer</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Layer</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"new %o\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">var</span> opts <span class=\"token operator\">=</span> options <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handle <span class=\"token operator\">=</span> fn\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> fn<span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token string\">\"&lt;anonymous>\"</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>params <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>path <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>regexp <span class=\"token operator\">=</span> <span class=\"token function\">pathRegexp</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>keys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> opts<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// set fast path flags</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>regexp<span class=\"token punctuation\">.</span>fast_star <span class=\"token operator\">=</span> path <span class=\"token operator\">===</span> <span class=\"token string\">\"*\"</span>\r\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>regexp<span class=\"token punctuation\">.</span>fast_slash <span class=\"token operator\">=</span> path <span class=\"token operator\">===</span> <span class=\"token string\">\"/\"</span> <span class=\"token operator\">&amp;&amp;</span> opts<span class=\"token punctuation\">.</span>end <span class=\"token operator\">===</span> <span class=\"token boolean\">false</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看出，如果 this 不是 Layer 的实例，那我们会 new 一个 Layer。否则会对 this 执行一些初始化操作。</p>\n<p>也就是说，执行 <code class=\"language-text\">new Layer()</code> 时会<strong>递归调用</strong>这个函数，但是在 new 之后的 this 已经变成了 Layer 的实例了，也就顺理成章地去处理下面一些初始化代码。</p>\n<p>接下来两行代码很好理解，一个是标记当前的请求类型，一个是标记可选的请求类型。</p>\n<p>最后，将这个 layer 压入栈中，注意，这里的 this 是 对应 home 路径的 Route 对象，和我们前面提到的全局 router 栈不一样！</p>\n<p>至此，<code class=\"language-text\">app[method]</code> 执行完成，总结一下， 执行 <code class=\"language-text\">app[method](path, fns)</code> 会为路径 path 新建一个与之对应的 <code class=\"language-text\">Route</code> 对象，这个 Route 也维护了一个栈，栈里面是用 Layer\r\n对象包装的一个个中间件函数。</p>\n<h3>PART 1 总结</h3>\n<p>上面的内容都围绕着一个内容展开： <strong>中间件函数是如何被初始化</strong>的？</p>\n<p>一句话概括：我们通过调用 <code class=\"language-text\">app.use</code> 方法或者 <code class=\"language-text\">app[method]</code> 方法，为我们传入的路径初始化一个 Router 对象，这个对象维护了一个<strong>栈</strong>，相应的中间件函数通过 Layer\r\n对象包装，然后被压入栈中，对于子路由，它会通过中间件函数 <code class=\"language-text\">route.dispatch</code>（后面会说）和全局路由建立关系。</p>\n<p>我们通过调试工具验证一下上述结果：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b51e02ea7be877a7d1f1a6abd360233/ddf4f/20210102111810.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.0379746835443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABaklEQVQozy3QWY7jMAwEUB+mY2uXLFKUqMVLnJ7c/0YDGw088Kvqozgx/SbcXGCp86yzUoQCV5WiRC8waKquNluSr8VVMkWbIk1RN55KOzNfSAfinhxz6JvJu29VUZ7jWKKHE8oX+cPbVct3pH9Mv9oPqfNEZQBUt7LTaftx75c/f3x/BX4FWAAE+jBienPav7VXOgmukj42bELRBLnnsnG7Srt8HDY0A4cKzcRdGp5VgvRJeATHbV7LvKYlBolC0V0udUMa8PCOvaLVZKezMUXoPCtCOKPbo+Ns67BcFCmZ/sq8HZi6j8VD1ZqcAC8AFqAlgoBVwB63C3eAYcJNmCJUftDkoa8wfKjaZaVJyKRksuJ+dZ7X8fKsc8QzxHPFjtQoHgxvXA9l6xTpwHRg2iOOEIdxTT/MQ+uyWgZ4Wz+sLy6wc83bZm2TukzmL9eN69Z364d7POmhbI2+x3BoWxeZFkn3VWm5Z6f/Nn1sENMP7BkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210102111810\"\n        title=\"20210102111810\"\n        src=\"/static/4b51e02ea7be877a7d1f1a6abd360233/f058b/20210102111810.png\"\n        srcset=\"/static/4b51e02ea7be877a7d1f1a6abd360233/c26ae/20210102111810.png 158w,\n/static/4b51e02ea7be877a7d1f1a6abd360233/6bdcf/20210102111810.png 315w,\n/static/4b51e02ea7be877a7d1f1a6abd360233/f058b/20210102111810.png 630w,\n/static/4b51e02ea7be877a7d1f1a6abd360233/40601/20210102111810.png 945w,\n/static/4b51e02ea7be877a7d1f1a6abd360233/78612/20210102111810.png 1260w,\n/static/4b51e02ea7be877a7d1f1a6abd360233/ddf4f/20210102111810.png 1624w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>下面我们重点讲述中间件如何被执行。</p>\n<h3>中间件的执行</h3>\n<p>我们以上图的代码为例，使用接口调试工具发起 get 请求，访问 <strong>localhost:8000/home</strong>，发起请求之后控制台输出如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">middleware 01 in app.use\r\nmiddleware 02 in app.use\r\nhome and get method middleware 01\r\nhome and get method middleware 02\r\nhome and get method middleware 03</code></pre></div>\n<p>为什么是这样的输出顺序？这些中间件是如何被回调的？我们从 <code class=\"language-text\">app.listen()</code> 开始详细分析整个过程。</p>\n<h4>app.listen()</h4>\n<p>代码如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">listen</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>server<span class=\"token punctuation\">,</span> arguments<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>app.listen() 实际上是执行 node.js 内部的 http 模块的 API <code class=\"language-text\">http.createServer(this)</code> 来创建一个服务器，然后调用 <code class=\"language-text\">server.listen()</code> 来监听端口。</p>\n<p>每当有 HTTP 请求到达服务器时，createServer 中传入的函数就被自动执行，在这里传入的回调函数是 app，这个函数我们在 <code class=\"language-text\">createApplication()</code> 中提到过：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> <span class=\"token function-variable function\">app</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  app<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>所以用户发起请求之后，express 内部会去执行 <code class=\"language-text\">app.handle()</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> router <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_router\r\n  <span class=\"token comment\">// final handler</span>\r\n  <span class=\"token keyword\">var</span> done <span class=\"token operator\">=</span>\r\n    callback <span class=\"token operator\">||</span>\r\n    <span class=\"token function\">finalhandler</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      env<span class=\"token operator\">:</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"env\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      onerror<span class=\"token operator\">:</span> <span class=\"token function\">logerror</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// no routes</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>router<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"no routes defined on app\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  router<span class=\"token punctuation\">.</span><span class=\"token function\">handle</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> done<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>不难看出 <code class=\"language-text\">app.handle()</code> 实质是执行 <code class=\"language-text\">app._router.handle()</code> 。</p>\n<h4>router.handle()</h4>\n<p><code class=\"language-text\">router.handle()</code> 的代码很长，下面的代码我做了精简，但足以表达中间件调用的核心流程，结合注释理解：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">proto<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handle</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> out</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\r\n  <span class=\"token comment\">// 将 next 函数绑定到 req 对象下</span>\r\n  req<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> next\r\n  <span class=\"token comment\">// 执行一次 next 函数</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\r\n    <span class=\"token keyword\">var</span> layer <span class=\"token comment\">// 匹配到的层</span>\r\n    <span class=\"token keyword\">var</span> match <span class=\"token comment\">// 是否匹配成功</span>\r\n    <span class=\"token keyword\">var</span> route <span class=\"token comment\">// 该层是路由层，它会从 undefined 变成相应的路由对象</span>\r\n    <span class=\"token comment\">// 这个循环遍历 stack 数组，匹配对应的层，一旦匹配成功就会跳出循环</span>\r\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>match <span class=\"token operator\">!==</span> <span class=\"token boolean\">true</span> <span class=\"token operator\">&amp;&amp;</span> idx <span class=\"token operator\">&lt;</span> stack<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 当前层</span>\r\n      layer <span class=\"token operator\">=</span> stack<span class=\"token punctuation\">[</span>idx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span>\r\n      <span class=\"token comment\">// 执行路由匹配</span>\r\n      match <span class=\"token operator\">=</span> <span class=\"token function\">matchLayer</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span>\r\n      <span class=\"token comment\">// layer.route，如果该层对应的是路由中间件，那么这个 route 是有值的，它就是相应的 Route 对象。</span>\r\n      route <span class=\"token operator\">=</span> layer<span class=\"token punctuation\">.</span>route\r\n      <span class=\"token comment\">// 如果没有匹配到，再循环</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>match <span class=\"token operator\">!==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">continue</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token comment\">// 没有 route 对象，会被忽略</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>route<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">continue</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>match <span class=\"token operator\">!==</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token function\">done</span><span class=\"token punctuation\">(</span>layerError<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// 保存 route 对象</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      req<span class=\"token punctuation\">.</span>route <span class=\"token operator\">=</span> route\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token comment\">// self.process_params 会调用回调函数，</span>\r\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">process_params</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">,</span> paramcalled<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 如果当前层是路由层</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>route<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> layer<span class=\"token punctuation\">.</span><span class=\"token function\">handle_request</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token comment\">// 一般的中间件层，这个方法的主要内容是 url 路径的处理</span>\r\n      <span class=\"token comment\">// 最后会调用 layer.handle_request(req, res, next) 来处理请求</span>\r\n      <span class=\"token function\">trim_prefix</span><span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">,</span> layerError<span class=\"token punctuation\">,</span> layerPath<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面的代码我们可以分为两部分，第一部分是层匹配，第二部分是层执行。</p>\n<p>层匹配即根据<strong>当前路径</strong>匹配对应的层，如果当前路径是 <code class=\"language-text\">/home</code>，那么全局路由的每一层、<code class=\"language-text\">/home</code> 路由的每一层都会匹配成功。</p>\n<p>层执行指的是对于匹配到的层，我们会通过 <code class=\"language-text\">layer.handle_request()</code> 执行其中的 <code class=\"language-text\">handler</code> 函数。</p>\n<p>对于普通层，执行的是我们注册的中间件。</p>\n<p>对于路由层，执行的是 <code class=\"language-text\">Route.prototype.dispatch</code>。（它本质上也是一个中间件）。</p>\n<p>从上面的代码我们可以看出来普通层多了一步 <code class=\"language-text\">trim_prefix()</code>，它主要是对路径进行了处理，但最终还是会去调用 <code class=\"language-text\">layer.handle_request()</code>。</p>\n<p>在 <code class=\"language-text\">layer.handle_request()</code> 中，中间件函数在一个 <code class=\"language-text\">try..catch</code> 块中被执行。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Layer</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handle_request</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handle\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// not a standard request handler</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>当我们的中间件函数继续调用 next 时，我们就会去栈中寻找上一层，然后以同样的方法执行它。</p>\n<h4>Route.prototype.dispatch()</h4>\n<p>对于非全局路由，我们也会执行一个中间件，这个中间件在路由注册的时候就被导入，下面的代码做了一些精简，删去了一些边界错误处理：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Route</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">dispatch</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> idx <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\r\n  <span class=\"token keyword\">var</span> stack <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>stack\r\n  req<span class=\"token punctuation\">.</span>route <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">var</span> layer <span class=\"token operator\">=</span> stack<span class=\"token punctuation\">[</span>idx<span class=\"token operator\">++</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>layer<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token function\">done</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>layer<span class=\"token punctuation\">.</span>method <span class=\"token operator\">&amp;&amp;</span> layer<span class=\"token punctuation\">.</span>method <span class=\"token operator\">!==</span> method<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    layer<span class=\"token punctuation\">.</span><span class=\"token function\">handle_request</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>不难看出，这部分逻辑和前面的 <code class=\"language-text\">proto.handle()</code> 极为相似。</p>\n<p>前面我们说过，每个路由（Route）对象也会维护一个栈，存储自身匹配的中间件。并且他们会通过这个中间件函数和全局路由进行关联。</p>\n<p>在上面的代码中，我们首先执行了 next 函数，它会获取当前路由栈的第一层，通过 <code class=\"language-text\">handle_request()</code> 执行之，如果用户在回调函数中执行 next 函数，那么又会重复上述操作，直到栈完全遍历位置。</p>\n<h3>PART 2 总结</h3>\n<p>在这一部分里面，我们讨论了 express 框架中间件的执行流程，首先在全局路由中找到第一个符合的层，然后将执行下一个匹配层的 next 作为回调函数的参数传给中间件，在中间件内部调用 next() 函数就可以实现中间件逐层调用的效果。</p>\n<p>在最后，我们解决一下这部分开头的输出问题：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token comment\">/* 中间件 M1 */</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件 M2 */</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 02 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token string\">\"/home\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件 M3 */</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 01\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件 M4 */</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 02\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">/* 中间件 M5 */</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 03\"</span><span class=\"token punctuation\">)</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"your project is running successfully!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>根据第一部分的知识，上面的代码将会构造如下的数据结构：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a42842e89e1cd2af20d2c4bb144daec9/8ce52/20210102152616.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.10126582278481%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABJElEQVQoz5WS246CMBBA/R1pOy0ELIVgqYVpLRSMRvf//2TDkqirZpM9T/MwJ3PdwBuUUkIIpXSNkyQhhDDGCCFCiDRNOedZljHGNs8aY0xKGUKIMSKiEELr1nvf9/0SOL/f753z8zR3XQcAD5lzDgB5XiC60+lkrc3z3BgTxzgMQ13XVVVprRFxnn/LnHNK6Xa7LaV0zk3T1Fl7H+HetpSyR5ymyRizyJVSUkq5k1pr771Squu6GEdr7drLM0op5/2jMvbY6ta0RilV13XTNNbaOI6Hw0EI8SLviqJtW+dc0zSLzH9Y85IkKYrieDxeLhdEhI8wth5i2TZ/AgCK3S6E8HW7hRDgTz6cqizL8/l8u16HYfifDABpmmZZtj7D+8wv8jcWVX3opo1k5gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210102152616\"\n        title=\"20210102152616\"\n        src=\"/static/a42842e89e1cd2af20d2c4bb144daec9/f058b/20210102152616.png\"\n        srcset=\"/static/a42842e89e1cd2af20d2c4bb144daec9/c26ae/20210102152616.png 158w,\n/static/a42842e89e1cd2af20d2c4bb144daec9/6bdcf/20210102152616.png 315w,\n/static/a42842e89e1cd2af20d2c4bb144daec9/f058b/20210102152616.png 630w,\n/static/a42842e89e1cd2af20d2c4bb144daec9/8ce52/20210102152616.png 681w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>:::tip 注意</p>\n<p>stack 中的每一层都是通过 <strong>Layer</strong> 对象来封装的，layer 对象中的 handle 成员变量才是真正的中间件函数。\r\n:::</p>\n<p>一旦有请求进来，那么会如此调用：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f381ceae5847006975cf7680bccea93a/a0b80/20210102153824.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.08860759493672%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABj0lEQVQoz22SjY6jIBSFfZxaLhdQ4FrAUtH6M2Zm0mbf/1k24m7XbeZLTCC5J+dwrgVmeCYfAIAxtn2IKKUUQgCAlNJ737atc45lELE4ijnnUso6U1UVEd3v93EabzHe7/eU0jzPMUattbUWAAqevV5iIlqWZV3Xvu/btr1er9ZaIuu971I3z3NKyWY458WuhExZllrrruv6oQ8hWGuVUufz+XQ6CSFSStM0OefquiYixlhRVZUx1hpDRDFG59wwDMuyeO+JSGuNiETkvb91mzjebs3FKaW22MaYLV28Ou+apvHep5TGcQw+NE1T17UQYlmW5/P5tY7P5+PX9+fjY7TG/HvzHv58ZlrraZrWdY0xZucaABBRCIF8axgBkJWcA0cs+AEAIGq+vz4fj0cIm7PW+lUnAN+PkLeDnP/XtpSSMnvgfZ+vATiwX4u//8aGMVt3SqmyLI/7O84cr9uqqqqy1kopjf2DUupN8LOYMZYLbxExhDDP0zD0l4t7BT7mfI+9ldQ0IYS30R+t3px/A4eknIl6hjLOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"20210102153824\"\n        title=\"20210102153824\"\n        src=\"/static/f381ceae5847006975cf7680bccea93a/f058b/20210102153824.png\"\n        srcset=\"/static/f381ceae5847006975cf7680bccea93a/c26ae/20210102153824.png 158w,\n/static/f381ceae5847006975cf7680bccea93a/6bdcf/20210102153824.png 315w,\n/static/f381ceae5847006975cf7680bccea93a/f058b/20210102153824.png 630w,\n/static/f381ceae5847006975cf7680bccea93a/40601/20210102153824.png 945w,\n/static/f381ceae5847006975cf7680bccea93a/a0b80/20210102153824.png 955w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>再看下面的代码，结合上述内容，如果访问 <code class=\"language-text\">home</code> 接口，会输出什么？</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after m1 next\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 02 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after m2 next\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token string\">\"/home\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 01\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after m3 next\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 02\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after m4 next\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"home and get method middleware 03\"</span><span class=\"token punctuation\">)</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"your project is running successfully!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>输出结果如下，具体的分析过程不再赘述：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your project is running successfully!\r\nmiddleware 01 in app.use\r\nmiddleware 02 in app.use\r\nhome and get method middleware 01\r\nhome and get method middleware 02\r\nhome and get method middleware 03\r\nafter m4 next\r\nafter m3 next\r\nafter m2 next\r\nafter m1 next</code></pre></div>\n<h2>Koa</h2>\n<p>相比 express，<strong>koa</strong> 是一个<strong>更加轻量级的框架</strong>。express 和 Koa 的核心都是<strong>中间件</strong>，但是他们的执行机制略有不同。</p>\n<h3>中间件的注册与执行</h3>\n<p>下面的代码启动了一个 koa 服务器：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Koa <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"koa\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Koa</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware in app.use\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"success!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>和 express 不同，这里 new 的 Koa 是一个类，所有的核心方法都包含在这里面，我们先看它的构造函数的实现：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">options</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    options <span class=\"token operator\">=</span> options <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>proxy <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>proxy <span class=\"token operator\">||</span> <span class=\"token boolean\">false</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>subdomainOffset <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>subdomainOffset <span class=\"token operator\">||</span> <span class=\"token number\">2</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>proxyIpHeader <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>proxyIpHeader <span class=\"token operator\">||</span> <span class=\"token string\">\"X-Forwarded-For\"</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>maxIpsCount <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>maxIpsCount <span class=\"token operator\">||</span> <span class=\"token number\">0</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>env <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>env <span class=\"token operator\">||</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"development\"</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>keys <span class=\"token operator\">=</span> options<span class=\"token punctuation\">.</span>keys\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>request <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>response <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>util<span class=\"token punctuation\">.</span>inspect<span class=\"token punctuation\">.</span>custom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">[</span>util<span class=\"token punctuation\">.</span>inspect<span class=\"token punctuation\">.</span>custom<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>inspect\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>大部分都是一些参数的初始化，例如环境变量、代理配置，从 <code class=\"language-text\">this.middleware = []</code> 开始，我们看到了一些熟悉的内容：</p>\n<ul>\n<li>中间件 <code class=\"language-text\">middleware</code>（可得知所有的中间件最终会被存放到这个数组中）</li>\n<li>context、request、response 对象，其中 context 是我们中间件的第一个参数。</li>\n</ul>\n<p>现在我们还不清楚它们在何时会被用上。在实例化 Koa 对象之后，我们执行了 <code class=\"language-text\">app.use()</code>，来看它的源码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware must be a function!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isGeneratorFunction</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">deprecate</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token string\">\"Support for generators will be removed in v3. \"</span> <span class=\"token operator\">+</span>\r\n          <span class=\"token string\">\"See the documentation for examples of how to convert old middleware \"</span> <span class=\"token operator\">+</span>\r\n          <span class=\"token string\">\"https://github.com/koajs/koa/blob/master/docs/migration.md\"</span>\r\n      <span class=\"token punctuation\">)</span>\r\n      fn <span class=\"token operator\">=</span> <span class=\"token function\">convert</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use %s\"</span><span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">.</span>_name <span class=\"token operator\">||</span> fn<span class=\"token punctuation\">.</span>name <span class=\"token operator\">||</span> <span class=\"token string\">\"-\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>use 的代码非常简单，其最终就是把你传入的中间件 push 到前面提到的 <code class=\"language-text\">middleware</code> 数组。</p>\n<p>相比 express 对中间件的初始化方式（用 Layer 封装、特殊的路由中间件），koa 的处理更为简单粗暴。</p>\n<p>服务器的启动依靠 <code class=\"language-text\">listen()</code> 方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">debug</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listen\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> server <span class=\"token operator\">=</span> http<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> server<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>和 express 如出一辙，都是调用了 http 库的 <code class=\"language-text\">createServer()</code>，并传入相应的回调函数 — 这个回调函数会在用户发送请求时执行。</p>\n<p>值得注意的是，这里的回调函数是 <code class=\"language-text\">this.callback()</code> 的<strong>返回值</strong>，也就是下面的 <code class=\"language-text\">handleRequest()</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> fn <span class=\"token operator\">=</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>middleware<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">listenerCount</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onerror<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleRequest</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> fn<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> handleRequest\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>用户发送请求，<code class=\"language-text\">handleRequest()</code> 被执行，首先调用 <code class=\"language-text\">createContext()</code> 初始化上下文对象（context），也就是中间件函数的第一个参数，例如把 http 模块的 res、req 对象绑定到 context 对象上。</p>\n<p>最终执行核心方法 <code class=\"language-text\">this.handleRequest()</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Application</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Emitter</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">handleRequest</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> fnMiddleware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> ctx<span class=\"token punctuation\">.</span>res\r\n    res<span class=\"token punctuation\">.</span>statusCode <span class=\"token operator\">=</span> <span class=\"token number\">404</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> ctx<span class=\"token punctuation\">.</span><span class=\"token function\">onerror</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResponse</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">respond</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">onFinished</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">,</span> onerror<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">fnMiddleware</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>handleResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>onerror<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>第一个参数是 context，第二个参数是 <code class=\"language-text\">fnMiddleware</code>，在上面提到的 <code class=\"language-text\">callback()</code> 函数中可以看出，它是在 <code class=\"language-text\">callback()</code> 执行时，通过对 <code class=\"language-text\">this.middleware</code>执行 <code class=\"language-text\">compose()</code> 得到的。</p>\n<p>所以关键就是这里的 <code class=\"language-text\">compose()</code> 方法了，它来自单独的一个库，叫做 <code class=\"language-text\">koa-compose</code>：</p>\n<ul>\n<li>这个函数要求传入 middleware 数组。</li>\n<li>首先是数组的判断、以及每个成员是不是函数的判断。</li>\n<li>然后返回一个函数，这个会在上面 <code class=\"language-text\">handleRequest()</code> 中被执行。</li>\n<li>这个函数又返回一个函数 <code class=\"language-text\">dispatch(0)</code>，不难看出这里的 0 表示下标。</li>\n<li>dispatch 函数会通过 <code class=\"language-text\">let fn = middleware[i]</code> 得到某个中间件。</li>\n<li>接着调用 <code class=\"language-text\">fn(context, dispatch.bind(null, i + 1))</code>，fn 是中间件函数，context 是上下文，<code class=\"language-text\">dispatch.bind(null, i + 1))</code> 就是 第二个参数 next 了。</li>\n<li>很明显，这是一个递归调用，它会一直去调用每一个中间件，直到遍历并执行完所有的中间件，退出递归。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">compose</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">middleware</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>middleware<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Middleware stack must be an array!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> fn <span class=\"token keyword\">of</span> middleware<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> fn <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Middleware must be composed of functions!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">&lt;=</span> index<span class=\"token punctuation\">)</span>\r\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"next() called multiple times\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n      index <span class=\"token operator\">=</span> i\r\n      <span class=\"token keyword\">let</span> fn <span class=\"token operator\">=</span> middleware<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">===</span> middleware<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> fn <span class=\"token operator\">=</span> next\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fn<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 这里使用了Promise进行包装</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看出，Koa 执行中间件的流程也非常简单，请看下面的代码，试推测出它的输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Koa <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"koa\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Koa</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01 in app.use after next\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 02 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 02 in app.use after next\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 03 in app.use\"</span><span class=\"token punctuation\">)</span>\r\n  ctx<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">\"hi~\"</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"success!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">success!\r\nmiddleware 01 in app.use\r\nmiddleware 02 in app.use\r\nmiddleware 03 in app.use\r\nmiddleware 02 in app.use after next\r\nmiddleware 01 in app.use after next</code></pre></div>\n<h3>PART 3 总结</h3>\n<p>Koa 作为一个轻量级框架，其底层逻辑也非常的清晰易懂：</p>\n<p>对于中间件的注册，只是将中间件函数放入 Koa 类的 middleware 数组中，并没有像 express 那样用层封装、进行路由的区分。</p>\n<p>对于中间件的执行，和 express 有异曲同工之妙，只不过每次请求初始化中间件时，它是将中间件数组的每个中间件 <strong>compose</strong> 了（可以理解为<strong>组合</strong>），组合的方式是通过递归 —\r\n将触发下一个中间件的函数用 <code class=\"language-text\">dispatch.bind()</code> 封装，作为上一个中间件函数的第二个参数。</p>\n<h2>express 和 Koa 对比</h2>\n<p>express 和 Koa 的共同之处在于核心都是<strong>中间件</strong>，那么又有什么区别？各有什么优势？下面我们来探究一下。</p>\n<h3>Koa 更加轻量级</h3>\n<p>从上面的源码分析中不难看出，express 是一个比较全面的 web 框架，内置了参数解析、路由匹配等功能。</p>\n<p>而 Koa 则是一个<strong>轻量级的框架</strong>，短小精悍，所有的额外功能都要通过第三方的库进行扩展。</p>\n<p>他们类似于 Python Web 开发中的 Django 和 flask。</p>\n<h3>针对异步代码</h3>\n<p>express 框架在处理某些异步操作时略有些捉襟见肘，来看下面的代码，这两份代码都使用了类似的异步中间件：</p>\n<p><strong>express</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"express\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">myPromise</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\r\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise resolved!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after middleware 01 next\"</span><span class=\"token punctuation\">)</span>\r\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello~\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> timeRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">myPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>timeRes<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listening!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>koa</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Koa <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"koa\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Koa</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">myPromise</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\r\n  <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise resolved!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"middleware 01\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">await</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after middleware 01 next\"</span><span class=\"token punctuation\">)</span>\r\n  ctx<span class=\"token punctuation\">.</span>body <span class=\"token operator\">=</span> <span class=\"token string\">\"hello~\"</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">ctx<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> timeRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">myPromise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>timeRes<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"listening!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>在 express 的代码中，我们得到输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">middleware 01\r\nafter middleware 01 next\r\npromise resolved!</code></pre></div>\n<p>在 Koa 的代码中，我们得到输出，并且响应会有约两秒的延迟：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">middleware 01\r\npromise resolved!\r\nafter middleware 01 next</code></pre></div>\n<p>我们想达成这样一个目的 — 在第一个中间件中利用 <strong>await</strong> 来等待下一个异步中间件函数（它使用 await 执行了一个 <code class=\"language-text\">setTimeout()</code> 并打印结果）执行完成，但是只有 Koa 的版本能实现需求。</p>\n<p>为什么？本质就在于 await 关键词的特性 — await 关键字期待（但实际上并不要求）一个实现 thenable 接口的对象，但常规的值也可以。如果是实现 thenable 接口的对象，则这个对象可以由 await 来“解包”。如果不是，则这个值就被当作已经 <strong>resolved 的 Promise</strong>。</p>\n<p>那么问题就成了 express 中间件参数的 next 是一个异步函数吗？答案为不是异步函数。你可能会问，我不是给 await 后面的 next 加了 async 了吗？实际上，express 对原本的 next 还做了一层封装，此部分的代码前面已经讲了：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Layer</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">handle_request</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">handle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> fn <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handle\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上面 <code class=\"language-text\">try</code> 块中包裹的 <code class=\"language-text\">fn</code> 就是我们真正的中间件函数 — 但是我们 await 后面跟着的 next 并不是它,而是封装它的同步函数。</p>\n<p>而对于 koa 的实现（只保留主干部分），其 next 函数如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">context<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">function</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">i</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> fn <span class=\"token operator\">=</span> middleware<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> <span class=\"token function\">dispatch</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>fn 是我们的中间件函数，它执行的结果是一个 promise，而 <code class=\"language-text\">Promise.resolve()</code> 是幂等的，next() 的返回值本质上就是我们的中间件函数，这就解释了为什么 <code class=\"language-text\">await next()</code> 是有效的。</p>\n<p>:::tip Promise.resolve() 的幂等性</p>\n<p>所谓 <code class=\"language-text\">Promise.resolve()</code> 的幂等性，就是说如果传入的值本身是一个 promise，其行为相当于一个空包装，即：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> p <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> p <span class=\"token operator\">===</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token comment\">// true</span>\r\n<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>console<span class=\"token punctuation\">.</span>log<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> p <span class=\"token operator\">===</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token comment\">// true</span></code></pre></div>\n<p>:::</p>\n<h2>参考资料</h2>\n<p>expressjs，<a href=\"https://github.com/expressjs/express\">express 代码仓库</a></p>\n<p>koa，<a href=\"https://github.com/koajs/koa\">koa 代码仓库</a></p>","frontmatter":{"title":"express & koa 框架对比及原理分析","date":"November 26, 2021","description":"node"},"timeToRead":22},"previous":{"fields":{"slug":"/2021-11/es6/"},"frontmatter":{"title":"一些有趣的es6案例分析"}},"next":{"fields":{"slug":"/2021-11/better-perfermance-react/"},"frontmatter":{"title":"谈谈React的性能优化"}}},"pageContext":{"id":"9c468c35-f83c-5e49-9b6e-44c54264790f","previousPostId":"db5bd321-d9ea-5b99-983c-5733163a37d5","nextPostId":"3be17587-aac5-561c-a5ea-fdf60486e1bf"}},"staticQueryHashes":["2841359383","3415673938"]}