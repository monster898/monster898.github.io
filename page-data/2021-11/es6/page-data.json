{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11/es6/","result":{"data":{"site":{"siteMetadata":{"title":"好成的blog"}},"markdownRemark":{"id":"db5bd321-d9ea-5b99-983c-5733163a37d5","excerpt":"总述 本文收集了个人在平时学习中的一些有趣的 ES6 案例。 本文不定期更新，随着我的学习，这篇文章会不断地补充完善。 Symbol React 利用 Symbol 防止 XSS 攻击 我们都知道，React 元素是一个 : 如果你的服务器有允许用户存储任意 JSON…","html":"<h2>总述</h2>\n<p>本文收集了个人在平时学习中的一些有趣的 ES6 案例。</p>\n<p>本文不定期更新，随着我的学习，这篇文章会不断地补充完善。</p>\n<h2>Symbol</h2>\n<h3>React 利用 Symbol 防止 XSS 攻击</h3>\n<p>我们都知道，React 元素是一个 <code class=\"language-text\">plain object</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> el <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  type<span class=\"token operator\">:</span> <span class=\"token string\">\"marquee\"</span><span class=\"token punctuation\">,</span>\r\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    bgcolor<span class=\"token operator\">:</span> <span class=\"token string\">\"#ffa7c4\"</span><span class=\"token punctuation\">,</span>\r\n    children<span class=\"token operator\">:</span> <span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  key<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n  ref<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n  $$<span class=\"token keyword\">typeof</span><span class=\"token operator\">:</span> Symbol<span class=\"token punctuation\">.</span><span class=\"token function\">for</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"react.element\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如果你的服务器有允许用户存储任意 JSON 对象的漏洞，而前端需要一个字符串，这可能会发生一个问题：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 服务端允许用户存储 JSON</span>\r\n<span class=\"token keyword\">let</span> expectedTextButGotJSON <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  type<span class=\"token operator\">:</span> <span class=\"token string\">\"div\"</span><span class=\"token punctuation\">,</span>\r\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    dangerouslySetInnerHTML<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n      __html<span class=\"token operator\">:</span> <span class=\"token string\">\"dangerous InnerHTML\"</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token comment\">// ...</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">let</span> message <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> text<span class=\"token operator\">:</span> expectedTextButGotJSON <span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后在某段 JSX 中使用了它，攻击者就可以运行我们不期望的 html 代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// React 0.13 中有风险</span>\r\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>message<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>但是 React 在之后的版本中使用了 <code class=\"language-text\">Symbol</code> 标记 React 元素：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> el <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  type<span class=\"token operator\">:</span> <span class=\"token string\">\"marquee\"</span><span class=\"token punctuation\">,</span>\r\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    bgcolor<span class=\"token operator\">:</span> <span class=\"token string\">\"#ffa7c4\"</span><span class=\"token punctuation\">,</span>\r\n    children<span class=\"token operator\">:</span> <span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n  key<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n  ref<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\r\n  $$<span class=\"token keyword\">typeof</span><span class=\"token operator\">:</span> Symbol<span class=\"token punctuation\">.</span><span class=\"token function\">for</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"react.element\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>因为 JSON 不支持 <code class=\"language-text\">Symbol</code> 类型。所以即使服务器存在用 JSON 作为文本返回安全漏洞，JSON 里也不包含 <code class=\"language-text\">Symbol.for('react.element')</code>。React 会检测 <code class=\"language-text\">element.$$typeof</code>\r\n，如果元素丢失或者无效，会<strong>拒绝处理</strong>该元素。</p>\n<h3>vue-router-next 利用 Symbol 防止属性污染</h3>\n<p>vue-router 利用 <code class=\"language-text\">app.provide</code> 这个 API，将 <code class=\"language-text\">routerKey</code> 等全局对象挂载到全局 <code class=\"language-text\">vue</code> 实例上： 为了防止属性污染，<code class=\"language-text\">key</code> 值在这里被设置为一个 <code class=\"language-text\">Symbol</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// PolySymbol 返回一个合适的 Symbol 如果浏览器环境不支持，则直接返回一个字符串</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">PolySymbol</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\r\n  hasSymbol\r\n    <span class=\"token operator\">?</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>__DEV__ <span class=\"token operator\">?</span> <span class=\"token string\">\"[vue-router]: \"</span> <span class=\"token operator\">+</span> name <span class=\"token operator\">:</span> name<span class=\"token punctuation\">)</span>\r\n    <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>__DEV__ <span class=\"token operator\">?</span> <span class=\"token string\">\"[vue-router]: \"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"_vr_\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> name\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> routerKey <span class=\"token operator\">=</span> <span class=\"token comment\">/*#__PURE__*/</span> <span class=\"token function\">PolySymbol</span><span class=\"token punctuation\">(</span>\r\n  __DEV__ <span class=\"token operator\">?</span> <span class=\"token string\">\"router\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"r\"</span>\r\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> InjectionKey<span class=\"token operator\">&lt;</span>Router<span class=\"token operator\">></span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span>routerKey<span class=\"token punctuation\">,</span> router<span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span>routeLocationKey<span class=\"token punctuation\">,</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>reactiveRoute<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\napp<span class=\"token punctuation\">.</span><span class=\"token function\">provide</span><span class=\"token punctuation\">(</span>routerViewLocationKey<span class=\"token punctuation\">,</span> currentRoute<span class=\"token punctuation\">)</span></code></pre></div>\n<p>vue-router 的其他模块就可以通过 <code class=\"language-text\">routerKey</code> 优雅地拿到全局 <code class=\"language-text\">router</code> 对象，其中 <code class=\"language-text\">inject()</code> 方法是 <code class=\"language-text\">vue</code> 取得全局对象属性的 API。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function-variable function\">setup</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> link <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span><span class=\"token function\">useLink</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> options <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">inject</span><span class=\"token punctuation\">(</span>routerKey<span class=\"token punctuation\">)</span><span class=\"token operator\">!</span>\r\n  <span class=\"token comment\">// 省略其他内容</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Set 和 Map 数据结构</h2>\n<h3>优雅地实现数组/字符串去重</h3>\n<p>基于集合没有重复元素的特点，我们可以优雅地实现<strong>数组去重</strong>，来看下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> myArr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token keyword\">let</span> uniqueElementsArr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>myArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\r\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>uniqueElementsArr<span class=\"token punctuation\">)</span>\r\n<span class=\"token comment\">// [1, 2, 3, 5]</span></code></pre></div>\n<p>或是去除字符串里面的重复字符：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> myStr <span class=\"token operator\">=</span> <span class=\"token string\">\"hello world!\"</span>\r\n<span class=\"token keyword\">let</span> newStr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span>myStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\r\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>newStr<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token comment\">// \"helo wrd!\"</span></code></pre></div>\n<h3>利用 weakMap 防止内存泄露</h3>\n<p>来看下面的例子，下面的 <code class=\"language-text\">e1</code> 和 <code class=\"language-text\">e2</code> 是两个对象，我们通过 <code class=\"language-text\">arr</code> 数组对这两个对象添加一些文字说明。这就形成了 <code class=\"language-text\">arr</code> 对 <code class=\"language-text\">e1</code> 和 <code class=\"language-text\">e2</code> 的引用。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> e1 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> e2 <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\r\n  <span class=\"token punctuation\">[</span>e1<span class=\"token punctuation\">,</span> <span class=\"token string\">\"foo 元素\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">[</span>e2<span class=\"token punctuation\">,</span> <span class=\"token string\">\"bar 元素\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>如果我们不需要 <code class=\"language-text\">e1</code> 和 <code class=\"language-text\">e2</code>，就必须手动解除引用，此类代码很容易被开发者遗忘：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">arr<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\r\narr<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>使用 <code class=\"language-text\">weakmap</code> 就可以规避这种麻烦：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> wm <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">WeakMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"example\"</span><span class=\"token punctuation\">)</span>\r\nwm<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> <span class=\"token string\">\"some information\"</span><span class=\"token punctuation\">)</span>\r\nwm<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span></code></pre></div>\n<p>原生的 WeakMap 持有的是每个键对象的“弱引用”，这意味着在没有其他引用存在时垃圾回收能正确进行。\r\n即当 weakmap 中的键没有任何指向它的引用时，会自动进行垃圾回收，删除该对键值。</p>\n<h2>Proxy 和 Reflect</h2>\n<h3>vue3.0 利用 Proxy+Reflect 实现数据劫持</h3>\n<p>我们都知道 vue2 的数据劫持是 <code class=\"language-text\">defineProperty</code>，<code class=\"language-text\">defineProperty</code> 有一些缺点，例如一次只能操作一个对象的一个属性，要监听整个对象需要多层的递归。</p>\n<p>另外，<code class=\"language-text\">Object.defineProperty()</code> 无法监听数组类型属性的变化，vue 使用了一些比较 hack 的方法来实现它，但是还有一些缺陷，例如通过下标修改数组的情况仍无法监测。</p>\n<p>Proxy 非常优雅地解决了这些问题，我们以 vue3 的 <code class=\"language-text\">reactive()</code> API 为例了解一下，来看看官方这个 test：</p>\n<p>:::tip</p>\n<ul>\n<li>\n<p>下面的代码只列出主干部分的代码，更多细节可自行阅读源码。我们主要的目的是了解 Proxy 和 Reflect 的特性。</p>\n</li>\n<li>\n<p>响应式 API 的源码位于 <code class=\"language-text\">vue-next/packages/reactivity</code> 下。</p>\n</li>\n</ul>\n<p>:::</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"original value change should reflect in observed value (Object)\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> original<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> foo<span class=\"token operator\">:</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">const</span> observed <span class=\"token operator\">=</span> <span class=\"token function\">reactive</span><span class=\"token punctuation\">(</span>original<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// set</span>\r\n  original<span class=\"token punctuation\">.</span>bar <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\r\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>original<span class=\"token punctuation\">.</span>bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>observed<span class=\"token punctuation\">.</span>bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// delete</span>\r\n  <span class=\"token keyword\">delete</span> original<span class=\"token punctuation\">.</span>foo\r\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span> <span class=\"token keyword\">in</span> original<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo\"</span> <span class=\"token keyword\">in</span> observed<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>首先调用 <code class=\"language-text\">reactive()</code>，将 <code class=\"language-text\">original</code> 响应化。</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// if trying to observe a readonly proxy, return the readonly version.</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> Target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>ReactiveFlags<span class=\"token punctuation\">.</span><span class=\"token constant\">IS_READONLY</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> target\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">return</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\r\n  target<span class=\"token punctuation\">,</span>\r\n  <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\r\n  mutableHandlers<span class=\"token punctuation\">,</span>\r\n  mutableCollectionHandlers\r\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这是核心方法，创建一个响应式对象，它最终返回一个 <code class=\"language-text\">proxy</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createReactiveObject</span><span class=\"token punctuation\">(</span>\r\n  target<span class=\"token operator\">:</span> Target<span class=\"token punctuation\">,</span>\r\n  isReadonly<span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span><span class=\"token punctuation\">,</span>\r\n  baseHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  collectionHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span>\r\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 其它的代码省略</span>\r\n  <span class=\"token comment\">// 核心部分</span>\r\n  <span class=\"token keyword\">const</span> proxy <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Proxy</span><span class=\"token punctuation\">(</span>\r\n    target<span class=\"token punctuation\">,</span>\r\n    targetType <span class=\"token operator\">===</span> TargetType<span class=\"token punctuation\">.</span><span class=\"token constant\">COLLECTION</span> <span class=\"token operator\">?</span> collectionHandlers <span class=\"token operator\">:</span> baseHandlers\r\n  <span class=\"token punctuation\">)</span>\r\n  proxyMap<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> proxy<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> proxy\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里 new 了一个 <code class=\"language-text\">Proxy</code>，第一个参数传入的是要被代理的对象，第二个参数是一个对象， 对于每一个被代理的操作，需要提供一个对应的处理函数，该函数将拦截对应的操作，在这里是 <code class=\"language-text\">baseHandlers</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> mutableHandlers<span class=\"token operator\">:</span> ProxyHandler<span class=\"token operator\">&lt;</span>object<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n  get<span class=\"token punctuation\">,</span>\r\n  set<span class=\"token punctuation\">,</span>\r\n  deleteProperty<span class=\"token punctuation\">,</span>\r\n  has<span class=\"token punctuation\">,</span>\r\n  ownKeys<span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>可以看出这里重定义了 <code class=\"language-text\">get</code>、<code class=\"language-text\">set</code> 等方法，<code class=\"language-text\">get</code> 方法实际上调用了 <code class=\"language-text\">createGetter</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createGetter</span><span class=\"token punctuation\">(</span>isReadonly <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 省略一些细节代码</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token operator\">:</span> Target<span class=\"token punctuation\">,</span> key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">symbol</span><span class=\"token punctuation\">,</span> receiver<span class=\"token operator\">:</span> object<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 使用 Reflect.get 来调用系统内部(默认)的 get 方法</span>\r\n    <span class=\"token keyword\">const</span> res <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> res\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>注意这里的 <code class=\"language-text\">Reflect.get()</code> 这个 API 称为<strong>反射</strong>，Proxy 对象的方法，就能在 Reflect 对象上找到对应的方法。这就让 Proxy 对象可以方便地调用对应的 Reflect 方法，完成<strong>默认行为</strong>。</p>\n<p>Reflect 的意义在于<strong>保证原生行为能够正常执行</strong>。</p>\n<p>再看 <code class=\"language-text\">set</code>，它本质上是调用 <code class=\"language-text\">createSetter()</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createSetter</span><span class=\"token punctuation\">(</span>shallow <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">set</span><span class=\"token punctuation\">(</span>\r\n    target<span class=\"token operator\">:</span> object<span class=\"token punctuation\">,</span>\r\n    key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> <span class=\"token builtin\">symbol</span><span class=\"token punctuation\">,</span>\r\n    value<span class=\"token operator\">:</span> <span class=\"token builtin\">unknown</span><span class=\"token punctuation\">,</span>\r\n    receiver<span class=\"token operator\">:</span> object\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> oldValue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\r\n    <span class=\"token comment\">// 调用默认的 set 方法</span>\r\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> Reflect<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> receiver<span class=\"token punctuation\">)</span>\r\n    <span class=\"token comment\">// 调用 `trigger()` 通知 订阅者更新</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>target <span class=\"token operator\">===</span> <span class=\"token function\">toRaw</span><span class=\"token punctuation\">(</span>receiver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">trigger</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">,</span> TriggerOpTypes<span class=\"token punctuation\">.</span><span class=\"token constant\">SET</span><span class=\"token punctuation\">,</span> key<span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">,</span> oldValue<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">return</span> result\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我们在 <code class=\"language-text\">set</code> 方法中执行劫持 — 首先我们调用 <code class=\"language-text\">Reflect.set</code>，也就是 <code class=\"language-text\">set</code> 方法的<strong>默认行为</strong>，接着补充额外的逻辑，例如通知订阅者的 <code class=\"language-text\">trigger()</code>。</p>\n<p>也就是当用户修改值，例如调用 <code class=\"language-text\">original.bar = 1</code> 时代码就会走到这个函数里，我们只需在这里实现我们的通知发布即可，具体的发布实现这里不展开，以后我会专门开一篇详细分析。</p>\n<h2>Iterator 和 Generator</h2>\n<p>下图很好地说明了两者之间的关系。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/95b4076d30e55da078045cdade28cea3/11a8f/relationships.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSklEQVQoz5WRzUoDMRSF5/Hc+Sg+jYjgRh9AXAmCCxGluq7Wttqf6fwknaQ2U2Zyk9zkRsYuLFIXnuUHh3PuPcksS8fzibE2/l/J+na8Onl25NFhmmcFL0MIMUbvfZ7nnLMYIxHtN6tRKR/etdZMieq0t77sb1DLSiilXgeDdLEAgLIstdZKKSEEAPyY2zfe3E9bo6X6FE8fzZBrZ6SURJSmaVVV3vumaQDAWAsA217bJgm76c+P72zAXWqtreuacyal2PJd0fcZFGNSLNmsSL33HQ1EobMjojGGMdY0rbWubVtEdM75EADAWofoumS0aMFQ/PUSwhDr+dGGnYmVKYtMrFaHc3WdLzVnvZwfTNdlq5O/ZkAfp8OrbPboHBF1gecvoyGvYvALIS+GE1HXSdd/3xIheG08GL/dKYRAoAM6inHJWF3kS86+AP/HAUjdbrRFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"relationships\"\n        title=\"relationships\"\n        src=\"/static/95b4076d30e55da078045cdade28cea3/f058b/relationships.png\"\n        srcset=\"/static/95b4076d30e55da078045cdade28cea3/c26ae/relationships.png 158w,\n/static/95b4076d30e55da078045cdade28cea3/6bdcf/relationships.png 315w,\n/static/95b4076d30e55da078045cdade28cea3/f058b/relationships.png 630w,\n/static/95b4076d30e55da078045cdade28cea3/40601/relationships.png 945w,\n/static/95b4076d30e55da078045cdade28cea3/78612/relationships.png 1260w,\n/static/95b4076d30e55da078045cdade28cea3/11a8f/relationships.png 1272w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>利用 Generator 让异步代码更加优雅</h3>\n<p>我们都知道，异步代码可以用 <code class=\"language-text\">Promise</code> 来处理，能够有效地解决<strong>回调地狱</strong>问题：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 读取文件 A</span>\r\n<span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>fileA<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 获取 A 内容</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 读取 B</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>fileB<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 获取 B 内容</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">Promise</code> 挺不错，但是也有一些问题，例如大量冗余的代码 — 跟着一大堆 <code class=\"language-text\">then</code>，异步逻辑一多，代码会非常难以维护。</p>\n<p>我们可能会期望这样的代码，在 <code class=\"language-text\">console.log(result)</code> 中拿到结果”hello world”：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 利用 setTimeout 模拟网络请求</span>\r\n  <span class=\"token keyword\">const</span> res1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token keyword\">const</span> res2 <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sam!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">// 这里是无法拿到 hello world 的</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token comment\">// 这里是无法拿到 sam 的</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>显然直接这样是不行的，于是我们可以利用生成器函数：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hi~\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 利用 setTimeout 模拟网络请求</span>\r\n  <span class=\"token keyword\">const</span> res1 <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hello world!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> res2 <span class=\"token operator\">=</span> <span class=\"token keyword\">yield</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sam!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 这里是无法拿到 hello world 的</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res1<span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 这里是无法拿到 sam 的</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res2<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>如何执行这部分代码？我们只需要这样做：</p>\n<ul>\n<li>初始化生成器</li>\n<li>通过 <code class=\"language-text\">it1.next().value</code> 拿到第一个 <code class=\"language-text\">yield</code> 后面的内容，也就是第一个 <code class=\"language-text\">Promise</code> 对象。</li>\n<li>在调用 <code class=\"language-text\">Promise.then()</code>，在回调函数中拿到结果 <code class=\"language-text\">res</code>.</li>\n<li>在回调函数中调用 <code class=\"language-text\">iterator.next(res)</code>, next 函数的参数即为上一个 <code class=\"language-text\">yield</code> 表达式的返回值，则 <code class=\"language-text\">res</code> 为 <code class=\"language-text\">hello world!</code>。</li>\n<li>以此类推处理第二个 <code class=\"language-text\">yield</code>。</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> iterator <span class=\"token operator\">=</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">let</span> it1 <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\nit1<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> it2 <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  it2<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>看看效果：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/e9140/Snipaste_2021-11-18_10-51-37.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 107.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAABJNAAASTQHzl8SnAAACKklEQVQ4y42UZ24cMQyF5zLxjDoliqLalN0dpwD+lfsfJpjduCReJwY+QBCkRz5SZTA+AxLxVtoZafW4QNqQVq4nH6sLs4sdYjdQvgj/IMONScdJx0FBVpYRT5wWH5dEjynsrfyotec823QxvAOdwHdpk7R8Q9gkbBqAuoGscIb1Cfefcd6pbuX8zXG12J53v8reMlwH8mkj6syzsCRslDZKR9LSzd4z+Bc3cbKhThqFxlG9EEf1VhDfMwibpEkASwzVhhrChm6juHLOiaumTdHJ4WJdeR9i0EfDSPkG/bvfnmK/EK8eZ2mjOkpgcbUmDN3JrIGVO2zr0CU0BUkFEoY+ZftWs/b1QeIo4XqM97feE7uj28yZOdu8U1zQl+meyfuZlU2l1JqLK185LhTqp8UuK8eTjuLKpGnSJD5pW9hkbQ1Q2Wdjk4ybwT7qOGqcVPh/zcZVcAUdE2Tj2DlmYOmqwkXa9PDPzIxQZ1xWbFvsc6iYzq1cWuyUd4+L+eCQXzJzDeuK7Rz7FkrEnvPjQnPKe6JTxa4hjx+JJxM5lDO2HBfP+4wt5ouCEhwpw5Ph8cO7bZKG4kLTOh72bJYmanOsjf/ttsPmaUZeFDDEZoBtKApYmCPWb+zxPOXL9Fg6GGx+1Gn3ZYWUHRXgEkoDLo6zL8Wl7DjT2vgy58viaxX2TebAm4vdxS4tjQqPkPYa+HhSrxx/w7vvYUj1bHzRkMXHV/IoXl35s+ZfLtX70PzJKOAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Snipaste 2021 11 18 10 51 37\"\n        title=\"Snipaste 2021 11 18 10 51 37\"\n        src=\"/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/f058b/Snipaste_2021-11-18_10-51-37.png\"\n        srcset=\"/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/c26ae/Snipaste_2021-11-18_10-51-37.png 158w,\n/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/6bdcf/Snipaste_2021-11-18_10-51-37.png 315w,\n/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/f058b/Snipaste_2021-11-18_10-51-37.png 630w,\n/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/40601/Snipaste_2021-11-18_10-51-37.png 945w,\n/static/1ef6b03bc0fc8e9d1e91cd44c1b0bf0a/e9140/Snipaste_2021-11-18_10-51-37.png 1226w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">function* bar()</code> 中的内容算是比较优雅了（看着更像同步操作），但是依然有很大的问题：</p>\n<ul>\n<li>但是那坨分离出来的代码如何解决，也就是说，如何<strong>自动执行 Generator 函数</strong>？</li>\n<li>上面的代码只适用于 2 个 <code class=\"language-text\">Promise</code> 如果有很多的 <code class=\"language-text\">promise</code>，如何解决？</li>\n</ul>\n<p>来看下面的 <code class=\"language-text\">generatorRunner()</code>，它可以自动执行 Generator 函数，同时使用递归地方式处理多个 <code class=\"language-text\">Promise</code>：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">generatorRunner</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">fn</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> iterator <span class=\"token operator\">=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">res <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> result <span class=\"token operator\">=</span> iterator<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    result<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token function\">generatorRunner</span><span class=\"token punctuation\">(</span>bar<span class=\"token punctuation\">)</span></code></pre></div>\n<p>看看效果：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4160666379dc29dbe8d5bafd66a8e84b/d4b10/Snipaste_2021-11-18_10-53-48.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.24050632911393%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAABJNAAASTQHzl8SnAAABpklEQVQ4y5WS2Y7bMAxF8zFtbEsiKYkStXnJMjOY//+igR20k6RJmwLnwTB0fGle7YxNNoiLow9NQdgr12nfab9XvlO+07zhN7g34Ted5t0A0djs48HXN1/ffTm7dJBy5Dj7dEBuTmYKo7GFwuji5GQ2Nl8+tMlYUniv7aOVN6yfmM9ACagoTL0JA8RrrsNXuYeItoZ80q4MxiuIgAEoKBAFcn36jt0AMkAM7jTKR5Wl8rjIVNMUy7mESdvcG34qK5QB44Ap81FcwzVWfij+qbl7nnmTDJQsZvJJ2axsQxKgfPeHD5PTAIK2cDq3PPk4addoW9i/5TUZBVwdMHU6XFrdvzDzlgyiKZmwGFd6zb3m/gXte2HaVuVGZdtGVSivygPEVfCL5kXzrHlW9Ld67uUBwnpa83+PbVxBX51MsD2Ay+jLzZXEqDa2jFsZ5KTDycQROEFIlApJtinbXDBmV4ocxnyeeGrK3je38zITN+LWm/irqvAH68sHYztZwFVN2yVd55TLFlYw9hC+eVAVHzRPFDNJJq5sj+SLtZF8olwUxV4/XdgXf57JqyVDjPcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Snipaste 2021 11 18 10 53 48\"\n        title=\"Snipaste 2021 11 18 10 53 48\"\n        src=\"/static/4160666379dc29dbe8d5bafd66a8e84b/f058b/Snipaste_2021-11-18_10-53-48.png\"\n        srcset=\"/static/4160666379dc29dbe8d5bafd66a8e84b/c26ae/Snipaste_2021-11-18_10-53-48.png 158w,\n/static/4160666379dc29dbe8d5bafd66a8e84b/6bdcf/Snipaste_2021-11-18_10-53-48.png 315w,\n/static/4160666379dc29dbe8d5bafd66a8e84b/f058b/Snipaste_2021-11-18_10-53-48.png 630w,\n/static/4160666379dc29dbe8d5bafd66a8e84b/40601/Snipaste_2021-11-18_10-53-48.png 945w,\n/static/4160666379dc29dbe8d5bafd66a8e84b/78612/Snipaste_2021-11-18_10-53-48.png 1260w,\n/static/4160666379dc29dbe8d5bafd66a8e84b/d4b10/Snipaste_2021-11-18_10-53-48.png 1394w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这种能够自动执行 <code class=\"language-text\">Generator</code> 的函数我们又称为<strong>Thunk 函数</strong>。当然，这是一个比较简单的版本，现在我们有类似的库，名为<strong>Co</strong>\r\n，<a href=\"https://github.com/tj/co/blob/master/index.js\">点击查看源码</a>。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">co</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">gen</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">var</span> ctx <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\r\n  <span class=\"token keyword\">var</span> args <span class=\"token operator\">=</span> <span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>arguments<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token comment\">// 使用 promise 包裹，目的是防止 promise 的死循环，最终导致内存泄漏</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 初始化生成器</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> gen <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> gen <span class=\"token operator\">=</span> <span class=\"token function\">gen</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span>\r\n    <span class=\"token comment\">// 不是函数，直接 resolve</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>gen <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> gen<span class=\"token punctuation\">.</span>next <span class=\"token operator\">!==</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>gen<span class=\"token punctuation\">)</span>\r\n    <span class=\"token comment\">// 执行 下面的 onFulfilled</span>\r\n    <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">onFulfilled</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> ret\r\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n        ret <span class=\"token operator\">=</span> gen<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token comment\">// 这里的 next 是下面出现的 next 函数</span>\r\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ret</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 如果 为 done 状态，我们直接 resolve</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\r\n      <span class=\"token comment\">// 将 value 转成 promise，目的是防止 promise 的死循环，最终导致内存泄漏</span>\r\n      <span class=\"token comment\">// toPromise 请自行查阅源码</span>\r\n      <span class=\"token keyword\">var</span> value <span class=\"token operator\">=</span> <span class=\"token function\">toPromise</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> ret<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span>\r\n      <span class=\"token comment\">// 将 onFulfilled 传给 `value.then` 这个新的 promise，这其实就是一个递归</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>value <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> value<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>onFulfilled<span class=\"token punctuation\">,</span> onRejected<span class=\"token punctuation\">)</span>\r\n      <span class=\"token comment\">// 出错，reject</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span>\r\n          <span class=\"token string\">\"You may only yield a function, promise, generator, array, or object, \"</span> <span class=\"token operator\">+</span>\r\n            <span class=\"token string\">'but the following object was passed: \"'</span> <span class=\"token operator\">+</span>\r\n            <span class=\"token function\">String</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\r\n            <span class=\"token string\">'\"'</span>\r\n        <span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">function</span> <span class=\"token function\">onRejected</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">var</span> ret\r\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n        ret <span class=\"token operator\">=</span> gen<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>ret<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>异步工具 — Promise、async 和 await</h2>\n<h3>实现 promise 的链式调用</h3>\n<p>你用过 vue-router 吗？如果你用过，你应该知道 vue-router 可以在某个守卫上注册多次，且这些守卫都会按你添加的顺序执行。</p>\n<p>实际上其底层就是 promise <strong>链式调用</strong>的一种体现，我们可以写一个类似的链式 Promise：</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// 链式的 Promise</span>\r\n<span class=\"token keyword\">const</span> promises <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Array</span></span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> index<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise \"</span> <span class=\"token operator\">+</span> index <span class=\"token operator\">+</span> <span class=\"token string\">\" resolved!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>promise<span class=\"token punctuation\">,</span> guard<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>res <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">guard</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\npromises<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span>reducer<span class=\"token punctuation\">,</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>运行结果如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/244a9aca62f7afd298798b4712414640/2f6f6/Snipaste_2021-11-18_11-50-43.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.13924050632912%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAIAAADUsmlHAAAACXBIWXMAABJNAAASTQHzl8SnAAAB5UlEQVQ4y5WSi24cIQxF52u6w9OAwTYwr93Zqo36//9TsZtUbVJVjXSFMHCwL2YyQCEttZ19v0o/ALeUN8w14QJld4E1sA7NuOIcOUcWqvY02zzbPF1M1o4bfl/q2duacIlpQWoxi8UlJA6pQ958oBQlRQm4aqCLSbPFSbmigHzaIhwJG3HT+VD55qgBiQLB2AKIjhWkO+o2iHKkPWvP02wxy5nprkJXcdHACcSDRKgOmoE6e1KelXuKHnoNp9lm64XTiXRK2TN2llNSa7h6EOXKF50uOl0MXgzO9g+Nsi+uhNj2uuV6p/Yt5tXnboKYwNoTpA7Ybaza8/OdfmkaBkAgrt53HRcTu/HkYtOebRAD5GIF7C5WAx/g2RVIlbn6xCZtFleNhwtcCo8rcHexzTa/lf0OtkW54qAYIOVFg8xetCcXigFWUM3D+TvsFTbAQ2EAFlj7YmH8gcvfTr+Hnx3zqdnANg6TNvDssnJZPYoa5x7hE1C/zSfgW1p/BNldKiZSYAEaClLHyBLkbYUrPHY1vLqYeLmv1xfkvdQb8v5oYP5PTYk2lAOwl3aLtP0/OWBZvy7HyNyPF2rnx378Cy71yss9lpX7HeX4XNlFrtzPkAeceJ8/lRnloHaGvJR2S8PzJ+CfCU7PHmo4Sa8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"promise\"\n        title=\"promise\"\n        src=\"/static/244a9aca62f7afd298798b4712414640/f058b/Snipaste_2021-11-18_11-50-43.png\"\n        srcset=\"/static/244a9aca62f7afd298798b4712414640/c26ae/Snipaste_2021-11-18_11-50-43.png 158w,\n/static/244a9aca62f7afd298798b4712414640/6bdcf/Snipaste_2021-11-18_11-50-43.png 315w,\n/static/244a9aca62f7afd298798b4712414640/f058b/Snipaste_2021-11-18_11-50-43.png 630w,\n/static/244a9aca62f7afd298798b4712414640/40601/Snipaste_2021-11-18_11-50-43.png 945w,\n/static/244a9aca62f7afd298798b4712414640/78612/Snipaste_2021-11-18_11-50-43.png 1260w,\n/static/244a9aca62f7afd298798b4712414640/2f6f6/Snipaste_2021-11-18_11-50-43.png 1377w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这里巧妙地利用了数组的 <code class=\"language-text\">reduce</code> API，通过一个 <strong>resolved Promise</strong> 作为初值，让<strong>后一个 promise</strong> 作为<strong>前一个 promise</strong> 的 then 回调的返回值。</p>\n<h3>Promise 的超时中断</h3>\n<p>用 promise 封装 ajax 请求，如果这个请求超时了，我们该如何优雅地中断？来看下面代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 本质上利用了闭包</span>\r\n<span class=\"token keyword\">let</span> cancelToken <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n<span class=\"token keyword\">const</span> myPromise <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> timeout <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise resolved!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token function-variable function\">cancelToken</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timeout<span class=\"token punctuation\">)</span>\r\n    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise rejected!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\nmyPromise\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">cancelToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>输出：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">promise rejected!</code></pre></div>\n<p><code class=\"language-text\">cancelToken</code> 在 Promise 中会成为一个函数，这个函数一旦执行，则调用 promise 中的 <strong>reject</strong> 方法。</p>\n<p>值得注意的是，不要忘记在 <code class=\"language-text\">cancelToken</code> 函数中将定时器清除掉，否则 reject 之后定时器还会继续执行。</p>\n<p>知名的网络请求库 <strong>axios</strong> 的<strong>网络请求中断</strong>功能就是通过这个方法实现的，只不过把这里的 <code class=\"language-text\">clearTimeout(timeout)</code> 换成 <code class=\"language-text\">XMLHttpRequest.abort()</code> 即可。</p>\n<h3>超时中断的另一种方案</h3>\n<p>上面说到利用 <code class=\"language-text\">cancelToken</code> 方法来进行超时中断，实际上我们还可以使用 <code class=\"language-text\">Promise.race(iterable)</code> 方法来实现。</p>\n<p>它的原理是传入多个 promise，一旦某个 promise 解决或拒绝，返回的 promise 就会解决或拒绝。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 中断方案2 基于 promise.race()</span>\r\n<span class=\"token keyword\">let</span> t <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">cancelablePromise</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">promise</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> p2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"超过 1s，中断 promise！\"</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>promise<span class=\"token punctuation\">,</span> p2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">const</span> myPromise2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  t <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise resolved!\"</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token function\">cancelablePromise</span><span class=\"token punctuation\">(</span>myPromise2<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">Promise.race()</code> 的实现很简单，返回一个 promise，一旦传入的多个 promise 中的某个 promise 解决或拒绝，返回的 promise 就会解决或拒绝：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isPromise</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">p</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> p <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span> p <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> p <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> p<span class=\"token punctuation\">.</span>then <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\r\n<span class=\"token punctuation\">}</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">race</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">promises</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">let</span> currentPromise <span class=\"token operator\">=</span> promises<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>currentPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        currentPromise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>currentPromise<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>实现 Promise.all()</h3>\n<p><code class=\"language-text\">promise.all()</code> 传入多个 promise，这些 promise 全部 resolved 才成功否则执行失败逻辑：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isPromise</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">p</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> p <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">&amp;&amp;</span> p <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> p <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> p<span class=\"token punctuation\">.</span>then <span class=\"token operator\">===</span> <span class=\"token string\">\"function\"</span>\r\n  <span class=\"token punctuation\">}</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\r\n<span class=\"token punctuation\">}</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">myAll</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">promises</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> res <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">processData</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">index<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      res<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> data\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> promises<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">let</span> currentPromise <span class=\"token operator\">=</span> promises<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isPromise</span><span class=\"token punctuation\">(</span>currentPromise<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        currentPromise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n          <span class=\"token function\">processData</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token function\">processData</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> currentPromise<span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">const</span> testPromises <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> index</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise \"</span> <span class=\"token operator\">+</span> index <span class=\"token operator\">+</span> <span class=\"token string\">\" resolved!\"</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>testPromises<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>让异步编程更简单的 async 和 await</h3>\n<p>使用 promise 处理异步已经比较优雅了，但是我们会发现有大量的 then 的代码块，不利于维护，代码也不好看：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">promise1</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise1 resolved!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">promise2</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise2 resolved!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">promise3</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"promise3 resolved!\"</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span>\r\n<span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">promise2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token function\">promise3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>使用 async / await 之后，它看起来更加优雅，更加像同步代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">foo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">let</span> res1 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res1<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">let</span> res2 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res2<span class=\"token punctuation\">)</span>\r\n  <span class=\"token keyword\">let</span> res3 <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res3<span class=\"token punctuation\">)</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>参考资料</h2>\n<p>Matt Frisble，JavaScript 高级程序设计（第四版）</p>\n<p>MDN，<a href=\"https://developer.mozilla.org/zh-CN/docs/learn/JavaScript/%E5%BC%82%E6%AD%A5/Async_await\">async 和 await:让异步编程更简单</a></p>\n<p>Dan Abramov，<a href=\"https://overreacted.io/why-do-react-elements-have-typeof-property/\">Why Do React Elements Have a $$typeof Property?</a></p>\n<p>Vincent Driessen，<a href=\"https://nvie.com/posts/iterators-vs-generators/\">Iterables vs. Iterators vs. Generators</a></p>","frontmatter":{"title":"一些有趣的es6案例分析","date":"November 10, 2021","description":"es6"},"timeToRead":14},"previous":{"fields":{"slug":"/2021-11/event-loop/"},"frontmatter":{"title":"分析浏览器和 NodeJS 的事件循环"}},"next":{"fields":{"slug":"/2021-11/express-and-koa/"},"frontmatter":{"title":"express & koa 框架对比及原理分析"}}},"pageContext":{"id":"db5bd321-d9ea-5b99-983c-5733163a37d5","previousPostId":"a7dff7dd-79d9-50d7-852a-c35ff1dbba40","nextPostId":"9c468c35-f83c-5e49-9b6e-44c54264790f"}},"staticQueryHashes":["2841359383","3415673938"]}